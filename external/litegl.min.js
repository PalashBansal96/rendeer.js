'use strict';(function(p){var l=p.GL={};p.requestAnimationFrame=p.requestAnimationFrame||p.mozRequestAnimationFrame||p.webkitRequestAnimationFrame||function(e){setTimeout(e,1E3/60)};l.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0};l.LEFT_MOUSE_BUTTON=1;l.RIGHT_MOUSE_BUTTON=3;l.MIDDLE_MOUSE_BUTTON=2;l.last_context_id=0;l.BYTE=5120;l.UNSIGNED_BYTE=5121;l.SHORT=5122;l.UNSIGNED_SHORT=5123;l.INT=5124;l.UNSIGNED_INT=5125;l.FLOAT=5126;l.ZERO=0;l.ONE=1;l.SRC_COLOR=768;l.ONE_MINUS_SRC_COLOR=769;l.SRC_ALPHA=
770;l.ONE_MINUS_SRC_ALPHA=771;l.DST_ALPHA=772;l.ONE_MINUS_DST_ALPHA=773;l.DST_COLOR=774;l.ONE_MINUS_DST_COLOR=775;l.SRC_ALPHA_SATURATE=776;l.CONSTANT_COLOR=32769;l.ONE_MINUS_CONSTANT_COLOR=32770;l.CONSTANT_ALPHA=32771;l.ONE_MINUS_CONSTANT_ALPHA=32772;p.DEG2RAD=0.0174532925;p.RAD2DEG=57.295779578552306;p.EPSILON=1E-6;p.isPowerOfTwo=function(e){return 0==Math.log(e)/Math.log(2)%1};p.getTime="undefined"!=typeof performance?performance.now.bind(performance):Date.now.bind(Date);p.isFunction=function(e){return!!(e&&
e.constructor&&e.call&&e.apply)};p.isArray=function(e){return e&&e.constructor===Array};p.isNumber=function(e){return null!=e&&e.constructor===Number};p.regexMap=function(e,f,a){for(var b;null!=(b=e.exec(f));)a(b)};p.createCanvas=function(e,f){var a=document.createElement("canvas");a.width=e;a.height=f;return a};p.cloneCanvas=function(e){var f=document.createElement("canvas");f.width=e.width;f.height=e.height;f.getContext("2d").drawImage(e,0,0);return f};String.prototype.replaceAll=function(e){var f=
this,a;for(a in e)f=f.split(a).join(e[a]);return f};Object.defineProperty(Array.prototype,"subarray",{value:Array.prototype.slice,enumerable:!1});p.wipeObject=function(e){for(var f in e)e.hasOwnProperty(f)&&delete e[f]};p.extendClass=function(e,f){for(var a in f)e.hasOwnProperty(a)||(e[a]=f[a]);if(f.prototype)for(a in f.prototype)f.prototype.hasOwnProperty(a)&&!e.prototype.hasOwnProperty(a)&&(f.prototype.__lookupGetter__(a)?e.prototype.__defineGetter__(a,f.prototype.__lookupGetter__(a)):e.prototype[a]=
f.prototype[a],f.prototype.__lookupSetter__(a)&&e.prototype.__defineSetter__(a,f.prototype.__lookupSetter__(a)))};p.HttpRequest=function(e,f,a,b,c){if(f){var d=null,d=[],g;for(g in f)d.push(g+"="+f[g]);d=d.join("&");e=e+"?"+d}var h=new XMLHttpRequest;h.open("GET",e,!c);h.onload=function(){200!=this.status?(LEvent.trigger(h,"fail",this.status),b&&b(this.status)):(LEvent.trigger(h,"done",this.response),a&&a(this.response))};h.onerror=function(a){LEvent.trigger(h,"fail",a)};h.send();return h};Object.defineProperty(XMLHttpRequest.prototype,
"done",{enumerable:!1,value:function(e){LEvent.bind(this,"done",function(f,a){e(a)});return this}});Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(e){LEvent.bind(this,"fail",function(f,a){e(a)});return this}});p.getFileExtension=function(e){var f=e.indexOf("?");-1!=f&&(e=e.substr(0,f));f=e.lastIndexOf(".");return-1==f?"":e.substr(f+1).toLowerCase()};p.loadFileAtlas=function(e,f,a){function b(a,b){function c(){var a=n.join("\n");f[m]=a;n.length=0;m=q.substr(1)}
var e=a.split("\n"),f={},n=[],m="",l;for(l in e){var q=e[l].trim();q.length&&("\\"==q[0]?m?c():m=q.substr(1):n.push(q))}m&&c();return f}var c=null;HttpRequest(e,null,function(a){a=b(a);f&&f(a);c&&c(a)},alert,a);return{done:function(a){c=a}}};var S=function(){function e(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function f(a,b,d,c){var e=new Uint16Array(4),f=new Uint16Array(d*c),g=0,h=0,k=0,s=h=g=0,m=0,n=0,r=0,l=d/4;c/=4;for(var q=0;q<c;q++)for(var t=
0;t<l;t++)k=b+4*(q*l+t),e[0]=a[k],e[1]=a[k+1],g=e[0]&31,h=e[0]&2016,s=e[0]&63488,m=e[1]&31,n=e[1]&2016,r=e[1]&63488,e[2]=5*g+3*m>>3|5*h+3*n>>3&2016|5*s+3*r>>3&63488,e[3]=5*m+3*g>>3|5*n+3*h>>3&2016|5*r+3*s>>3&63488,g=a[k+2],h=4*q*d+4*t,f[h]=e[g&3],f[h+1]=e[g>>2&3],f[h+2]=e[g>>4&3],f[h+3]=e[g>>6&3],h+=d,f[h]=e[g>>8&3],f[h+1]=e[g>>10&3],f[h+2]=e[g>>12&3],f[h+3]=e[g>>14],g=a[k+3],h+=d,f[h]=e[g&3],f[h+1]=e[g>>2&3],f[h+2]=e[g>>4&3],f[h+3]=e[g>>6&3],h+=d,f[h]=e[g>>8&3],f[h+1]=e[g>>10&3],f[h+2]=e[g>>12&3],
f[h+3]=e[g>>14];return f}function a(a){for(var b=0,d=a.length,c=0;b<d;b+=4)c=a[b],a[b]=a[b+2],a[b+2]=c}function b(b,d,c,e){var C=new Int32Array(c,0,q),D,w,x,y,z,H,G,E,u;if(C[s]!=g)return console.error("Invalid magic number in DDS header"),0;if(!C[v]&r)return console.error("Unsupported format, must contain a FourCC code"),0;D=C[P];switch(D){case n:w=8;x=d?d.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case m:w=16;x=d?d.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case l:w=16;x=d?d.COMPRESSED_RGBA_S3TC_DXT5_EXT:
null;break;default:w=4,D=null,x=b.RGBA}G=1;C[p]&h&&!1!==e&&(G=Math.max(1,C[F]));y=C[A];z=C[B];H=C[t]+4;if(C[I+1]&k)for(u=0;6>u;++u)for(y=C[A],z=C[B],E=0;E<G;++E)D?(e=Math.max(4,y)/4*Math.max(4,z)/4*w,d=new Uint8Array(c,H,e),b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+u,E,x,y,z,0,d)):(e=y*z*w,d=new Uint8Array(c,H,e),a(d),b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+u,E,x,y,z,0,b.RGBA,b.UNSIGNED_BYTE,d)),H+=e,y*=0.5,z*=0.5;else if(d)for(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0),E=0;E<G;++E)D?(e=
Math.max(4,y)/4*Math.max(4,z)/4*w,d=new Uint8Array(c,H,e),b.compressedTexImage2D(b.TEXTURE_2D,E,x,y,z,0,d)):(e=y*z*w,d=new Uint8Array(c,H,e),a(d),b.texImage2D(b.TEXTURE_2D,E,x,y,z,0,x,b.UNSIGNED_BYTE,d)),H+=e,y*=0.5,z*=0.5;else if(D==n)Math.max(4,y),Math.max(4,z),d=new Uint16Array(c),c=f(d,H/2,y,z),b.texImage2D(b.TEXTURE_2D,0,b.RGB,y,z,0,b.RGB,b.UNSIGNED_SHORT_5_6_5,c),e&&b.generateMipmap(b.TEXTURE_2D);else return console.error("No manual decoder for",String.fromCharCode(D&255,D>>8&255,D>>16&255,
D>>24&255),"and no native support"),0;return G}function c(b,d){var c=new Int32Array(b,0,q),e,C,D,w,x,y,z,u,G,E,N;if(c[s]!=g)return console.error("Invalid magic number in DDS header"),0;if(!c[v]&r)return console.error("Unsupported format, must contain a FourCC code"),0;e=c[P];switch(e){case n:C=8;D="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case m:C=16;D="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case l:C=16;D="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:C=4,D="RGBA"}G=1;c[p]&h&&!1!==loadMipmaps&&(G=Math.max(1,
c[F]));w=c[A];x=c[B];z=c[t]+4;var O=[];if(c[I+1]&k)for(N=0;6>N;++N)for(w=c[A],x=c[B],E=0;E<G;++E)e?(y=Math.max(4,w)/4*Math.max(4,x)/4*C,new Uint8Array(b,z,y),O.push({tex:"TEXTURE_CUBE_MAP",face:N,mipmap:E,internalFormat:D,width:w,height:x,offset:0,dataOffset:z,dataLength:y})):(y=w*x*C,u=new Uint8Array(b,z,y),a(u),O.push({tex:"TEXTURE_CUBE_MAP",face:N,mipmap:E,internalFormat:D,width:w,height:x,offset:0,type:"UNSIGNED_BYTE",dataOffset:z,dataLength:y})),z+=y,w*=0.5,x*=0.5;else if(d)if(e==n)Math.max(4,
w),Math.max(4,x),u=new Uint16Array(b),c=f(u,z/2,w,x),O.push({tex:"TEXTURE_2D",mipmap:0,internalFormat:"RGB",width:w,height:x,offset:0,format:"RGB",type:"UNSIGNED_SHORT_5_6_5",data:c});else return console.error("No manual decoder for",String.fromCharCode(e&255,e>>8&255,e>>16&255,e>>24&255),"and no native support"),0;else for(E=0;E<G;++E)y=Math.max(4,w)/4*Math.max(4,x)/4*C,new Uint8Array(b,z,y),O.push({tex:"TEXTURE_2D",mipmap:E,internalFormat:D,width:w,height:x,offset:0,type:"UNSIGNED_BYTE",dataOffset:z,
dataLength:y}),z+=y,w*=0.5,x*=0.5;return O}function d(a,d,c,e,f,g){var h=new XMLHttpRequest;h.open("GET",c,!0);h.responseType="arraybuffer";h.onload=function(){if(200==this.status){var c=new Int32Array(this.response,0,q),h=c[I+1]&k?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(h,e);var s=b(a,d,this.response,f);a.texParameteri(h,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(h,a.TEXTURE_MIN_FILTER,1<s?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);a.bindTexture(h,null);e.texture_type=h;e.width=c[A];e.height=c[B]}g&&
g(e)};h.send(null);return e}var g=542327876,h=131072,k=512,r=4,n=e("DXT1"),m=e("DXT3"),l=e("DXT5"),q=31,s=0,t=1,p=2,B=3,A=4,F=7,v=20,P=21,I=27;return{dxtToRgb565:f,uploadDDSLevels:b,loadDDSTextureEx:d,loadDDSTexture:function(a,b,c,e){var f=a.createTexture();b=a.getExtension("WEBGL_compressed_texture_s3tc");d(a,b,c,f,!0,e);return f},loadDDSTextureFromMemoryEx:function(a,c,d,e,f){var g=new Int32Array(d,0,q),h=!!(g[I+1]&k),s=h?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(s,e.handler);c=b(a,c,d,f);a.texParameteri(s,
a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(s,a.TEXTURE_MIN_FILTER,1<c?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);h&&(a.texParameteri(s,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(s,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE));a.bindTexture(s,null);e.handler&&(e.texture_type=s,e.width=g[A],e.height=g[B]);return e},getDDSTextureFromMemoryEx:function(a){var b=new Int32Array(a,0,q),d=b[I+1]&k?"TEXTURE_CUBE_MAP":"TEXTURE_2D",e=c(a);return{type:d,buffers:e,data:a,width:b[A],height:b[B]}}}}();if("undefined"==typeof glMatrix)throw"You must include glMatrix on your project";
Math.clamp=function(e,f,a){return f>e?f:a<e?a:e};vec2.rotate=function(e,f,a){var b=f[0];f=f[1];var c=Math.cos(a);a=Math.sin(a);e[0]=b*c-f*a;e[1]=b*a+f*c;return e};vec3.zero=function(e){e[0]=e[1]=e[2]=0;return e};vec3.minValue=function(e){return e[0]<e[1]&&e[0]<e[2]?e[0]:e[1]<e[2]?e[1]:e[2]};vec3.maxValue=function(e){return e[0]>e[1]&&e[0]>e[2]?e[0]:e[1]>e[2]?e[1]:e[2]};vec3.minValue=function(e){return e[0]<e[1]&&e[0]<e[2]?e[0]:e[1]<e[2]?e[1]:e[2]};vec3.addValue=function(e,f,a){e[0]=f[0]+a;e[1]=f[1]+
a;e[2]=f[2]+a};vec3.subValue=function(e,f,a){e[0]=f[0]-a;e[1]=f[1]-a;e[2]=f[2]-a};vec3.toArray=function(e){return[e[0],e[1],e[2]]};vec3.rotateX=function(e,f,a){var b=f[1],c=f[2],d=Math.cos(a);a=Math.sin(a);e[0]=f[0];e[1]=b*d-c*a;e[2]=b*a+c*d;return e};vec3.rotateY=function(e,f,a){var b=f[0],c=f[2],d=Math.cos(a);a=Math.sin(a);e[0]=b*d-c*a;e[1]=f[1];e[2]=b*a+c*d;return e};vec3.rotateZ=function(e,f,a){var b=f[0],c=f[1],d=Math.cos(a);a=Math.sin(a);e[0]=b*d-c*a;e[1]=b*a+c*d;e[2]=f[2];return e};vec2.perpdot=
function(e,f){return e[1]*f[0]+-e[0]*f[1]};vec2.computeSignedAngle=function(e,f){return Math.atan2(vec2.perpdot(e,f),vec2.dot(e,f))};vec2.random=function(e){e[0]=Math.random();e[1]=Math.random();return e};vec3.angle=function(e,f){return Math.acos(vec3.dot(e,f))};vec3.random=function(e){e[0]=Math.random();e[1]=Math.random();e[2]=Math.random();return e};vec4.random=function(e){e[0]=Math.random();e[1]=Math.random();e[2]=Math.random();e[3]=Math.random();return e};vec3.polarToCartesian=function(e,f){var a=
f[0],b=f[1],c=f[2];e[0]=a*Math.cos(b)*Math.sin(c);e[1]=a*Math.sin(b);e[2]=a*Math.cos(b)*Math.cos(c);return e};mat4.toArray=function(e){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]};mat4.setUpAndOrthonormalize=function(e,f,a){f!=e&&mat4.copy(e,f);f=e.subarray(0,3);vec3.normalize(e.subarray(4,7),a);e=e.subarray(8,11);vec3.cross(f,a,e);vec3.normalize(f,f);vec3.cross(e,f,a);vec3.normalize(e,e)};mat4.multiplyVec3=function(e,f,a){var b=a[0],c=a[1];a=a[2];
e[0]=f[0]*b+f[4]*c+f[8]*a+f[12];e[1]=f[1]*b+f[5]*c+f[9]*a+f[13];e[2]=f[2]*b+f[6]*c+f[10]*a+f[14];return e};mat4.projectVec3=function(e,f,a){mat4.multiplyVec3(e,f,a);e[0]/=e[2];e[1]/=e[2];return e};mat4.rotateVec3=function(e,f,a){var b=a[0],c=a[1];a=a[2];e[0]=f[0]*b+f[4]*c+f[8]*a;e[1]=f[1]*b+f[5]*c+f[9]*a;e[2]=f[2]*b+f[6]*c+f[10]*a;return e};mat4.fromTranslationFrontTop=function(e,f,a,b){vec3.cross(e.subarray(0,3),a,b);e.set(b,4);e.set(a,8);e.set(f,12);return e};mat4.translationMatrix=function(e){var f=
mat4.create();f[12]=e[0];f[13]=e[1];f[14]=e[2];return f};mat4.setTranslation=function(e,f){e[12]=f[0];e[13]=f[1];e[14]=f[2];return e};mat4.getTranslation=function(e,f){e[0]=f[12];e[1]=f[13];e[2]=f[14];return e};mat4.toRotationMat4=function(e,f){mat4.copy(e,f);e[12]=e[13]=e[14]=0;return e};mat4.swapRows=function(e,f,a,b){if(e!=f)return mat4.copy(e,f),e[4*a]=f[4*b],e[4*a+1]=f[4*b+1],e[4*a+2]=f[4*b+2],e[4*a+3]=f[4*b+3],e[4*b]=f[4*a],e[4*b+1]=f[4*a+1],e[4*b+2]=f[4*a+2],e[4*b+3]=f[4*a+3],e;f=new Float32Array(matrix.subarray(4*
a,5*a));matrix.set(matrix.subarray(4*b,5*b),4*a);matrix.set(f,4*b);return e};mat4.scaleAndAdd=function(e,f,a,b){e[0]=f[0]+a[0]*b;e[1]=f[1]+a[1]*b;e[2]=f[2]+a[2]*b;e[3]=f[3]+a[3]*b;e[4]=f[4]+a[4]*b;e[5]=f[5]+a[5]*b;e[6]=f[6]+a[6]*b;e[7]=f[7]+a[7]*b;e[8]=f[8]+a[8]*b;e[9]=f[9]+a[9]*b;e[10]=f[10]+a[10]*b;e[11]=f[11]+a[11]*b;e[12]=f[12]+a[12]*b;e[13]=f[13]+a[13]*b;e[14]=f[14]+a[14]*b;e[15]=f[15]+a[15]*b;return e};vec3.project=function(e,f,a,b){f=vec3.clone(f);mat4.multiplyVec3(f,a,f);mat4.multiplyVec3(f,
b,f);return vec3.set(e,viewport[0]+viewport[2]*(0.5*point[0]+0.5),viewport[1]+viewport[3]*(0.5*point[1]+0.5),0.5*point[2]+0.5)};var Q=mat4.create(),u=vec4.create();vec3.unproject=function(e,f,a,b,c){u[0]=2*(f[0]-c[0])/c[2]-1;u[1]=2*(f[1]-c[1])/c[3]-1;u[2]=2*f[2]-1;u[3]=1;mat4.multiply(Q,b,a);if(!mat4.invert(Q,Q))return null;vec4.transformMat4(u,u,Q);if(0===u[3])return null;e[0]=u[0]/u[3];e[1]=u[1]/u[3];e[2]=u[2]/u[3];return e};quat.toEuler=function(e,f){var a=Math.atan2(2*f[1]*f[3]-2*f[0]*f[2],1-
2*f[1]*f[1]-2*f[2]*f[2]),b=Math.asin(2*f[0]*f[1]+2*f[2]*f[3]),c=Math.atan2(2*f[0]*f[3]-2*f[1]*f[2],1-2*f[0]*f[0]-2*f[2]*f[2]);e||(e=vec3.create());vec3.set(e,a,b,c);return e};quat.fromEuler=function(e,f){var a=f[0],b=f[1],c=f[2],d=Math.cos(a),g=Math.cos(b),h=Math.cos(c),a=Math.sin(a),b=Math.sin(b),c=Math.sin(c),k=0.5*Math.sqrt(1+d*g+d*h-a*b*c+g*h);return quat.set(e,(g*c+d*c+a*b*h)/(4*k),(a*g+a*h+d*b*c)/(4*k),(-a*c+d*b*h+b)/(4*k),k)};quat.fromMat4=function(e,f){var a=f[0]+f[5]+f[10];if(0<a){var b=
Math.sqrt(a+1);e[3]=0.5*b;b=0.5/b;e[0]=(f[9]-f[6])*b;e[1]=(f[2]-f[8])*b;e[2]=(f[4]-f[1])*b}else{a=0;f[5]>f[0]&&(a=1);f[10]>f[4*a+a]&&(a=2);var c=(a+1)%3,d=(c+1)%3,b=Math.sqrt(f[4*a+a]-f[4*c+c]-f[4*d+d]+1);e[a]=0.5*b;b=0.5/b;e[3]=(f[4*d+c]-f[4*c+d])*b;e[c]=(f[4*c+a]+f[4*a+c])*b;e[d]=(f[4*d+a]+f[4*a+d])*b}quat.normalize(e,e)};l.Indexer=function(){this.unique=[];this.indices=[];this.map={}};l.Indexer.prototype={add:function(e){var f=JSON.stringify(e);f in this.map||(this.map[f]=this.unique.length,this.unique.push(e));
return this.map[f]}};p.Buffer=l.Buffer=function(e,f,a,b,c){c=c||p.gl;this.buffer=null;this.target=e;this.gl=c;this.data=f;this.spacing=a||3;this.data&&this.upload(b)};l.Buffer.prototype.forEach=function(e){for(var f=this.data,a=0,b=this.spacing,c=f.length;a<c;a+=b)e(f.subarray(a,a+b));return this};l.Buffer.prototype.upload=function(e){var f=this.spacing||3,a=this.gl;if(!this.data)throw"No data supplied";var b=this.data;if(!b.buffer)throw"Buffers must be typed arrays";this.buffer=this.buffer||a.createBuffer();
this.buffer.length=b.length;this.buffer.spacing=f;switch(b.constructor){case Int8Array:this.buffer.gl_type=a.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=a.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=a.SHORT;break;case Uint16Array:this.buffer.gl_type=a.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=a.INT;break;case Uint32Array:this.buffer.gl_type=a.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=a.FLOAT;break;default:throw"unsupported buffer type";
}a.bindBuffer(this.target,this.buffer);a.bufferData(this.target,b,e||this.stream_type||a.STATIC_DRAW)};l.Buffer.prototype.compile=l.Buffer.prototype.upload;l.Buffer.prototype.uploadRange=function(e,f){if(!this.data)throw"No data stored in this buffer";if(!this.data.buffer)throw"Buffers must be typed arrays";var a=new Uint8Array(this.data.buffer,e,f),b=this.gl;b.bindBuffer(this.target,this.buffer);b.bufferSubData(this.target,e,a)};p.Mesh=l.Mesh=function(e,f,a,b){this.gl=b=b||p.gl;this._context_id=
b.context_id;this.vertexBuffers={};this.indexBuffers={};(e||f)&&this.addBuffers(e,f);if(a)for(var c in a)this[c]=a[c]};Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal"},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color"},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",
type:Uint8Array},weights:{spacing:4,attribute:"a_weights"},extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}};Mesh.prototype.addBuffer=function(e,f){f.target==gl.ARRAY_BUFFER?this.vertexBuffers[e]=f:this.indexBuffers[e]=f;f.attribute||(f.attribute=Mesh.common_buffers[e].attribute)};Mesh.prototype.addBuffers=function(e,f,a){var b=0;this.vertexBuffers.vertices&&(b=this.vertexBuffers.vertices.data.length/
3);for(var c in e){var d=e[c];if(d){if(d.constructor==l.Buffer)d=d.data;else if("number"!=typeof d[0]){for(var g=[],h=0,k=1E4;h<d.length;h+=k)g=Array.prototype.concat.apply(g,d.slice(h,h+k));d=g}g=Mesh.common_buffers[c];d.constructor===Array&&(h=Float32Array,g&&g.type&&(h=g.type),d=new h(d));"vertices"==c&&(b=d.length/3);h=d.length/b;g&&g.spacing&&(h=g.spacing);k="a_"+c;g&&g.attribute&&(k=g.attribute);this.createVertexBuffer(c,k,h,d,a)}}if(f)for(c in f)if(d=f[c]){d.constructor==l.Buffer&&(d=d.data);
if("number"!=typeof d[0])for(d=[],c=0,k=1E4;c<this.data.length;c+=k)d=Array.prototype.concat.apply(d,this.data.slice(c,c+k));d.constructor===Array&&(h=Uint16Array,65536<b&&(h=Uint32Array),d=new h(d));this.createIndexBuffer(c,d)}};Mesh.prototype.createVertexBuffer=function(e,f,a,b,c){var d=Mesh.common_buffers[e];!f&&d&&(f=d.attribute);if(!f)throw"Buffer added to mesh without attribute name";!a&&d&&(a=d&&d.spacing?d.spacing:3);if(!b){b=this.getNumVertices();if(!b)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to now the size)";
b=new Float32Array(b*a)}if(!b.buffer)throw"Buffer data MUST be typed array";a=this.vertexBuffers[e]=new l.Buffer(gl.ARRAY_BUFFER,b,a,c,this.gl);a.name=e;a.attribute=f;return a};Mesh.prototype.removeVertexBuffer=function(e){this.vertexBuffers[e]&&delete this.vertexBuffers[e]};Mesh.prototype.getVertexBuffer=function(e){return this.vertexBuffers[e]};Mesh.prototype.createIndexBuffer=function(e,f,a){return this.indexBuffers[e]=new l.Buffer(gl.ELEMENT_ARRAY_BUFFER,f,0,a,this.gl)};Mesh.prototype.getBuffer=
function(e){return this.vertexBuffers[e]};Mesh.prototype.getIndexBuffer=function(e){return this.indexBuffers[e]};Mesh.prototype.upload=function(e){for(var f in this.vertexBuffers){var a=this.vertexBuffers[f];a.upload(e)}for(var b in this.indexBuffers)a=this.indexBuffers[b],a.upload()};Mesh.prototype.compile=Mesh.prototype.upload;Mesh.prototype.clone=function(e){e=e||p.gl;var f={},a={},b;for(b in mesh.vertexBuffers)f[b]=mesh.vertexBuffers[b].data;for(b in mesh.indexBuffers)a[b]=mesh.indexBuffers[b].data;
return new l.Mesh(f,a,void 0,e)};Mesh.prototype.cloneShared=function(e){e=e||p.gl;return new l.Mesh(this.vertexBuffers,this.indexBuffers,void 0,e)};Mesh.prototype.generateMetadata=function(){var e={},f=this.vertexBuffers.vertices.data,a=this.indexBuffers.triangles.data;e.vertices=f.length/3;e.faces=a?a.length/3:f.length/9;e.indexed=!!this.metadata.faces;this.metadata=e};Mesh.prototype.computeWireframe=function(){var e=this.indexBuffers.triangles,f=this.vertexBuffers.vertices.data.length/3;if(e){for(var a=
e.data,b=new l.Indexer,e=0;e<a.length;e+=3)for(var c=a.subarray(e,e+3),d=0;d<c.length;d++){var g=c[d],h=c[(d+1)%c.length];b.add([Math.min(g,h),Math.max(g,h)])}a=b.unique;b=65536<f?new Uint32Array(2*a.length):new Uint16Array(2*a.length);e=0;for(f=a.length;e<f;++e)b.set(a[e],2*e)}else for(e=f/3,b=65536<f?new Uint32Array(6*e):new Uint16Array(6*e),e=0;e<f;e+=3)b[2*e]=e,b[2*e+1]=e+1,b[2*e+2]=e+1,b[2*e+3]=e+2,b[2*e+4]=e+2,b[2*e+5]=e;this.createIndexBuffer("wireframe",b);return this};Mesh.prototype.computeNormals=
function(){var e=this.vertexBuffers.vertices.data,f=new Float32Array(e.length),a=null;this.indexBuffers.triangles&&(a=this.indexBuffers.triangles.data);for(var b=vec3.create(),c=vec3.create(),d,g,h,k,r,n,m=a?a.length:e.length,l=0;l<m;l+=3)a?(d=a[l],g=a[l+1],h=a[l+2],k=e.subarray(3*d,3*d+3),r=e.subarray(3*g,3*g+3),n=e.subarray(3*h,3*h+3),d=f.subarray(3*d,3*d+3),g=f.subarray(3*g,3*g+3),h=f.subarray(3*h,3*h+3)):(k=e.subarray(3*l,3*l+3),r=e.subarray(3*l+3,3*l+6),n=e.subarray(3*l+6,3*l+9),d=f.subarray(3*
l,3*l+3),g=f.subarray(3*l+3,3*l+6),h=f.subarray(3*l+6,3*l+9)),vec3.sub(b,r,k),vec3.sub(c,n,k),vec3.cross(b,b,c),vec3.normalize(b,b),vec3.add(d,d,b),vec3.add(g,g,b),vec3.add(h,h,b);if(a)for(l=0,m=f.length;l<m;l+=3)e=f.subarray(l,l+3),vec3.normalize(e,e);this.createVertexBuffer("normals",Mesh.common_buffers.normals.attribute,3,f)};Mesh.prototype.computeTangents=function(){var e=this.vertexBuffers.vertices.data,f=this.vertexBuffers.normals.data,a=this.vertexBuffers.coords.data,b=this.indexBuffers.triangles.data;
if(e&&f&&a){var c=e.length/3,d=new Float32Array(4*c),g=new Float32Array(6*c),c=g.subarray(3*c),h,k,r=vec3.create(),n=vec3.create(),m=vec3.create(),l=vec3.create();h=0;for(k=b.length;h<k;h+=3){var q=b[h],s=b[h+1],t=b[h+2],p=e.subarray(3*q,3*q+3),B=e.subarray(3*s,3*s+3),A=e.subarray(3*t,3*t+3),F=a.subarray(2*q,2*q+2),v=a.subarray(2*s,2*s+2),u=a.subarray(2*t,2*t+2),I=B[0]-p[0],M=A[0]-p[0],K=B[1]-p[1],L=A[1]-p[1],B=B[2]-p[2],p=A[2]-p[2],A=v[0]-F[0],J=u[0]-F[0],v=v[1]-F[1],F=u[1]-F[1],u=A*F-J*v,u=1E-9>
Math.abs(u)?0:1/u;vec3.copy(r,[(F*I-v*M)*u,(F*K-v*L)*u,(F*B-v*p)*u]);vec3.copy(n,[(A*M-J*I)*u,(A*L-J*K)*u,(A*p-J*B)*u]);vec3.add(g.subarray(3*q,3*q+3),g.subarray(3*q,3*q+3),r);vec3.add(g.subarray(3*s,3*s+3),g.subarray(3*s,3*s+3),r);vec3.add(g.subarray(3*t,3*t+3),g.subarray(3*t,3*t+3),r);vec3.add(c.subarray(3*q,3*q+3),c.subarray(3*q,3*q+3),n);vec3.add(c.subarray(3*s,3*s+3),c.subarray(3*s,3*s+3),n);vec3.add(c.subarray(3*t,3*t+3),c.subarray(3*t,3*t+3),n)}h=0;for(k=e.length;h<k;h+=3)e=f.subarray(h,h+
3),a=g.subarray(h,h+3),vec3.subtract(m,a,vec3.scale(m,e,vec3.dot(e,a))),vec3.normalize(m,m),e=0>vec3.dot(vec3.cross(l,e,a),c.subarray(h,h+3))?-1:1,d.set([m[0],m[1],m[2],e],h/3*4);this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,d)}};Mesh.prototype.getNumVertices=function(){var e=this.vertexBuffers.vertices;return e?e.data.length/e.spacing:0};Mesh.computeBounding=function(e,f){if(e){for(var a=vec3.clone(e.subarray(0,3)),b=vec3.clone(e.subarray(0,3)),c,d=3;d<e.length;d+=3)c=
e.subarray(d,d+3),vec3.min(a,c,a),vec3.max(b,c,b);a=vec3.add(vec3.create(),a,b);vec3.scale(a,a,0.5);b=vec3.subtract(vec3.create(),b,a);return BBox.setCenterHalfsize(f||BBox.create(),a,b)}};Mesh.prototype.updateBounding=function(){var e=this.vertexBuffers.vertices.data;e&&(this.bounding=Mesh.computeBounding(e,this.bounding))};Mesh.prototype.setBounding=function(e,f){this.bounding=BBox.setCenterHalfsize(this.bounding||BBox.create(),e,f)};Mesh.prototype.freeData=function(){for(var e in this.vertexBuffers)this.vertexBuffers[e].data=
null,delete this[this.vertexBuffers[e].name];for(var f in this.indexBuffers)this.indexBuffers[f].data=null,delete this[this.indexBuffers[f].name]};Mesh.prototype.configure=function(e,f){var a={},b={};f=f||{};for(var c in e)e[c]&&("indices"==c||"lines"==c||"wireframe"==c||"triangles"==c?b[c]=e[c]:Mesh.common_buffers[c]?a[c]=e[c]:f[c]=e[c]);this.addBuffers(a,b);for(b in f)this[b]=f[b]};Mesh.load=function(e,f,a){f=f||{};a=a||new l.Mesh;a.configure(e,f);return a};Mesh.plane=function(e){e=e||{};e.triangles=
[];var f=e.detailX||e.detail||1,a=e.detailY||e.detail||1,b=e.width||e.size||1,c=e.height||e.size||1,d=e.xz,b=0.5*b,c=0.5*c;e=[];var g=[],h=[],k=[],r=vec3.fromValues(0,0,1);d&&r.set([0,1,0]);for(var n=0;n<=a;n++)for(var m=n/a,p=0;p<=f;p++){var q=p/f;d?g.push((2*q-1)*b,0,(2*m-1)*b):g.push((2*q-1)*b,(2*m-1)*c,0);h&&h.push(q,m);k&&k.push(r[0],r[1],r[2]);p<f&&n<a&&(q=p+n*(f+1),d?(e.push(q+1,q,q+f+1),e.push(q+1,q+f+1,q+f+2)):(e.push(q,q+1,q+f+1),e.push(q+f+1,q+1,q+f+2)))}f=BBox.fromCenterHalfsize([0,0,
0],d?[b,0,c]:[b,c,0]);return l.Mesh.load({vertices:g,normals:k,coords:h,triangles:e},{bounding:f})};Mesh.plane2D=function(e){var f=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),a=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(e&&e.size){e=0.5*e.size;for(var b=0;b<f.length;++b)f[b]*=e}return new l.Mesh({vertices2D:f,coords:a})};Mesh.point=function(e){return new l.Mesh({vertices:[0,0,0]})};Mesh.cube=function(e){e=e||{};var f=e.size||1,f=0.5*f,a={};a.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,
1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var b=0,c=a.vertices.length;b<c;++b)a.vertices[b]*=f;a.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,
1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);a.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);e.bounding=BBox.fromCenterHalfsize([0,0,0],[f,f,f]);return Mesh.load(a,e)};Mesh.box=function(e){e=e||{};var f=e.sizex||1,a=e.sizey||1,b=e.sizez||1,f=0.5*f,a=0.5*a,b=0.5*b,c={};c.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,
-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var d=0,g=c.vertices.length;d<g;d+=3)c.vertices[d]*=f,c.vertices[d+1]*=a,c.vertices[d+2]*=b;c.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,
1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);c.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);e.bounding=BBox.fromCenterHalfsize([0,0,0],[f,a,b]);return Mesh.load(c,e)};Mesh.circle=function(e){e=e||{};var f=e.size||e.radius||1,a=Math.ceil(e.slices||24),b=e.xz||!1,c=e.empty||!1;3>a&&(a=3);var d=2*Math.PI/a,g=vec3.create(),h=vec3.create(),k=vec3.fromValues(0,
0,1),r=vec2.fromValues(0.5,0.5),n=vec2.create();b&&k.set([0,1,0]);var m=b?2:1,l=new Float32Array(3*(a+1)),q=new Float32Array(3*(a+1)),s=new Float32Array(2*(a+1)),t=null;l.set(g,0);q.set(k,0);s.set(r,0);for(g=r=t=0;g<a;++g)t=Math.sin(d*g),r=Math.cos(d*g),h[0]=t*f,h[m]=r*f,n[0]=0.5*t+0.5,n[1]=0.5*r+0.5,l.set(h,3*g+3),q.set(k,3*g+3),s.set(n,2*g+2);if(c)l=l.subarray(3),q=l.subarray(3),s=l.subarray(2),t=null;else{t=new Uint16Array(3*a);c=2;d=1;b&&(c=1,d=2);for(g=0;g<a-1;++g)t[3*g]=0,t[3*g+1]=g+c,t[3*g+
2]=g+d;t[3*g]=0;b?(t[3*g+1]=g+1,t[3*g+2]=1):(t[3*g+1]=1,t[3*g+2]=g+1)}e.bounding=BBox.fromCenterHalfsize([0,0,0],b?[f,0,f]:[f,f,0]);return Mesh.load({vertices:l,normals:q,coords:s,triangles:t},e)};Mesh.cylinder=function(e){e=e||{};for(var f=e.radius||e.size||1,a=e.height||e.size||2,b=e.subdivisions||64,c=new Float32Array(18*b),d=new Float32Array(18*b),g=new Float32Array(12*b),h=2*Math.PI/b,k=null,r=0;r<b;++r){var n=r*h,k=[Math.sin(n),0,Math.cos(n)];c.set([k[0]*f,0.5*a,k[2]*f],18*r);d.set(k,18*r);
g.set([r/b,1],12*r);k=[Math.sin(n),0,Math.cos(n)];c.set([k[0]*f,-0.5*a,k[2]*f],18*r+3);d.set(k,18*r+3);g.set([r/b,0],12*r+2);k=[Math.sin(n+h),0,Math.cos(n+h)];c.set([k[0]*f,-0.5*a,k[2]*f],18*r+6);d.set(k,18*r+6);g.set([(r+1)/b,0],12*r+4);k=[Math.sin(n+h),0,Math.cos(n+h)];c.set([k[0]*f,0.5*a,k[2]*f],18*r+9);d.set(k,18*r+9);g.set([(r+1)/b,1],12*r+6);k=[Math.sin(n),0,Math.cos(n)];c.set([k[0]*f,0.5*a,k[2]*f],18*r+12);d.set(k,18*r+12);g.set([r/b,1],12*r+8);k=[Math.sin(n+h),0,Math.cos(n+h)];c.set([k[0]*
f,-0.5*a,k[2]*f],18*r+15);d.set(k,18*r+15);g.set([(r+1)/b,0],12*r+10)}b={vertices:c,normals:d,coords:g};e.bounding=BBox.fromCenterHalfsize([0,0,0],[f,0.5*a,f]);return Mesh.load(b,e)};Mesh.sphere=function(e){e=e||{};for(var f=e.radius||e.size||1,a=e.lat||16,b=e["long"]||16,c=new Float32Array((a+1)*(b+1)*3),d=new Float32Array((a+1)*(b+1)*3),g=new Float32Array((a+1)*(b+1)*2),h=new Uint16Array(a*b*6),k=0,r=0,n=0;n<=a;n++)for(var m=n*Math.PI/a,l=Math.sin(m),q=Math.cos(m),m=0;m<=b;m++){var s=2*m*Math.PI/
b,t=Math.sin(s),s=Math.cos(s)*l,p=q,t=t*l,B=1-m/b,u=1-n/a;c.set([f*s,f*p,f*t],k);d.set([s,p,t],k);g.set([B,u],r);k+=3;r+=2}for(n=k=0;n<a;n++)for(m=0;m<b;m++)r=n*(b+1)+m,l=r+b+1,h.set([l,r,r+1],k),h.set([l+1,l,r+1],k+3),k+=6;a={vertices:c,normals:d,coords:g,triangles:h};e.bounding=BBox.fromCenterHalfsize([0,0,0],[f,f,f],f);return Mesh.load(a,e)};Mesh.grid=function(e){e=e||{};var f=e.lines||10;0>f&&(f=1);var a=e.size||10;e=new Float32Array(12*f);for(var b=0.5*a,c=0,d=-b,a=a/(f-1),g=0;g<f;g++)e[c]=d,
e[c+2]=-b,e[c+3]=d,e[c+5]=b,e[c+6]=b,e[c+8]=d,e[c+9]=-b,e[c+11]=d,d+=a,c+=12;return new l.Mesh({vertices:e})};Mesh.mergeMeshes=function(e){var f={},a={},b=e[0],c=[],d;for(d in b.vertexBuffers){for(var g=b.vertexBuffers[d],h=g.data.length,k=1;k<e.length;++k){if(!e[k].vertexBuffers[d])throw"cannot merge with different amount of buffers";h+=e[k].vertexBuffers[d].data.length}g=new Float32Array(h);for(k=h=0;k<e.length;++k)c[k]=h,g.set(e[k].vertexBuffers[d].data,h),h+=e[k].vertexBuffers[d].data.length;
f[d]=g}for(d in b.indexBuffers){g=b.indexBuffers[d];h=g.data.length;for(k=1;k<e.length;++k){if(!e[k].indexBuffers[d])throw"cannot merge with different amount of buffers";h+=e[k].indexBuffers[d].data.length}g=new g.constructor(h);for(k=h=0;k<e.length;++k){var r=e[k].indexBuffers[d].data;if(0==k)g.set(r,h);else for(var n=c[k],m=0,l=r.length;m<l;m++)g[m+h]=r[m]+n;h+=e[k].indexBuffers[d].data.length}a[d]=g}return new Mesh(f,a)};Mesh.parsers={};Mesh.fromURL=function(e,f,a){a=a||p.gl;var b=new l.Mesh(void 0,
void 0,void 0,a);HttpRequest(e,null,function(a){var d=e.substr(e.length-4).toLowerCase(),g=Mesh.parsers[d];if(g)g.call(null,a,{mesh:b});else throw"Mesh.fromURL: no parser found for format "+d;f&&f(b)});return b};Mesh.getScreenQuad=function(e){e=e||p.gl;var f=e.meshes[":screen_quad"];if(f)return f;var f=new Float32Array(18),a=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]),f=new l.Mesh({vertices:f,coords:a},void 0,void 0,e);return e.meshes[":screen_quad"]=f};p.Texture=l.Texture=function f(a,b,c,d){c=c||
{};this.gl=d=d||p.gl;this._context_id=d.context_id;a=parseInt(a);b=parseInt(b);this.handler=d.createTexture();this.width=a;this.height=b;this.format=c.format||d.RGBA;this.type=c.type||d.UNSIGNED_BYTE;this.texture_type=c.texture_type||d.TEXTURE_2D;this.magFilter=c.magFilter||c.filter||d.LINEAR;this.minFilter=c.minFilter||c.filter||d.LINEAR;this.wrapS=c.wrap||c.wrapS||d.CLAMP_TO_EDGE;this.wrapT=c.wrap||c.wrapT||d.CLAMP_TO_EDGE;f.MAX_TEXTURE_IMAGE_UNITS||(f.MAX_TEXTURE_IMAGE_UNITS=d.getParameter(d.MAX_TEXTURE_IMAGE_UNITS));
this.has_mipmaps=!1;if(this.format==d.DEPTH_COMPONENT&&!d.depth_ext)throw"Depth Texture not supported";if(this.type==d.FLOAT&&!d.float_ext)throw"Float Texture not supported";if(this.type==d.HALF_FLOAT_OES&&!d.half_float_ext)throw"Half Float Texture not supported";if(!((this.minFilter==d.NEAREST||this.minFilter==d.LINEAR)&&this.wrapS==d.CLAMP_TO_EDGE&&this.wrapT==d.CLAMP_TO_EDGE||isPowerOfTwo(this.width)&&isPowerOfTwo(this.height)))if(c.ignore_pot)this.minFilter=this.magFilter=d.LINEAR,this.wrapS=
this.wrapT=d.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";a&&b&&(d.activeTexture(d.TEXTURE0+f.MAX_TEXTURE_IMAGE_UNITS-1),d.bindTexture(this.texture_type,this.handler),d.texParameteri(this.texture_type,d.TEXTURE_MAG_FILTER,this.magFilter),d.texParameteri(this.texture_type,d.TEXTURE_MIN_FILTER,this.minFilter),d.texParameteri(this.texture_type,d.TEXTURE_WRAP_S,this.wrapS),d.texParameteri(this.texture_type,d.TEXTURE_WRAP_T,this.wrapT),this.texture_type==d.TEXTURE_2D?
d.texImage2D(d.TEXTURE_2D,0,this.format,a,b,0,this.format,this.type,c.pixel_data||null):this.texture_type==d.TEXTURE_CUBE_MAP&&(d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,null),d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,null),d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_X,
0,this.format,this.width,this.height,0,this.format,this.type,null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,null)),d.bindTexture(this.texture_type,null),d.activeTexture(d.TEXTURE0))};Texture.framebuffer=null;Texture.renderbuffer=null;Texture.prototype.getProperties=function(){return{width:this.width,height:this.height,type:this.type,
format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}};Texture.isDepthSupported=function(){return null!=(gl.getExtension("WEBGL_depth_texture")||gl.getExtension("WEBKIT_WEBGL_depth_texture")||gl.getExtension("MOZ_WEBGL_depth_texture"))};Texture.prototype.bind=function(f){void 0==f&&(f=0);var a=this.gl;a.activeTexture(a.TEXTURE0+f);a.bindTexture(this.texture_type,this.handler);return f};Texture.prototype.unbind=function(f){void 0===
f&&(f=0);var a=this.gl;a.activeTexture(a.TEXTURE0+f);a.bindTexture(this.texture_type,null)};Texture.prototype.setParameter=function(f,a){this.gl.texParameteri(this.texture_type,f,a)};Texture.setUploadOptions=function(f,a){a=a||p.gl;f?(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!f.premultiply_alpha),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!f.no_flip)):(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0));a.pixelStorei(a.UNPACK_ALIGNMENT,1)};Texture.prototype.uploadImage=
function(f,a){this.bind();var b=this.gl;Texture.setUploadOptions(a,b);try{b.texImage2D(b.TEXTURE_2D,0,this.format,this.format,this.type,f),this.width=f.videoWidth||f.width,this.height=f.videoHeight||f.height}catch(c){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}this.minFilter&&this.minFilter!=
b.NEAREST&&this.minFilter!=b.LINEAR&&(b.generateMipmap(this.texture_type),this.has_mipmaps=!0);b.bindTexture(this.texture_type,null)};Texture.prototype.uploadData=function(f,a){var b=this.gl;this.bind();Texture.setUploadOptions(a,b);b.texImage2D(this.texture_type,0,this.format,this.width,this.height,0,this.format,this.type,f);this.minFilter&&this.minFilter!=b.NEAREST&&this.minFilter!=b.LINEAR&&(b.generateMipmap(texture.texture_type),this.has_mipmaps=!0);b.bindTexture(this.texture_type,null)};Texture.cubemap_camera_parameters=
[{dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,-1,0)},{dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,-1,0)},{dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,1)},{dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,-1)},{dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,-1,0)},{dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,-1,0)}];Texture.prototype.drawTo=function(f,a){var b=this.gl,c=b.getViewport(),d=b._framebuffer=b._framebuffer||b.createFramebuffer(),g=b._renderbuffer=b._renderbuffer||
b.createRenderbuffer();if(this.format==b.DEPTH_COMPONENT)throw"cannot use drawTo in depth textures, use Texture.drawToColorAndDepth";b.bindFramebuffer(b.FRAMEBUFFER,d);b.bindRenderbuffer(b.RENDERBUFFER,g);if(this.width!=g.width||this.height!=g.height)g.width=this.width,g.height=this.height,b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,this.width,this.height);b.viewport(0,0,this.width,this.height);if(this.texture_type==b.TEXTURE_2D)b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,
b.TEXTURE_2D,this.handler,0),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,g),f(this,a);else if(this.texture_type==b.TEXTURE_CUBE_MAP)for(d=0;6>d;d++)b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_CUBE_MAP_POSITIVE_X+d,this.handler,0),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,g),f(this,d,a);b.bindFramebuffer(b.FRAMEBUFFER,null);b.bindRenderbuffer(b.RENDERBUFFER,null);b.viewport(c[0],c[1],c[2],c[3]);return this};Texture.drawToColorAndDepth=
function(f,a,b){var c=f.gl;if(a.width!=f.width||a.height!=f.height)throw"Different size between color texture and depth texture";var d=c.getViewport();Texture.framebuffer=Texture.framebuffer||c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,Texture.framebuffer);c.viewport(0,0,f.width,f.height);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,f.handler,0);c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.TEXTURE_2D,a.handler,0);b();c.bindFramebuffer(c.FRAMEBUFFER,
null);c.viewport(d[0],d[1],d[2],d[3])};Texture.prototype.copyTo=function(f){var a=this,b=this.gl;f.drawTo(function(){b.disable(b.BLEND);b.disable(b.DEPTH_TEST);b.disable(b.CULL_FACE);a.toViewport()});f.minFilter&&f.minFilter!=b.NEAREST&&f.minFilter!=b.LINEAR&&(f.bind(),b.generateMipmap(f.texture_type),f.has_mipmaps=!0);b.bindTexture(f.texture_type,null);return this};Texture.prototype.toViewport=function(f,a){f=f||Shader.getScreenShader();var b=Mesh.getScreenQuad();this.bind(0);f.uniforms({u_texture:0});
a&&f.uniforms(a);f.draw(b,gl.TRIANGLES)};Texture.prototype.renderQuad=function(){var f=mat3.create(),a=vec2.create(),b=vec2.create(),c=vec4.fromValues(1,1,1,1);return function(d,g,h,k,l,n){a[0]=d;a[1]=g;b[0]=h;b[1]=k;l=l||Shader.getQuadShader(this.gl);d=Mesh.getScreenQuad(this.gl);this.bind(0);l.uniforms({u_texture:0,u_position:a,u_color:c,u_size:b,u_viewport:gl.viewport_data.subarray(2,4),u_transform:f});n&&l.uniforms(n);l.draw(d,gl.TRIANGLES)}}();Texture.prototype.toCanvas=function(f){var a=this.gl,
b=this.width,c=this.height;f=f||createCanvas(b,c);f.width!=b&&(f.width=b);f.height!=c&&(f.height=c);var d=new Uint8Array(b*c*4);this.drawTo(function(){a.readPixels(0,0,b,c,a.RGBA,a.UNSIGNED_BYTE,d)});var g=f.getContext("2d"),h=g.getImageData(0,0,b,c);h.data.set(d);g.putImageData(h,0,0);return f};Texture.prototype.applyBlur=function(f,a,b,c){var d=this,g=this.gl,h=Shader.getBlurShader();c||(c=new l.Texture(this.width,this.height,this.getProperties()));f/=this.width;a/=this.height;g.disable(g.DEPTH_TEST);
g.disable(g.BLEND);c.drawTo(function(){d.toViewport(h,{u_intensity:b,u_offset:[0,a]})});this.drawTo(function(){c.toViewport(h,{u_intensity:b,u_offset:[f,0]})});return c};Texture.fromURL=function(f,a,b,c){c=c||p.gl;a=a||{};var d=a.texture||new l.Texture(1,1,a,c);d.bind();Texture.setUploadOptions(a);var g=a.temp_color||[0,0,0,255],g=a.type==c.FLOAT?new Float32Array(g):new Uint8Array(g);c.texImage2D(c.TEXTURE_2D,0,d.format,d.width,d.height,0,d.format,d.type,g);c.bindTexture(d.texture_type,null);d.ready=
!1;if(-1!=f.toLowerCase().indexOf(".dds")){var g=c.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||c.getExtension("WEBGL_compressed_texture_s3tc"),h=new l.Texture(0,0,a,c);S.loadDDSTextureEx(c,g,f,h.handler,!0,function(a){d.texture_type=a.texture_type;d.handler=a;d.ready=!0})}else c=new Image,c.src=f,c.onload=function(){a.texture=d;l.Texture.fromImage(this,a);d.ready=!0;b&&b(d)};return d};Texture.fromImage=function(f,a){a=a||{};var b=a.texture||new l.Texture(f.width,f.height,a);b.bind();b.uploadImage(f,
a);a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromVideo=function(f,a){a=a||{};var b=a.texture||new l.Texture(f.videoWidth,f.videoHeight,a);b.bind();b.uploadImage(f,a);a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromTexture=function(f,
a){a=a||{};var b=new l.Texture(f.width,f.height,a);f.copyTo(b);return b};Texture.fromMemory=function(f,a,b,c){c=c||{};var d=c.texture||new l.Texture(f,a,c);Texture.setUploadOptions(c);d.bind();try{gl.texImage2D(gl.TEXTURE_2D,0,d.format,f,a,0,d.format,d.type,b)}catch(g){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";
}c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),d.has_mipmaps=!0);gl.bindTexture(d.texture_type,null);return d};Texture.fromDDSInMemory=function(f,a){a=a||{};var b=a.texture||new l.Texture(0,0,a);l.Texture.setUploadOptions(a);b.bind();var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");S.loadDDSTextureFromMemoryEx(gl,c,f,b,!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromShader=
function(f,a,b,c){c=c||{};f=new l.Texture(f,a,c);f.drawTo(function(){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var a=Mesh.getScreenQuad();b.draw(a)});return f};Texture.cubemapFromImages=function(f,a){a=a||{};if(6!=f.length)throw"missing images to create cubemap";var b=f[0].width,c=f[0].height;a.texture_type=gl.TEXTURE_CUBE_MAP;b=a.texture||new Texture(b,c,a);Texture.setUploadOptions(a);b.bind();try{for(c=0;6>c;c++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,b.format,
b.format,b.type,f[c])}catch(d){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),b.has_mipmaps=!0);b.unbind();return b};Texture.cubemapFromImage=function(f,a){a=a||{};if(f.width!=f.height/6&&0!=
f.height%6)console.log("Texture not valid, size doesnt match a cubemap");else{for(var b=f.height/6,c=[],d=0;6>d;d++){var g=createCanvas(f.width,b);g.getContext("2d").drawImage(f,0,b*d,f.width,b,0,0,f.width,b);c.push(g)}return Texture.cubemapFromImages(c,a)}};Texture.cubemapFromURL=function(f,a,b){a=a||{};a.texture_type=gl.TEXTURE_CUBE_MAP;var c=a.texture||new l.Texture(1,1,a);c.bind();Texture.setUploadOptions(a);for(var d=a.temp_color||[0,0,0,255],d=a.type==gl.FLOAT?new Float32Array(d):new Uint8Array(d),
g=0;6>g;g++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+g,0,c.format,1,1,0,c.format,c.type,d);gl.bindTexture(c.texture_type,null);c.ready=!1;d=new Image;d.src=f;d.onload=function(){a.texture=c;l.Texture.cubemapFromImage(this,a);c.ready=!0;b&&b(c)};return c};Texture.prototype.toBlob=function(){var f=this.width,a=this.height;if(this.texture_type==gl.TEXTURE_CUBE_MAP){if(this.image){var b=createCanvas(this.image.width,this.image.height),c=b.getContext("2d");c.drawImage(this.image,0,0);return b.toBlob()}console.warning("Litegl: cannot call toBlob of a cubemap GL.Texture");
return null}var d=new Uint8Array(f*a*4);this.drawTo(function(){gl.readPixels(0,0,f,a,gl.RGBA,gl.UNSIGNED_BYTE,d)});var g=createCanvas(f,a);if(!g.toBlob)throw"toBlob not supported on Canvas element";b=g.getContext("2d");c=b.getImageData(0,0,f,a);c.data.set(d);b.putImageData(c,0,0);b=createCanvas(f,a);c=b.getContext("2d");c.translate(0,b.height);c.scale(1,-1);c.drawImage(g,0,0);return b.toBlob()};Texture.prototype.toBase64=function(){var f=this.width,a=this.height,b=new Uint8Array(f*a*4);this.drawTo(function(){gl.readPixels(0,
0,f,a,gl.RGBA,gl.UNSIGNED_BYTE,b)});var c=createCanvas(f,a),d=c.getContext("2d"),g=d.getImageData(0,0,f,a);g.data.set(b);d.putImageData(g,0,0);return c.toDataURL("image/png")};Texture.prototype.generateMetadata=function(){var f={};f.width=this.width;f.height=this.height;this.metadata=f};Texture.compareFormats=function(f,a){return f&&a?f==a?!0:f.width!=a.width||f.height!=a.height||f.type!=a.type||f.texture_type!=a.texture_type?!1:!0:!1};Texture.getWhiteTexture=function(){var f=this.gl,a=f.textures[":white"];
if(a)return a;a=new Uint8Array([255,255,255,255]);return f.textures[":white"]=new l.Texture(1,1,{pixel_data:a})};Texture.getBlackTexture=function(){var f=this.gl,a=f.textures[":black"];if(a)return a;a=new Uint8Array([0,0,0,255]);return f.textures[":black"]=new l.Texture(1,1,{pixel_data:a})};p.Shader=l.Shader=function a(b,c,d){this._context_id=p.gl.context_id;var g=this.gl=p.gl,h="";if(d)for(var k in d)h+="#define "+k+" "+(d[k]?d[k]:"")+"\n";this.program=g.createProgram();g.attachShader(this.program,
a.compileSource(g.VERTEX_SHADER,h+b),g);g.attachShader(this.program,a.compileSource(g.FRAGMENT_SHADER,h+c),g);g.linkProgram(this.program);if(!g.getProgramParameter(this.program,g.LINK_STATUS))throw"link error: "+g.getProgramInfoLog(this.program);this.attributes={};this.uniformInfo={};this.samplers={};this.extractShaderInfo()};Shader.compileSource=function(a,b,c){c=c||p.gl;var d=c.createShader(a);c.shaderSource(d,b);c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS))throw(a==c.VERTEX_SHADER?
"Vertex":"Fragment")+" shader compile error: "+c.getShaderInfoLog(d);return d};Shader.prototype.extractShaderInfo=function(){for(var a=this.gl,b=0,c=a.getProgramParameter(this.program,a.ACTIVE_UNIFORMS);b<c;++b){var d=a.getActiveUniform(this.program,b);if(!d)break;var g=d.name,h=g.indexOf("[");-1!=h&&-1==g.indexOf("].")&&(g=g.substr(0,h));if(d.type==a.SAMPLER_2D||d.type==a.SAMPLER_CUBE)this.samplers[g]=d.type;var h=Shader.getUniformFunc(d),k=!1;if(d.type==a.FLOAT_MAT2||d.type==a.FLOAT_MAT3||d.type==
a.FLOAT_MAT4)k=!0;this.uniformInfo[g]={type:d.type,func:h,size:d.size,is_matrix:k,loc:a.getUniformLocation(this.program,g)}}b=0;for(c=a.getProgramParameter(this.program,a.ACTIVE_ATTRIBUTES);b<c;++b){d=a.getActiveAttrib(this.program,b);if(!d)break;h=Shader.getUniformFunc(d);this.uniformInfo[d.name]={type:d.type,func:h,size:d.size,loc:a.getUniformLocation(this.program,d.name)};this.attributes[d.name]=a.getAttribLocation(this.program,d.name)}};Shader.prototype.hasUniform=function(a){return this.uniformInfo[a]};
Shader.prototype.hasAttribute=function(a){return this.attributes[a]};Shader.getUniformFunc=function(a){var b=null;switch(a.type){case gl.FLOAT:b=1==a.size?gl.uniform1f:gl.uniform1fv;break;case gl.FLOAT_MAT2:b=gl.uniformMatrix2fv;break;case gl.FLOAT_MAT3:b=gl.uniformMatrix3fv;break;case gl.FLOAT_MAT4:b=gl.uniformMatrix4fv;break;case gl.FLOAT_VEC2:b=gl.uniform2fv;break;case gl.FLOAT_VEC3:b=gl.uniform3fv;break;case gl.FLOAT_VEC4:b=gl.uniform4fv;break;case gl.UNSIGNED_INT:case gl.INT:b=1==a.size?gl.uniform1i:
gl.uniform1iv;break;case gl.INT_VEC2:b=gl.uniform2iv;break;case gl.INT_VEC3:b=gl.uniform3iv;break;case gl.INT_VEC4:b=gl.uniform4iv;break;case gl.SAMPLER_2D:case gl.SAMPLER_CUBE:b=gl.uniform1i;break;default:b=gl.uniform1f}return b};Shader.fromURL=function(a,b,c){function d(){var a=new l.Shader(h,k),b;for(b in a)g[b]=a[b];g.ready=!0}var g=new l.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t",
"\n\t\t\tprecision highp float;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t");g.ready=!1;var h=null,k=null;HttpRequest(a,null,function(a){h=a;k&&d()});HttpRequest(b,null,function(a){k=a;h&&d()});return g};Shader._temp_uniform=new Float32Array(16);Shader.prototype.uniforms=function(a){var b=this.gl;b.useProgram(this.program);for(var c in a){var d=this.uniformInfo[c];if(d){var g=a[c];null!=g&&(g.constructor===Array&&(g=new Float32Array(g)),d.is_matrix?d.func.call(b,
d.loc,!1,g):d.func.call(b,d.loc,g))}}return this};Shader.prototype.draw=function(a,b){this.drawBuffers(a.vertexBuffers,a.indexBuffers[b==gl.LINES?"lines":"triangles"],2>arguments.length?gl.TRIANGLES:b)};Shader.prototype.drawRange=function(a,b,c,d){this.drawBuffers(a.vertexBuffers,a.indexBuffers[b==gl.LINES?"lines":"triangles"],b,c,d)};var R=new Uint8Array(16),T=new Uint8Array(16);Shader.prototype.drawBuffers=function(a,b,c,d,g){if(0!=g){var h=this.gl;h.useProgram(this.program);var k=0;R.set(T);for(var l in a){var n=
a[l],m=n.attribute||l,p=this.attributes[m];null!=p&&n.buffer&&(R[p]=1,h.bindBuffer(h.ARRAY_BUFFER,n.buffer),h.enableVertexAttribArray(p),h.vertexAttribPointer(p,n.buffer.spacing,n.buffer.gl_type,!1,0,0),k=n.buffer.length/n.buffer.spacing)}a=0;0<d&&(a=d*(b?b.constructor.BYTES_PER_ELEMENT:1));0<g?k=g:b&&(k=b.buffer.length-a);for(m in this.attributes)p=this.attributes[m],R[p]||h.disableVertexAttribArray(this.attributes[m]);!k||b&&!b.buffer||(b?(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,b.buffer),h.drawElements(c,
k,h.UNSIGNED_SHORT,a),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null)):h.drawArrays(c,a,k));return this}};Shader.expandImports=function(a,b){b=b||Shader.files;var c={};if(!b)throw"Shader.files not initialized, assign files there";return a.replace(/#import\s+\"([a-zA-Z0-9_\.]+)\"\s*\n/g,function(a){a=a.split('"')[1];if(c[a])return"//already imported: "+a+"\n";var g=b[a];c[a]=!0;return g?g:"//import code not found: "+a+"\n"})};Shader.SCREEN_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t";
Shader.SCREEN_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.SCREEN_FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.QUAD_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = vec2(a_coord.x, 1.0 - a_coord.y); \n\t\t\t\tvec3 pos = vec3(u_position + a_coord * u_size, 1.0);\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";
Shader.QUAD_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.PRIMITIVE2D_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";
Shader.prototype.toViewport=function(a){var b=Mesh.getScreenQuad();a&&this.uniforms(a);this.draw(b)};Shader.getScreenShader=function(a){a=a||p.gl;var b=a.shaders[":screen"];return b?b:a.shaders[":screen"]=new l.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER)};Shader.getQuadShader=function(a){a=a||p.gl;var b=a.shaders[":quad"];return b?b:a.shaders[":quad"]=new l.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD_FRAGMENT_SHADER)};Shader.getBlurShader=function(a){a=a||p.gl;var b=a.shaders[":blur"];
if(b)return b;b=new l.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur"]=b};Shader.getFXAAShader=function(a){a=a||p.gl;var b=a.shaders[":fxaa"];if(b)return b;b=new l.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_viewportSize;\n\t\t\tuniform vec2 u_iViewprojection;\n\t\t\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t\t\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t\t\t#define FXAA_SPAN_MAX     8.0\n\t\t\t\n\t\t\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\t\t\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t\t\t{\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\t/*vec2 u_iViewprojection = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/\n\t\t\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewprojection).xyz;\n\t\t\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewprojection).xyz;\n\t\t\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewprojection).xyz;\n\t\t\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewprojection).xyz;\n\t\t\t\tvec3 rgbM  = texture2D(tex, fragCoord  * u_iViewprojection).xyz;\n\t\t\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\t\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\t\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\t\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\t\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\t\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\t\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\t\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\t\t\n\t\t\t\tvec2 dir;\n\t\t\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\t\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\t\t\n\t\t\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\t\t\n\t\t\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\t\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewprojection;\n\t\t\t\t\n\t\t\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewprojection + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\t\t\ttexture2D(tex, fragCoord * u_iViewprojection + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\t\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewprojection + dir * -0.5).xyz + \n\t\t\t\t\ttexture2D(tex, fragCoord * u_iViewprojection + dir * 0.5).xyz);\n\t\t\t\t\n\t\t\t\treturn vec4(rgbA,1.0);\n\t\t\t\tfloat lumaB = dot(rgbB, luma);\n\t\t\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\t\t\tcolor = vec4(rgbA, 1.0);\n\t\t\t\telse\n\t\t\t\t\tcolor = vec4(rgbB, 1.0);\n\t\t\t\treturn color;\n\t\t\t}\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;\n\t\t\t}\n\t\t\t");
return a.shaders[":fxaa"]=b};l.create=function(a){function b(a){var c=m.mouse_buttons;l.augmentEvent(a,k);a.eventType=a.eventType||a.type;var d=getTime();if("mousedown"==a.eventType){if(0==c&&(k.removeEventListener("mousemove",b),document.addEventListener("mousemove",b),document.addEventListener("mouseup",b)),u=d,m.onmousedown)m.onmousedown(a)}else{if("mousemove"==a.eventType&&m.onmousemove){a.click_time=d-u;m.onmousemove(a);return}if("mouseup"==a.eventType){if(0==m.mouse_buttons&&(k.addEventListener("mousemove",
b),document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",b)),a.click_time=d-u,u=d,m.onmouseup)m.onmouseup(a)}else!m.onmousewheel||"mousewheel"!=a.eventType&&"wheel"!=a.eventType&&"DOMMouseScroll"!=a.eventType||(a.eventType="mousewheel",a.wheel="wheel"==a.type?-a.deltaY:null!=a.wheelDeltaY?a.wheelDeltaY:-60*a.detail,m.onmousewheel(a))}a.stopPropagation();a.preventDefault();return!1}function c(a){var b=event.changedTouches;a=b[0];var c="";if(!(1<b)){switch(event.type){case "touchstart":c=
"mousedown";break;case "touchmove":c="mousemove";break;case "touchend":c="mouseup";break;default:return}b=document.createEvent("MouseEvent");b.initMouseEvent(c,!0,!0,window,1,a.screenX,a.screenY,a.clientX,a.clientY,!1,!1,!1,!1,0,null);a.target.dispatchEvent(b);event.preventDefault()}}function d(a){m.ongesture&&(a.eventType=a.type,m.ongesture(a));event.preventDefault()}function g(a,b){a.eventType=a.type;var c=a.target.nodeName.toLowerCase();if("input"!=c&&"textarea"!=c&&"select"!=c){a.character=String.fromCharCode(a.keyCode).toLowerCase();
var c=!1,d=l.mapKeyCode(a.keyCode);a.altKey||a.ctrlKey||a.metaKey||(d&&(m.keys[d]="keydown"==a.type),c=m.keys[a.keyCode],m.keys[a.keyCode]="keydown"==a.type);if(c!=m.keys[a.keyCode])if("keydown"==a.type&&m.onkeydown)m.onkeydown(a);else if("keyup"==a.type&&m.onkeyup)m.onkeyup(a);b&&(a.isChar||l.blockable_keys[a.keyIdentifier||a.key])&&a.preventDefault()}}function h(a,b){console.log(a);if(b&&m.onbuttondown)m.onbuttondown(a);else if(!b&&m.onbuttonup)m.onbuttonup(a)}a=a||{};var k=null;if(a.canvas)if("string"==
typeof a.canvas){if(k=document.getElementById(a.canvas),!k)throw"Canvas element not found: "+a.canvas;}else k=a.canvas;else k=createCanvas(a.width||800,a.height||600);"alpha"in a||(a.alpha=!1);try{p.gl=k.getContext("webgl",a)}catch(r){}try{p.gl=p.gl||k.getContext("experimental-webgl",a)}catch(n){}if(!p.gl)throw"WebGL not supported";var m=p.gl;k.is_webgl=!0;m.context_id=this.last_context_id++;m.derivatives_supported=m.getExtension("OES_standard_derivatives")||!1;m.depth_ext=m.getExtension("WEBGL_depth_texture")||
m.getExtension("WEBKIT_WEBGL_depth_texture")||m.getExtension("MOZ_WEBGL_depth_texture");m.float_ext=m.getExtension("OES_texture_float");m.float_ext_linear=m.getExtension("OES_texture_float_linear");m.half_float_ext=m.getExtension("OES_texture_half_float");m.half_float_ext_linear=m.getExtension("OES_texture_half_float_linear");m.half_float_ext_linear||(m.half_float_ext=null);m.HALF_FLOAT_OES=36193;m.half_float_ext&&(m.HALF_FLOAT_OES=m.half_float_ext.HALF_FLOAT_OES);m.max_texture_units=m.getParameter(m.MAX_TEXTURE_IMAGE_UNITS);
m.HIGH_PRECISION_FORMAT=m.half_float_ext?m.HALF_FLOAT_OES:m.float_ext?m.FLOAT:m.UNSIGNED_BYTE;m._viewport_func=m.viewport;m.viewport_data=new Float32Array([0,0,m.canvas.width,m.canvas.height]);m.viewport=function(a,b,c,d){this.viewport_data.set([a,b,c,d]);this._viewport_func(a,b,c,d)};m.getViewport=function(){return new Float32Array(m.viewport_data)};if("undefined"==typeof glMatrix)throw"glMatrix not found, LiteGL requires glMatrix to be included";var u=0;m.mouse_buttons=0;m.shaders={};m.textures=
{};m.meshes={};m.makeCurrent=function(){p.gl=this};m.execute=function(a){var b=p.gl;p.gl=this;a();p.gl=b};m.animate=function(){function a(){b(a);var g=getTime(),h=(g-c)/1E3;if(d.onupdate)d.onupdate(h);if(d.ondraw)d.ondraw();c=g}var b=p.requestAnimationFrame,c=getTime(),d=this;b(a)};m.captureMouse=function(a){k.addEventListener("mousedown",b);k.addEventListener("mousemove",b);a&&(k.addEventListener("mousewheel",b,!1),k.addEventListener("wheel",b,!1));k.addEventListener("contextmenu",function(a){a.preventDefault();
return!1});k.addEventListener("touchstart",c,!0);k.addEventListener("touchmove",c,!0);k.addEventListener("touchend",c,!0);k.addEventListener("touchcancel",c,!0);k.addEventListener("gesturestart",d);k.addEventListener("gesturechange",d);k.addEventListener("gestureend",d)};m.captureKeys=function(a){m.keys={};document.addEventListener("keydown",function(b){g(b,a)});document.addEventListener("keyup",function(b){g(b,a)})};m.gamepads=null;m.captureGamepads=function(){var a=navigator.getGamepads||navigator.webkitGetGamepads||
navigator.mozGetGamepads;a&&(this.gamepads=a.call(navigator),window.addEventListener("gamepadButtonDown",function(a){h(a,!0)},!1),window.addEventListener("MozGamepadButtonDown",function(a){h(a,!0)},!1),window.addEventListener("WebkitGamepadButtonDown",function(a){h(a,!0)},!1),window.addEventListener("gamepadButtonUp",function(a){h(a,!1)},!1),window.addEventListener("MozGamepadButtonUp",function(a){h(a,!1)},!1),window.addEventListener("WebkitGamepadButtonUp",function(a){h(a,!1)},!1))};m.getGamepads=
function(){var a=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(a){for(var a=a.call(navigator),b=null,c=0;4>c;c++)if(a[c]&&(b=a[c],this.gamepads))if(!this.gamepads[c]&&a[c]&&this.ongamepadconnected)this.ongamepadconnected(b);else if(this.gamepads[c]&&!a[c]&&this.ongamepaddisconnected)this.ongamepaddisconnected(this.gamepads[c]);return this.gamepads=a}};m.fullscreen=function(){var a=this.canvas;a.requestFullScreen?a.requestFullScreen():a.webkitRequestFullScreen?a.webkitRequestFullScreen():
a.mozRequestFullScreen?a.mozRequestFullScreen():console.error("Fullscreen not supported")};m.snapshot=function(a,b,c,d,g){var h=createCanvas(c,d),k=h.getContext("2d"),l=k.getImageData(0,0,h.width,h.height),n=new Uint8Array(c*d*4);m.readPixels(a,b,h.width,h.height,m.RGBA,m.UNSIGNED_BYTE,n);l.data.set(n);k.putImageData(l,0,0);if(g)return h;a=createCanvas(c,d);k=a.getContext("2d");k.translate(0,d);k.scale(1,-1);k.drawImage(h,0,0);return a};var q={};m.loadTexture=function(a,b,c){if(this.textures[a])return this.textures[a];
if(q[a])return null;var d=new Image;d.url=a;d.onload=function(){var a=l.Texture.fromImage(this,b);a.img=this;m.textures[this.url]=a;delete q[this.url];c&&c(a)};d.src=a;q[a]=!0;return null};return m};l.mapKeyCode=function(a){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[a]||(65<=a&&90>=a?String.fromCharCode(a):null)};l.dragging=!1;l.last_pos=null;l.augmentEvent=function(a,b){var c=null;b=b||a.target||gl.canvas;c=b.getBoundingClientRect();
a.mousex=a.pageX-c.left;a.mousey=a.pageY-c.top;a.canvasx=a.mousex;a.canvasy=c.height-a.mousey;a.deltax=0;a.deltay=0;"mousedown"==a.type?(this.dragging=!0,gl.mouse_buttons|=1<<a.which):"mousemove"!=a.type&&"mouseup"==a.type&&(gl.mouse_buttons&=~(1<<a.which),0==gl.mouse_buttons&&(this.dragging=!1));this.last_pos&&(a.deltax=a.mousex-this.last_pos[0],a.deltay=a.mousey-this.last_pos[1]);this.last_pos=[a.mousex,a.mousey];a.dragging=this.dragging;a.buttons_mask=gl.mouse_buttons;a.leftButton=gl.mouse_buttons&
1<<l.LEFT_MOUSE_BUTTON;a.rightButton=gl.mouse_buttons&1<<l.RIGHT_MOUSE_BUTTON;a.isButtonPressed=function(a){return this.buttons_mask&1<<a}};p.LEvent=l.LEvent={jQuery:!1,bind:function(a,b,c,d){if(!a)throw"cannot bind event to null";if(!c)throw"cannot bind to null callback";if(a.constructor===String)throw"cannot bind event to a string";a.hasOwnProperty("__on_"+b)?a["__on_"+b].push([c,d]):a["__on_"+b]=[[c,d]]},unbind:function(a,b,c,d){if(!a)throw"cannot unbind event to null";if(!c)throw"cannot unbind from null callback";
if(a.constructor===String)throw"cannot bind event to a string";if(a.hasOwnProperty("__on_"+b)){for(var g in a["__on_"+b]){var h=a["__on_"+b][g];if(h[0]===c&&h[1]===d){a["__on_"+b].splice(g,1);break}}0==a["__on_"+b].length&&delete a["__on_"+b]}},unbindAll:function(a,b){if(!a)throw"cannot unbind events in null";if(!b){var c=[],d;for(d in a)"__on_"==d.substring(0,5)&&c.push(d);for(d in c)delete a[remove[d]]}else for(d in a)if("__on_"==d.substring(0,5)){for(var c=a[d],g=0;g<c.length;++g)c[g][1]==b&&(c.splice(g,
1),--g);0==c.length&&delete a[d]}},isBind:function(a,b,c,d){if(!a||!a.hasOwnProperty("__on_"+b))return!1;for(var g in a["__on_"+b]){var h=a["__on_"+b][g];if(h[0]===c&&h[1]===d)return!0}return!1},trigger:function(a,b,c,d){if(!a)throw"cannot trigger event from null";if(a.constructor===String)throw"cannot bind event to a string";LEvent.jQuery&&!d&&$(a).trigger(":"+b,c);if(a.hasOwnProperty("__on_"+b))for(var g in a["__on_"+b])if(d=a["__on_"+b][g],!1==d[0].call(d[1],b,c))break},triggerArray:function(a,
b,c,d){for(var g in a){var h=a[g];if(!h)throw"cannot trigger event from null";if(h.constructor===String)throw"cannot bind event to a string";LEvent.jQuery&&!d&&$(h).trigger(":"+b,c);if(h.hasOwnProperty("__on_"+b))for(g in h["__on_"+b]){var k=h["__on_"+b][g];if(!1==k[0].call(k[1],b,c))break}}}};p.CLIP_INSIDE=l.CLIP_INSIDE=0;p.CLIP_OUTSIDE=l.CLIP_OUTSIDE=1;p.CLIP_OVERLAP=l.CLIP_OVERLAP=2;p.geo={createPlane:function(a,b){return new Float32Array([b[0],b[1],b[2],-vec3.dot(a,b)])},distancePointToPlane:function(a,
b){return(vec3.dot(a,b)+b[3])/Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},distance2PointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},projectPointOnPlane:function(a,b,c,d){d=d||vec3.create();b=vec3.subtract(vec3.create(),a,b);b=vec3.dot(b,c);return vec3.subtract(d,a,vec3.scale(vec3.create(),c,b))},reflectPointInPlane:function(a,b,c){b=-(-1*(b[0]*c[0]+b[1]*c[1]+b[2]*c[2])+c[0]*a[0]+c[1]*a[1]+c[2]*a[2])/(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);return vec3.fromValues(a[0]+b*
c[0]*2,a[1]+b*c[1]*2,a[2]+b*c[2]*2)},testRayPlane:function(a,b,c,d,g){c=vec3.dot(c,d)-vec3.dot(d,a);d=vec3.dot(d,b);if(Math.abs(d)<EPSILON)return!1;d=c/d;if(0>d)return!1;g&&vec3.add(g,a,vec3.scale(g,b,d));return!0},testSegmentPlane:function(a,b,c,d,g){c=vec3.dot(c,d)-vec3.dot(d,a);b=vec3.sub(vec3.create(),b,a);d=vec3.dot(d,b);if(Math.abs(d)<EPSILON)return!1;d=c/d;if(0>d||1<d)return!1;g&&vec3.add(g,a,vec3.scale(g,b,d));return!0},testRaySphere:function(a,b,c,d,g){var h=vec3.subtract(vec3.create(),a,
c),k=b[0]*b[0]+b[1]*b[1]+b[2]*b[2];c=2*h[0]*b[0]+2*h[1]*b[1]+2*h[2]*b[2];d=c*c-4*k*(h[0]*h[0]+h[1]*h[1]+h[2]*h[2]-d*d);if(0>d)return!1;g&&(d=Math.sqrt(d),h=1/(2*k),k=(-c+d)*h,c=(-c-d)*h,c=k<c?k:c,vec3.add(g,a,vec3.scale(vec3.create(),b,c)));return!0},testRayCylinder:function(a,b,c,d,g,h){var k=vec3.clone(a);a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,1E5));var l=0;b=vec3.subtract(vec3.create(),d,c);var n=vec3.subtract(vec3.create(),k,c);c=vec3.subtract(vec3.create(),a,k);d=vec3.dot(n,b);
a=vec3.dot(c,b);b=vec3.dot(b,b);if(0>d&&0>d+a||d>b&&d+a>b)return!1;var m=vec3.dot(c,c),p=vec3.dot(n,c),l=b*m-a*a;g=vec3.dot(n,n)-g*g;var q=b*g-d*d;if(Math.abs(l)<EPSILON){if(0<q)return!1;l=0>d?-p/m:d>b?(a-p)/m:0;h&&vec3.add(h,k,vec3.scale(vec3.create(),c,l));return!0}n=b*p-a*d;q=n*n-l*q;if(0>q)return!1;l=(-n-Math.sqrt(q))/l;if(0>l||1<l)return!1;if(0>d+l*a){if(0>=a)return!1;l=-d/a;h&&vec3.add(h,k,vec3.scale(vec3.create(),c,l));return 0>=g+2*l*(p+l*m)}if(d+l*a>b){if(0<=a)return!1;l=(b-d)/a;h&&vec3.add(h,
k,vec3.scale(vec3.create(),c,l));return 0>=g+b-2*d+l*(2*(p-a)+l*m)}h&&vec3.add(h,k,vec3.scale(vec3.create(),c,l));return!0},testRayBox:function(a,b,c,d,g,h){g=g||vec3.create();h=h||Number.MAX_VALUE;for(var k=!0,l=new Float32Array(3),n=0,m=new Float32Array(3),p=new Float32Array(3),n=0;3>n;++n)a[n]<c[n]?(l[n]=1,p[n]=c[n],k=!1):a[n]>d[n]?(l[n]=0,p[n]=d[n],k=!1):l[n]=2;if(k)return vec3.copy(g,a),!0;for(n=0;3>n;++n)m[n]=2!=l[n]&&0!=b[n]?(p[n]-a[n])/b[n]:-1;k=0;for(n=1;3>n;n++)m[k]<m[n]&&(k=n);if(0>m[k]||
m[k]>h)return!1;for(n=0;3>n;++n)if(k!=n){if(g[n]=a[n]+m[k]*b[n],g[n]<c[n]||g[n]>d[n])return!1}else g[n]=p[n];return!0},testRayBBox:function(a,b,c,d,g,h){if(d){var k=mat4.invert(mat4.create(),d);b=vec3.add(vec3.create(),a,b);a=vec3.transformMat4(vec3.create(),a,k);vec3.transformMat4(b,b,k);vec3.sub(b,b,a);b=vec3.normalize(b,b)}a=this.testRayBox(a,b,c.subarray(6,9),c.subarray(9,12),g,h);d&&vec3.transformMat4(g,g,d);return a},testPointBBox:function(a,b){return a[0]<b[6]||a[0]>b[9]||a[1]<b[7]||a[0]>b[10]||
a[2]<b[8]||a[0]>b[11]?!1:!0},testBBoxBBox:function(a,b){if(Math.abs(b[0]-a[0])>a[3]+b[3]||Math.abs(b[1]-a[1])>a[4]+b[4]||Math.abs(b[2]-a[2])>a[5]+b[5])return!1;var c=BBox.getMin(b);geo.testPointBBox(c,a)&&(c=BBox.getMax(b),geo.testPointBBox(c,a));return!0},testSphereBBox:function(a,b,c){for(var d=0,g=BBox.getMin(c),h=BBox.getMax(c),k=0;3>k;++k)a[k]<g[k]?(c=a[k]-g[k],d+=c*c):a[k]>h[k]&&(c=a[k]-h[k],d+=c*c);return d<=b*b?!0:!1},closestPointBetweenLines:function(a,b,c,d,g,h){b=vec3.subtract(vec3.create(),
b,a);d=vec3.subtract(vec3.create(),d,c);var k=vec3.subtract(vec3.create(),a,c),l=vec3.dot(b,b),n=vec3.dot(b,d),m=vec3.dot(d,d),p=vec3.dot(b,k),q=vec3.dot(d,k),s=l*m-n*n,t;s<EPSILON?(t=0,l=n>m?p/n:q/m):(t=(n*q-m*p)/s,l=(l*q-n*p)/s);g&&vec3.add(g,a,vec3.scale(vec3.create(),b,t));h&&vec3.add(h,c,vec3.scale(vec3.create(),d,l));a=vec3.add(vec3.create(),k,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),b,t),vec3.scale(vec3.create(),d,l)));return vec3.length(a)},extractPlanes:function(a,b){function c(a){var c=
b.subarray(a,a+3),c=vec3.length(c);c||(c=1/c,b[a]*=c,b[a+1]*=c,b[a+2]*=c,b[a+3]*=c)}b=b||new Float32Array(24);b.set([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]],0);c(0);b.set([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]],4);c(4);b.set([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]],8);c(8);b.set([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]],12);c(12);b.set([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]],16);c(16);b.set([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]],20);c(20);return b},frustumTestBox:function(a,
b){var c=0,d=0,c=planeBoxOverlap(a.subarray(0,4),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(4,8),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(8,12),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(12,16),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(16,20),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(20,24),b);return c==CLIP_OUTSIDE?CLIP_OUTSIDE:0==
d+c?CLIP_INSIDE:CLIP_OVERLAP},frustumTestSphere:function(a,b,c){var d,g=!1;d=distanceToPlane(a.subarray(0,4),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(4,8),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(8,12),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(12,16),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(16,20),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=
!0);d=distanceToPlane(a.subarray(20,24),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);return g?CLIP_OVERLAP:CLIP_INSIDE},testPoint2DInPolygon:function(a,b){for(var c=!1,d=-1,g=a.length,h=g-1;++d<g;h=d)(a[d][1]<=b[1]&&b[1]<a[h][1]||a[h][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[h][0]-a[d][0])*(b[1]-a[d][1])/(a[h][1]-a[d][1])+a[d][0]&&(c=!c);return c}};p.BBox=l.BBox={center:0,halfsize:3,min:6,max:9,radius:12,data_length:13,corners:new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,
-1,-1]),create:function(){return new Float32Array(13)},clone:function(a){return new Float32Array(a)},copy:function(a,b){a.set(b);return a},fromPoint:function(a){var b=this.create();b.set(a,0);b.set(a,6);b.set(a,9);return b},fromMinMax:function(a,b){var c=this.create();this.setMinMax(c,a,b);return c},fromCenterHalfsize:function(a,b){var c=this.create();this.setCenterHalfsize(c,a,b);return c},fromPoints:function(a){var b=this.create();this.setFromPoints(b,a);return b},setFromPoints:function(a,b){var c=
a.subarray(6,9),d=a.subarray(9,12);c.set(b.subarray(0,3));d.set(b.subarray(0,3));for(var g=0,h=3;h<b.length;h+=3)g=b.subarray(h,h+3),vec3.min(c,g,c),vec3.max(d,g,d);c=vec3.add(a.subarray(0,3),c,d);vec3.scale(c,c,0.5);vec3.subtract(a.subarray(3,6),d,c);a[12]=vec3.length(a.subarray(3,6));return a},setMinMax:function(a,b,c){a[6]=b[0];a[7]=b[1];a[8]=b[2];a[9]=c[0];a[10]=c[1];a[11]=c[2];var d=a.subarray(0,3);vec3.sub(d,c,b);vec3.scale(d,d,0.5);a.set([c[0]-d[0],c[1]-d[1],c[2]-d[2]],3);vec3.sub(a.subarray(3,
6),c,d);a[12]=vec3.length(a.subarray(3,6));return a},setCenterHalfsize:function(a,b,c,d){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=c[0];a[4]=c[1];a[5]=c[2];vec3.sub(a.subarray(6,9),a.subarray(0,3),a.subarray(3,6));vec3.add(a.subarray(9,12),a.subarray(0,3),a.subarray(3,6));a[12]=d?d:vec3.length(c);return a},transformMat4:function(a,b,c){var d=b.subarray(0,3);b=b.subarray(3,6);for(var g=new Float32Array(this.corners),h=0;8>h;++h){var k=g.subarray(3*h,3*h+3);vec3.multiply(k,b,k);vec3.add(k,k,d);mat4.multiplyVec3(k,
c,k)}return this.setFromPoints(a,g)},getCorners:function(a,b){var c=a.subarray(0,3),d=a.subarray(3,6),g=null;b?(b.set(this.corners),g=b):g=new Float32Array(this.corners);for(var h=0;8>h;++h){var k=g.subarray(3*h,3*h+3);vec3.multiply(k,d,k);vec3.add(k,k,c)}return g},getCenter:function(a){return a.subarray(0,3)},getHalfsize:function(a){return a.subarray(3,6)},getMin:function(a){return a.subarray(6,9)},getMax:function(a){return a.subarray(9,12)},getRadius:function(a){return a[12]}};p.distanceToPlane=
l.distanceToPlane=function(a,b){return vec3.dot(a,b)+a[3]};p.planeBoxOverlap=l.planeBoxOverlap=function(a,b){var c=a.subarray(0,3),d=a[3],g=b.subarray(0,3),h=b.subarray(3,6),h=vec3.fromValues(Math.abs(h[0]*c[0]),Math.abs(h[1]*c[1]),Math.abs(h[2]*c[2])),h=h[0]+h[1]+h[2],c=vec3.dot(c,g)+d;return c<=-h?CLIP_OUTSIDE:c<=h?CLIP_OVERLAP:CLIP_INSIDE};p.Octree=l.Octree=function(a){this.root=null;this.total_nodes=this.total_depth=0;a&&(this.buildFromMesh(a),this.total_nodes=this.trim())};Octree.MAX_NODE_TRIANGLES_RATIO=
0.1;Octree.MAX_OCTREE_DEPTH=8;Octree.OCTREE_MARGIN_RATIO=0.01;Octree.OCTREE_MIN_MARGIN=0.1;Octree.prototype.buildFromMesh=function(a){this.total_nodes=this.total_depth=0;var b=a.getBuffer("vertices").data;if(a=a.getIndexBuffer("triangles"))a=a.data;var c=this.computeAABB(b);this.root=c;this.total_nodes=1;this.total_triangles=a?a.length/3:b.length/9;this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;var d=vec3.create();vec3.scale(d,c.size,Octree.OCTREE_MARGIN_RATIO);d[0]<
Octree.OCTREE_MIN_MARGIN&&(d[0]=Octree.OCTREE_MIN_MARGIN);d[1]<Octree.OCTREE_MIN_MARGIN&&(d[1]=Octree.OCTREE_MIN_MARGIN);d[2]<Octree.OCTREE_MIN_MARGIN&&(d[2]=Octree.OCTREE_MIN_MARGIN);vec3.sub(c.min,c.min,d);vec3.add(c.max,c.max,d);c.faces=[];c.inside=0;if(a)for(d=0;d<a.length;d+=3){var g=new Float32Array([b[3*a[d]],b[3*a[d]+1],b[3*a[d]+2],b[3*a[d+1]],b[3*a[d+1]+1],b[3*a[d+1]+2],b[3*a[d+2]],b[3*a[d+2]+1],b[3*a[d+2]+2]]);this.addToNode(g,c,0)}else for(d=0;d<b.length;d+=9)g=new Float32Array(b.subarray(d,
d+9)),this.addToNode(g,c,0);return c};Octree.prototype.addToNode=function(a,b,c){b.inside+=1;if(b.c){var d=this.computeAABB(a),g=!1,h;for(h in b.c){var k=b.c[h];if(Octree.isInsideAABB(d,k)){this.addToNode(a,k,c+1);g=!0;break}}g||(null==b.faces&&(b.faces=[]),b.faces.push(a))}else if(null==b.faces&&(b.faces=[]),b.faces.push(a),b.faces.length>this.max_node_triangles&&c<Octree.MAX_OCTREE_DEPTH){this.splitNode(b);this.total_depth<c+1&&(this.total_depth=c+1);var l=b.faces.concat();b.faces=null;for(h in l){a=
l[h];var d=this.computeAABB(a),g=!1,n;for(n in b.c)if(k=b.c[n],Octree.isInsideAABB(d,k)){this.addToNode(a,k,c+1);g=!0;break}g||(null==b.faces&&(b.faces=[]),b.faces.push(a))}}};Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]];Octree.prototype.splitNode=function(a){a.c=[];var b=[0.5*(a.max[0]-a.min[0]),0.5*(a.max[1]-a.min[1]),0.5*(a.max[2]-a.min[2])],c;for(c in this.octree_pos_ref){var d=this.octree_pos_ref[c],g={};this.total_nodes+=1;g.min=[a.min[0]+
b[0]*d[0],a.min[1]+b[1]*d[1],a.min[2]+b[2]*d[2]];g.max=[g.min[0]+b[0],g.min[1]+b[1],g.min[2]+b[2]];g.faces=null;g.inside=0;a.c.push(g)}};Octree.prototype.computeAABB=function(a){for(var b=new Float32Array([a[0],a[1],a[2]]),c=new Float32Array([a[0],a[1],a[2]]),d=0;d<a.length;d+=3)for(var g=0;3>g;g++)b[g]>a[d+g]&&(b[g]=a[d+g]),c[g]<a[d+g]&&(c[g]=a[d+g]);return{min:b,max:c,size:vec3.sub(vec3.create(),c,b)}};Octree.prototype.trim=function(a){a=a||this.root;if(!a.c)return 1;var b=1,c=[],d;for(d in a.c)a.c[d].inside&&
(c.push(a.c[d]),b+=this.trim(a.c[d]));a.c=c;return b};Octree.prototype.testRay=function(a,b,c,d){a=vec3.clone(a);b=vec3.clone(b);if(!this.root)throw"Error: octree not build";c=Octree.hitTestBox(a,b,vec3.clone(this.root.min),vec3.clone(this.root.max));if(!c)return null;c=Octree.testRayInNode(this.root,a,b);return null!=c?(b=vec3.scale(vec3.create(),b,c.t),vec3.add(b,b,a),c.pos=b,c):null};Octree.testRayInNode=function(a,b,c){var d=null,g=null;if(a.faces)for(var h=0,k=a.faces.length;h<k;++h)d=a.faces[h],
d=Octree.hitTestTriangle(b,c,d.subarray(0,3),d.subarray(3,6),d.subarray(6,9)),null!=d&&(g?g.mergeWith(d):g=d);if(a.c)for(h in a.c)k=a.c[h],d=Octree.hitTestBox(b,c,vec3.clone(k.min),vec3.clone(k.max)),null==d||g&&d.t>g.t||(d=Octree.testRayInNode(k,b,c),null!=d&&(g?g.mergeWith(d):g=d));return g};Octree.isInsideAABB=function(a,b){return a.min[0]<b.min[0]||a.min[1]<b.min[1]||a.min[2]<b.min[2]||a.max[0]>b.max[0]||a.max[1]>b.max[1]||a.max[2]>b.max[2]?!1:!0};Octree.hitTestBox=function(a,b,c,d){var g=vec3.subtract(vec3.create(),
c,a),h=vec3.subtract(vec3.create(),d,a);if(0>vec3.maxValue(g)&&0<vec3.minValue(h))return new HitTest(0,a,b);vec3.multiply(g,g,[1/b[0],1/b[1],1/b[2]]);vec3.multiply(h,h,[1/b[0],1/b[1],1/b[2]]);var k=vec3.min(vec3.create(),g,h),g=vec3.max(vec3.create(),g,h),k=vec3.maxValue(k),g=vec3.minValue(g);return 0<k&&k<g?(a=vec3.add(vec3.create(),vec3.scale(vec3.create(),b,k),a),vec3.add(c,c,[1E-6,1E-6,1E-6]),vec3.subtract(c,c,[1E-6,1E-6,1E-6]),new HitTest(k,a,vec3.fromValues((a[0]>d[0])-(a[0]<c[0]),(a[1]>d[1])-
(a[1]<c[1]),(a[2]>d[2])-(a[2]<c[2])))):null};Octree.hitTestTriangle=function(a,b,c,d,g){var h=vec3.subtract(vec3.create(),d,c),k=vec3.subtract(vec3.create(),g,c);g=vec3.cross(vec3.create(),h,k);vec3.normalize(g,g);if(!(0<vec3.dot(g,b))){d=vec3.dot(g,vec3.subtract(vec3.create(),c,a))/vec3.dot(g,b);if(0<d){b=vec3.scale(vec3.create(),b,d);vec3.add(b,b,a);var l=vec3.subtract(vec3.create(),b,c);a=vec3.dot(k,k);c=vec3.dot(k,h);var k=vec3.dot(k,l),n=vec3.dot(h,h),h=vec3.dot(h,l),l=a*n-c*c,n=(n*k-c*h)/l,
h=(a*h-c*k)/l;if(0<=n&&0<=h&&1>=n+h)return new HitTest(d,b,g)}return null}};p.HitTest=l.HitTest=function(a,b,c){this.t=arguments.length?a:Number.MAX_VALUE;this.hit=b;this.normal=c};HitTest.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal)}};p.Raytracer=l.Raytracer=function(a,b,c){this.viewport=c=c||gl.getViewport();var d=c[0],g=d+c[2],h=c[1],k=h+c[3];this.ray00=vec3.unproject(vec3.create(),vec3.fromValues(d,h,1),a,b,c);this.ray10=vec3.unproject(vec3.create(),
vec3.fromValues(g,h,1),a,b,c);this.ray01=vec3.unproject(vec3.create(),vec3.fromValues(d,k,1),a,b,c);this.ray11=vec3.unproject(vec3.create(),vec3.fromValues(g,k,1),a,b,c);d=this.eye=vec3.create();vec3.unproject(d,d,a,b,c);vec3.subtract(this.ray00,this.ray00,d);vec3.subtract(this.ray10,this.ray10,d);vec3.subtract(this.ray01,this.ray01,d);vec3.subtract(this.ray11,this.ray11,d)};Raytracer.prototype.getRayForPixel=function(a,b){a=(a-this.viewport[0])/this.viewport[2];b=1-(b-this.viewport[1])/this.viewport[3];
var c=vec3.lerp(vec3.create(),this.ray00,this.ray10,a),d=vec3.lerp(vec3.create(),this.ray01,this.ray11,a);return vec3.normalize(vec3.create(),vec3.lerp(vec3.create(),c,d,b))};var U=mat4.create();Raytracer.hitTestBox=function(a,b,c,d,g){var h=new Float32Array(30);g&&(g=mat4.invert(U,g),a=mat4.multiplyVec3(h.subarray(3,6),g,a),b=mat4.rotateVec3(h.subarray(6,9),g,b));var k=vec3.subtract(h.subarray(9,12),c,a);vec3.divide(k,k,b);var l=vec3.subtract(h.subarray(12,15),d,a);vec3.divide(l,l,b);g=vec3.min(h.subarray(15,
18),k,l);k=vec3.max(h.subarray(18,21),k,l);g=vec3.maxValue(g);k=vec3.minValue(k);return 0<g&&g<k?(b=vec3.scale(h.subarray(21,24),b,g),vec3.add(b,a,b),vec3.addValue(h.subarray(24,27),c,1E-6),vec3.subValue(h.subarray(27,30),d,1E-6),new HitTest(g,b,vec3.fromValues((b[0]>d[0])-(b[0]<c[0]),(b[1]>d[1])-(b[1]<c[1]),(b[2]>d[2])-(b[2]<c[2])))):null};Raytracer.hitTestSphere=function(a,b,c,d){var g=vec3.subtract(vec3.create(),a,c),h=vec3.dot(b,b),k=2*vec3.dot(b,g),g=vec3.dot(g,g)-d*d,g=k*k-4*h*g;return 0<g?
(h=(-k-Math.sqrt(g))/(2*h),a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,h)),new HitTest(h,a,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),a,c),1/d))):null};Raytracer.hitTestTriangle=function(a,b,c,d,g){var h=vec3.subtract(vec3.create(),d,c),k=vec3.subtract(vec3.create(),g,c);g=vec3.cross(vec3.create(),h,k);vec3.normalize(g,g);d=vec3.dot(g,vec3.subtract(vec3.create(),c,a))/vec3.dot(g,b);if(0<d){a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,d));var l=vec3.subtract(vec3.create(),
a,c);c=vec3.dot(k,k);b=vec3.dot(k,h);var k=vec3.dot(k,l),n=vec3.dot(h,h),h=vec3.dot(h,l),l=c*n-b*b,n=(n*k-b*h)/l,h=(c*h-b*k)/l;if(0<=n&&0<=h&&1>=n+h)return new HitTest(d,a,g)}return null};Mesh.parseOBJ=function(a,b){b=b||{};for(var c=[],d=[],g=[],h=[],k=[],l=[],n=[],m={},p=0,q=null,s=null,t=0,u=0,B=s=0,A=0,F=0,v=null,P=!1,I=!1,M=!1,K=!1,L=0,J=b.noindex?b.noindex:1E7<a.length?!0:!1,C=b.flipAxis,D=C||b.flipNormals,w=null,x=[],y=a.split("\n"),z=y.length,H=0;H<z;++H)if(q=y[H].replace(/[ \t]+/g," ").replace(/\s\s*$/,
""),"#"!=q[0]&&""!=q)if(v=q.split(" "),K&&"v"==v[0]&&(K=!1),"v"==v[0])C?k.push(-1*parseFloat(v[1]),parseFloat(v[3]),parseFloat(v[2])):k.push(parseFloat(v[1]),parseFloat(v[2]),parseFloat(v[3]));else if("vt"==v[0])l.push(parseFloat(v[1]),parseFloat(v[2]));else if("vn"==v[0])D?n.push(-parseFloat(v[2]),-parseFloat(v[3]),parseFloat(v[1])):n.push(parseFloat(v[1]),parseFloat(v[2]),parseFloat(v[3]));else if("f"==v[0]){if(K=!0,!(4>v.length)){for(var G=[],q=1;q<v.length;++q){if(!(v[q]in m)||J){s=v[q].split("/");
if(1==s.length)s=u=t=parseInt(s[0])-1;else if(2==s.length)t=parseInt(s[0])-1,u=parseInt(s[1])-1,s=-1;else if(3==s.length)t=parseInt(s[0])-1,u=parseInt(s[1])-1,s=parseInt(s[2])-1;else return console.err("Problem parsing: unknown number of values per face"),!1;F=A=B=0;3*t+2<k.length&&(P=!0,B=k[3*t+0],A=k[3*t+1],F=k[3*t+2]);c.push(B,A,F);A=B=0;2*u+1<l.length&&(I=!0,B=l[2*u+0],A=l[2*u+1]);d.push(B,A);A=B=0;F=1;-1!=s&&(3*s+2<n.length&&(M=!0,B=n[3*s+0],A=n[3*s+1],F=n[3*s+2]),g.push(B,A,F));J||(m[v[q]]=
p++)}J||(t=m[v[q]],G.push(t),L<t&&(L=t))}if(!J)for(q=2;q<G.length;q++)h.push(G[0],G[q-1],G[q])}}else"g"==v[0]||"usemtl"==v[0]?1<v.length&&(null!=w&&(w.length=h.length-w.start,0<w.length&&x.push(w)),w={name:v[1],start:h.length,length:-1,material:""}):"usemtl"==v[0]&&w&&(w.material=v[1]);if(!k.length)return console.error("OBJ doesnt have vertices, maybe the file is not a OBJ"),null;w&&1<h.length-w.start&&(w.length=h.length-w.start,x.push(w));if((65536<L||J)&&0<h.length){console.log("Deindexing mesh...");
k=new Float32Array(3*h.length);l=g&&g.length?new Float32Array(3*h.length):null;n=d&&d.length?new Float32Array(2*h.length):null;for(q=0;q<h.length;q+=1)k.set(c.slice(3*h[q],3*h[q]+3),3*q),l&&l.set(g.slice(3*h[q],3*h[q]+3),3*q),n&&n.set(d.slice(2*h[q],2*h[q]+2),2*q);c=k;l&&(g=l);n&&(d=n);h=null}q={};P&&(q.vertices=new Float32Array(c));M&&0<g.length&&(q.normals=new Float32Array(g));I&&0<d.length&&(q.coords=new Float32Array(d));h&&0<h.length&&(q.triangles=new Uint16Array(h));c={};1<x.length&&(c.groups=
x);q.info=c;x=null;x=Mesh.load(q,null,b.mesh);x.updateBounding();return x};Mesh.parsers[".obj"]=Mesh.parseOBJ.bind(Mesh)})(window);
