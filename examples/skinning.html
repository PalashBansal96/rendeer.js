<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />

<title>rendeer.js: skinning</title>
	<link rel="stylesheet" type="text/css" href="style.css" />
	<style type='text/css'>
		html, body { width: 100%; height: 100%; margin: 0; padding: 0 }
	</style>
	<script type="text/javascript" src="../external/gl-matrix-min.js"></script>
	<script type="text/javascript" src="../external/litegl.js"></script>
	<script type="text/javascript" src="../../litescene/src/resources/skeletalAnimation.js"></script>
	<script type="text/javascript" src="../src/rendeer.js"></script>
	<script type="text/javascript">
	
	var anim = null;
	var anim2 = null;

	function init()
	{
		//create a scene
		var scene = new RD.Scene();

		//create the rendering context
		var context = GL.create({ width: window.innerWidth, height:window.innerHeight });
		var renderer = new RD.Renderer( context );
		document.body.appendChild( renderer.canvas ); //attach

		var vertex_shader = '\
					precision highp float;\n\
					attribute vec3 a_vertex;\n\
					attribute vec3 a_normal;\n\
					attribute vec2 a_coord;\n\
					attribute vec4 a_bone_indices;\n\
					attribute vec4 a_weights;\n\
					varying vec3 v_pos;\n\
					varying vec3 v_normal;\n\
					varying vec2 v_coord;\n\
					uniform mat4 u_model;\n\
					uniform mat4 u_bones[128];\n\
					uniform mat4 u_viewprojection;\n\
					void main() {\n\
						vec4 v = vec4(a_vertex,1.0);\n\
						vec3 pos = (u_bones[int(a_bone_indices.x)] * a_weights.x * v + \n\
								u_bones[int(a_bone_indices.y)] * a_weights.y * v + \n\
								u_bones[int(a_bone_indices.z)] * a_weights.z * v + \n\
								u_bones[int(a_bone_indices.w)] * a_weights.w * v).xyz;\n\
						vec4 N = vec4(a_normal,0.0);\n\
						v_normal =	(u_bones[int(a_bone_indices.x)] * a_weights.x * N + \n\
								u_bones[int(a_bone_indices.y)] * a_weights.y * N + \n\
								u_bones[int(a_bone_indices.z)] * a_weights.z * N + \n\
								u_bones[int(a_bone_indices.w)] * a_weights.w * N).xyz;\n\
						v_normal = normalize(v_normal);\n\
						v_pos = (u_model * vec4(pos,1.0)).xyz;\n\
						v_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\
						v_coord = a_coord;\n\
						gl_Position = u_viewprojection * vec4( v_pos , 1.0 );\n\
						gl_PointSize = 2.0;\n\
					}\
					';
		var fragment_shader = '\
					precision highp float;\
					uniform vec4 u_color;\
					uniform sampler2D u_color_texture;\
					varying vec2 v_coord;\n\
					void main() {\
					  gl_FragColor = u_color * texture2D(u_color_texture,v_coord);\
					}\
		';

		gl.shaders["skinning"] = new GL.Shader( vertex_shader, fragment_shader );

		//create camera
		var camera = new RD.Camera();
		camera.perspective( 45, gl.canvas.width / gl.canvas.height, 1, 1000 );
		camera.lookAt( [0,30,40],[0,10,0],[0,1,0] );

		//create a node
		var people = [];
		for(var i = 0 ; i < 1; ++i )
		{
			var man = new RD.SceneNode();
			man.color = [1,1,1,1];
			man.mesh = "data/male.mesh";
			man.texture = "data/male.png";
			man.shader = "skinning";
			scene.root.addChild(man);
			people.push(man);
		}

		anim = new SkeletalAnimation();
		HttpRequest("data/idle.skanim", null, function(data) {
			anim.fromData(data);
		});
		anim2 = new SkeletalAnimation();
		HttpRequest("data/walking.skanim", null, function(data) {
			anim2.fromData(data);
		});

		//global settings
		var bg_color = vec4.fromValues(0.2,0.3,0.4,1);
		var bones = [];

		//main render loop
		var last = now = getTime();
		requestAnimationFrame(animate);
		function animate() {
			requestAnimationFrame( animate );

			var time = getTime()*0.001;
			last = now;
			now = getTime();
			var dt = (now - last) * 0.001;
			renderer.clear(bg_color);
			renderer.render(scene, camera);
			if(anim.duration)
				anim.assignTime( time );
			if(anim2.duration)
				anim2.assignTime( time );
			if(anim.duration && anim2.duration )
				Skeleton.blend( anim.skeleton, anim2.skeleton, Math.sin(time)*0.5+0.5, anim.skeleton );

			scene.update(dt);

			var player = people[0];
			bones = anim.skeleton.computeFinalBoneMatrices(bones,gl.meshes[ player.mesh ]);
			if(bones && bones.length)
				player.uniforms.u_bones = bones;

			camera.lookAt( [Math.cos(getTime() * 0.0001 )*60,50,Math.sin(getTime()* 0.0001 )*60],[0,10,0],[0,1,0] );
		}

		//input
		renderer.context.captureMouse();
		renderer.context.onmousemove = function(e)
		{
		}
	}


	</script>
</head>
<body>
<script>init();</script>
</body>
</html>


