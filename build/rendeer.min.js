'use strict';(function(m){function e(){this._ctor()}function q(){this._ctor();this.points=[];this.max_points=1E3;this.draw_range=[0,3*this.max_points];this.shader="pointcloud";this.textures={color:"white"};this.flags.blend=!0;this.flags.depth_write=!1;this._render_priority=20;this.num_textures=1;this.points_size=100;this._uniforms={u_pointSize:this.points_size,u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_points);this._extra=new Float32Array(3*
this.max_points);this._mesh=new GL.Mesh;this._vertices_buffer=this._mesh.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW);this._extra_buffer=this._mesh.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW);this._last_point_id=this._accumulated_time=0}function p(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};this.flags.blend=!0;this.flags.depth_write=!1;this._render_priority=
20;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=0.5;this.particles_acceleration=vec3.create();this.particles_end_scale=this.particles_start_scale=1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);
this._mesh=new GL.Mesh;this._vertices_buffer=this._mesh.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW);this._extra_buffer=this._mesh.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW);this._last_particle_id=this._accumulated_time=0}function u(){this._root=new e;this._root._scene=this;this.time=0}function n(a){var b=this.gl=this.context=a;if(!b||!b.enable)throw"litegl GL context not found.";a!=m.gl&&b.makeCurrent();this.point_size=5;this.sort_by_priority=!0;this._view_matrix=
mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._mvp_matrix=mat4.create();this._model_matrix=mat4.create();this._nodes=[];this._uniforms={u_view:this._view_matrix,u_viewprojection:this._viewprojection_matrix,u_model:this._model_matrix,u_mvp:this._mvp_matrix};m.gl=this.gl;this.canvas=b.canvas;b.meshes={};b.meshes.plane=GL.Mesh.plane({size:1});b.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});b.meshes.cube=GL.Mesh.cube({size:1});b.textures={};b.textures.notfound=
this.default_texture=new GL.Texture(1,1,{filter:b.NEAREST,pixel_data:new Uint8Array([0,0,0,255])});b.textures.white=this.default_texture=new GL.Texture(1,1,{filter:b.NEAREST,pixel_data:new Uint8Array([255,255,255,255])});b.shaders={};this.createShaders()}function f(a){this.type=f.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this.near=0.1;this.far=1E4;this.aspect=1;this.fov=45;this.frustum_size=50;this._view_matrix=mat4.create();
this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();this._must_update_matrix=!1;this._top=vec3.create();this._right=vec3.create();this._front=vec3.create();a&&(a.position&&this._position.set(a.position),a.target&&this._target.set(a.target),a.up&&this._up.set(a.up),a.near&&(this.near=a.near),a.far&&(this.far=a.far),a.fov&&(this.fov=a.fov),a.aspect&&(this.aspect=a.aspect));this.updateMatrices()}function r(a,b){return vec3.dot(a,b)+a[3]}function s(a,
b){var c=a.subarray(0,3),d=a[3],g=vec3.fromValues(Math.abs(b.halfsize[0]*c[0]),Math.abs(b.halfsize[1]*c[1]),Math.abs(b.halfsize[2]*c[2])),g=g[0]+g[1]+g[2],c=vec3.dot(c,b.center)+d;return c<=-g?h:c<=g?w:x}var k=m.RD={};k.ZERO=vec3.fromValues(0,0,0);k.RIGHT=vec3.fromValues(1,0,0);k.UP=vec3.fromValues(0,1,0);k.FRONT=vec3.fromValues(0,0,1);k.WHITE=vec3.fromValues(1,1,1);k.BLACK=vec3.fromValues(0,0,0);k.setup=function(a){a=a||{};if(k.configuration)throw"already called setup";k.configuration=a};var z=0,
y=mat4.create();vec3.create();var t=vec3.create();vec3.create();var v=quat.create();m.SceneNode=k.SceneNode=e;e.prototype._ctor=function(){this._uid=z++;this._position=vec3.create();this._rotation=quat.create();this._scale=vec3.fromValues(1,1,1);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;this._render_priority=10;this._color=vec4.fromValues(1,1,1,1);this._uniforms={u_color:this._color,u_color_texture:0};this.flags={};this.mesh=null;this.textures=
{};this.children=[]};Object.defineProperty(e.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(e.prototype,"positionX",{get:function(){return this._position[0]},set:function(a){this._position[0]=a;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(e.prototype,"positionY",{get:function(){return this._position[1]},set:function(a){this._position[1]=a;this._must_update_matrix=
!0},enumerable:!0});Object.defineProperty(e.prototype,"positionZ",{get:function(){return this._position[2]},set:function(a){this._position[2]=a;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(e.prototype,"rotation",{get:function(){return this._rotation},set:function(a){this._rotation.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(a){this._color.set(a)},enumerable:!0});Object.defineProperty(e.prototype,
"opacity",{get:function(){return this._color[3]},set:function(a){this._color[3]=a},enumerable:!0});Object.defineProperty(e.prototype,"scene",{get:function(){return this._scene},set:function(a){throw"cannot set scene, add to root node";},enumerable:!0});Object.defineProperty(e.prototype,"parentNode",{get:function(){return this._parent},set:function(a){throw"Cannot set parentNode of GameObject";},enumerable:!1});e.prototype.addChild=function(a){function b(a,d){a._scene=d;for(var g in a.children)b(a.children[g],
d)}if(a._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";a._parent=this;this.children.push(a);b(a,this._scene)};e.prototype.removeChild=function(a){function b(a){a._scene=null;for(var c in a.children)b(a.children[c])}if(a._parent!=this)throw"removeChild: Not its children";var c=this.children.indexOf(a);if(-1==c)throw"removeChild: impossible, should be children";this.children.splice(c,1);a._parent=null;b(a)};e.prototype.getAllChildren=function(a){a=a||[];for(var b in this.children){var c=
this.children[b];a.push(c);c.getAllChildren(a)}return a};e.prototype.serialize=function(){var a={position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]},b;for(b in this.children)a.children.push(this.children[b].serialize());return a};e.prototype.configure=function(a){a.position&&vec3.copy(this._position,a.position);a.rotation&&4==a.rotation.length&&
quat.copy(this._rotation,a.rotation);a.scale&&vec3.copy(this._scale,a.scale);this.updateGlobalMatrix()};e.prototype.setMesh=function(a){a?"string"==typeof a?this.mesh=a:this._mesh=a:this.mesh=null};e.prototype.setTexture=function(a,b){b?"string"==typeof b&&(this.textures[a]=b):this.textures[a]=null};e.prototype.translate=function(a){vec3.add(this._position,this._position,a);this._must_update_matrix=!0};e.prototype.rotate=function(a,b){quat.setAxisAngle(v,b,a);quat.multiply(this._rotation,this._rotation,
v);this._must_update_matrix=!0};e.prototype.scale=function(a){vec3.mul(this._scale,this._scale,a);this._must_update_matrix=!0};e.prototype.getLocalMatrix=function(){this._must_update_matrix&&this.updateLocalMatrix();return this._local_matrix};e.prototype.getGlobalMatrix=function(){this.updateGlobalMatrix();return this._global_matrix};e.prototype.getGlobalRotation=function(a){a=a||vec3.create();quat.identity(a);for(var b=this,c=this._scene?this._scene._root:null;b!=c;)quat.multiply(a,b._rotation,a),
b=b._parent;return a};e.prototype.updateLocalMatrix=function(){var a=this._local_matrix;mat4.identity(a);mat4.translate(a,a,this._position);mat4.fromQuat(y,this._rotation);mat4.multiply(a,a,y);mat4.scale(a,a,this._scale);this._must_update_matrix=!1};e.prototype.updateGlobalMatrix=function(a){var b=null;this._must_update_matrix&&this.updateLocalMatrix();this._parent&&this._scene&&this._parent!=this._scene._root?(b=a?this._parent._global_matrix:this._parent.getGlobalMatrix(),mat4.multiply(this._global_matrix,
b,this._local_matrix)):this._global_matrix.set(this._local_matrix)};e.prototype.updateMatrices=function(a){this.updateLocalMatrix();this.updateGlobalMatrix(a)};e.prototype.fromMatrix=function(a,b){if(b&&this._parent){mat4.copy(this._global_matrix,a);var c=this._parent.getGlobalMatrix();mat4.invert(c,c);a=mat4.multiply(this._local_matrix,c,a)}c=mat4.clone(a);mat4.multiplyVec3(this._position,c,[0,0,0]);var d=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(d,c,[1,0,0]));this._scale[1]=vec3.length(mat4.rotateVec3(d,
c,[0,1,0]));this._scale[2]=vec3.length(mat4.rotateVec3(d,c,[0,0,1]));mat4.scale(mat4.create(),c,[1/this._scale[0],1/this._scale[1],1/this._scale[2]]);vec3.normalize(c.subarray(0,3),c.subarray(0,3));vec3.normalize(c.subarray(4,7),c.subarray(4,7));vec3.normalize(c.subarray(8,11),c.subarray(8,11));c=mat3.fromMat4(mat3.create(),c);mat3.transpose(c,c);quat.fromMat3(this._rotation,c);quat.normalize(this._rotation,this._rotation);a!=this._local_matrix&&mat4.copy(this._local_matrix,a);this._must_update_matrix=
!1};e.prototype.getLocalPoint=function(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateLocalMatrix();return vec3.transformMat4(b,a,this._local_matrix)};e.prototype.getLocalVector=function(a,b){b=b||vec3.create();return vec3.transformQuat(b,a,this._rotation)};e.prototype.getGlobalPosition=function(a){a=a||vec3.create();var b=this.getGlobalMatrix();return vec3.transformMat4(a,a,b)};e.prototype.getGlobalPoint=function(a,b){b=b||vec3.create();var c=this.getGlobalMatrix();return vec3.transformMat4(b,
b,c)};e.prototype.getGlobalVector=function(a,b){b=b||vec3.create();var c=this.getGlobalRotation(v);return vec3.transformQuat(b,a,c)};e.prototype.findNode=function(a){for(var b in this.children){var c=this.children[b];if(c.id==a)return c[b];if(c=c.findNode(a))return c}return null};e.prototype.propagate=function(a,b){for(var c in this.children){var d=this.children[c];d[a]&&d[a].apply(d,b);d.propagate(a,b)}};e.prototype.loadTextConfig=function(a,b){HttpRequest(a,null,function(a){a=k.parseTextConfig(a);
b&&b(a)},alert)};extendClass(q,e);m.PointCloud=k.PointCloud=q;q.prototype.render=function(a,b){if(0!=this.points.length){this.updateVertices();this._vertices_buffer.uploadRange(0,12*this.points.length);this._extra_buffer.uploadRange(0,12*this.points.length);var c=gl.shaders[this.shader];c||(c=gl.shaders.pointcloud)||(gl.shaders.pointcloud=new GL.Shader(q._vertex_shader,q._pixel_shader));this.draw_range[1]=this.points.length;c=gl.getViewport();this._uniforms.u_pointSize=this.points_size/(gl.canvas.width/
c[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this.ignore_transform&&(mat4.identity(a._model_matrix),a._mvp_matrix.set(a._viewprojection_matrix));a.renderNode(this,a,b)}};q.prototype.updateVertices=function(a){if(a=this.points.length)for(var b=this._vertices,c=this._extra,d=0,g=this.num_textures*this.num_textures,e=0;e<a;e++){var f=this.points[e];b.set(f.pos,d);c[d]=1;c[d+1]=1;1<g&&
(c[d+2]=f.tex);d+=3}};q._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = abs(floor(v_coord.x) * u_texture_info.x);\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
q._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec2 uv = vec2(v_coord.x + gl_PointCoord.x * u_texture_info.x, v_coord.y + (1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  vec4 color = texture2D( u_color_texture, uv );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(p,e);m.ParticlesEmissor=k.ParticlesEmissor=p;p.prototype.update=function(a){var b=this.particles.length,c=this.particles_damping,d=this.particles_acceleration,g=vec3.length(d);if(b){for(var e=[],f=0;f<b;f++){var l=this.particles[f];vec3.scaleAndAdd(l.pos,l.pos,l.vel,a);g&&vec3.scaleAndAdd(l.vel,l.vel,d,a);c&&vec3.scaleAndAdd(l.vel,l.vel,l.vel,-a*c);l.ttl-=a;0<l.ttl&&e.push(l)}this.particles=e}b=this.getGlobalPosition();c=this.emissor_direction;d=this.particles_life;g=this.num_textures*
this.num_textures;if(0<this.particles_per_second)for(a=this.particles_per_second*(a+this._accumulated_time),this._accumulated_time=(a-Math.floor(a))/this.particles_per_second,a=Math.floor(a),f=0;f<a&&!(this.particles.length>=this.max_particles);f++)c=vec3.clone(c),c[0]+=0.5*Math.random(),c[2]+=0.5*Math.random(),this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*g)/g,pos:vec3.clone(b),vel:c,ttl:d})};p.prototype.render=function(a,b){if(0!=this.particles.length){this.updateVertices();
this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);var c=gl.shaders[this.shader];c||(c=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(p._vertex_shader,p._pixel_shader));this.draw_range[1]=this.particles.length;c=gl.getViewport();this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/c[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=
this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(a._model_matrix);a._mvp_matrix.set(a._viewprojection_matrix);a.renderNode(this,a,b)}};p.prototype.updateVertices=function(a){if(a=this.particles.length)for(var b=this._vertices,c=this._extra,d=0,g=this.particles_life,e=this.num_textures*this.num_textures,f=0;f<a;f++){var l=this.particles[f];b.set(l.pos,d);c[d]=1;c[d+1]=l.ttl/g;1<
e&&(c[d+2]=l.tex);d+=3}};p._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tuniform vec2 u_scaleStartEnd;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = floor(v_coord.x) * u_texture_info.x;\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = mix(u_scaleStartEnd.y, u_scaleStartEnd.x, a_extra3.y) * 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
p._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec4 color = texture2D( u_color_texture, v_coord + vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
m.Scene=k.Scene=u;u.prototype.clear=function(){this._root=new e;this._root._scene=this;this.time=0};u.prototype.getNodeById=function(a){return this._root.findNode(a)};u.prototype.update=function(a){this.time+=a;this.root.propagate("update",[a])};Object.defineProperty(u.prototype,"root",{get:function(){return this._root},set:function(a){throw"Cannot set root of scene";},enumerable:!1});m.Renderer=k.Renderer=n;n.prototype.clear=function(a){a?this.gl.clearColor(a[0],a[1],a[2],a[3]):this.gl.clearColor(0,
0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)};n.prototype.render=function(a,b,c){if(!a||!b)throw"Renderer.render: not enough parameters";m.gl=this.gl;this._camera=b;b.updateMatrices();b.extractPlanes();this._view_matrix.set(b._view_matrix);this._projection_matrix.set(b._projection_matrix);this._viewprojection_matrix.set(b._viewprojection_matrix);this._uniforms.u_camera_position=b.position;this._nodes.length=0;c||a.root.getAllChildren(this._nodes);c=c||this._nodes;this.sort_by_priority&&
c.sort(function(a,b){return b._render_priority-a._render_priority});a.root.preRender&&a.root.preRender(this,b);for(var d=0;d<c.length;++d){var g=c[d];g.updateGlobalMatrix(!0);g.preRender&&g.preRender(this,b)}for(d=0;d<c.length;++d)g=c[d],!1!==g.flags.visible&&(this._model_matrix.set(g._global_matrix),mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,this._model_matrix),g.render?g.render(this,b):this.renderNode(g,b));a.root.postRender&&a.root.postRender(this,b);for(d=0;d<c.length;++d)g=c[d],
g.postRender&&g.postRender(this,b)};n.prototype.renderNode=function(a,b){var c=null;a._mesh?c=a._mesh:a.mesh&&(c=gl.meshes[a.mesh]);if(c){var d=0,g;for(g in a.textures)(texture=gl.textures[a.textures[g]])||(texture=gl.textures.white),a._uniforms["u_"+g+"_texture"]=texture.bind(d++);g=null;var e=a.shader;a.shader&&(g=gl.shaders[e]);this.shader_overwrite&&(g=gl.shaders[this.shader_overwrite]);g||(g=0<d?this._texture_shader:this._flat_shader);gl.frontFace(a.flags.flip_normals?gl.CW:gl.CCW);gl[!1===a.flags.depth_test?
"disable":"enable"](gl.DEPTH_TEST);!1===a.flags.depth_write&&gl.depthMask(!1);gl[!0===a.flags.two_sided?"disable":"enable"](gl.CULL_FACE);a.flags.blend&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,"additive"==a.blendMode?gl.ONE:gl.ONE_MINUS_SRC_ALPHA));if(a.onRender)a.onRender(this,b,g);g.uniforms(this._uniforms);g.uniforms(a._uniforms);a.draw_range?g.drawRange(c,void 0===a.primitive?gl.TRIANGLES:a.primitive,a.draw_range[0],a.draw_range[1]):g.draw(c,void 0===a.primitive?gl.TRIANGLES:a.primitive);
a.flags.flip_normals&&gl.frontFace(gl.CCW);!1===a.flags.depth_test&&gl.enable(gl.DEPTH_TEST);a.flags.blend&&gl.disable(gl.BLEND);a.flags.two_sided&&gl.disable(gl.CULL_FACE);!1===a.flags.depth_write&&gl.depthMask(!0)}};n.prototype.setPointSize=function(a){this.point_size=a;gl.shaders.point.uniforms({u_pointSize:this.point_size})};Object.defineProperty(n.prototype,"meshes",{get:function(){return this.gl.meshes},set:function(a){},enumerable:!0});Object.defineProperty(n.prototype,"textures",{get:function(){return this.gl.textures},
set:function(a){},enumerable:!0});n.prototype.addMesh=function(a,b){b.gl!=this.gl&&(b=b.cloneShared(this.gl));this.gl.meshes[a]=b};m.Renderer=n;m.Camera=k.Camera=f;f.PERSPECTIVE=1;f.ORTHOGRAPHIC=2;Object.defineProperty(f.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(f.prototype,"target",{get:function(){return this._target},set:function(a){this._target.set(a);this._must_update_matrix=
!0},enumerable:!1});Object.defineProperty(f.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._must_update_matrix=!0},enumerable:!1});f.prototype.perspective=function(a,b,c,d){this.type=f.PERSPECTIVE;this.fov=a;this.aspect=b;this.near=c;this.far=d;this._must_update_matrix=!0};f.prototype.orthographic=function(a,b,c){this.type=f.ORTHOGRAPHIC;this.frustum_size=a;this.near=b;this.far=c};f.prototype.lookAt=function(a,b,c){vec3.copy(this._position,a);vec3.copy(this._target,
b);vec3.copy(this._up,c);this._must_update_matrix=!0};f.prototype.updateMatrices=function(){this.type==f.ORTHOGRAPHIC?mat4.ortho(this._projection_matrix,-this.frustum_size*this.aspect,this.frustum_size*this.aspect,-this.frustum_size,this.frustum_size,this.near,this.far):mat4.perspective(this._projection_matrix,this.fov*DEG2RAD,this.aspect,this.near,this.far);mat4.lookAt(this._view_matrix,this._position,this._target,this._up);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);
mat4.invert(this._model_matrix,this._view_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,[1,0,0]);mat4.rotateVec3(this._top,this._model_matrix,[0,1,0]);mat4.rotateVec3(this._front,this._model_matrix,[0,0,1]);this.distance=vec3.distance(this._position,this._target)};f.prototype.getModel=function(a){a=a||mat4.create();mat4.invert(this._model_matrix,this._view_matrix);mat4.copy(a,this._model_matrix);return a};f.prototype.updateVectors=function(a){var b=vec3.subtract(t,
this._target,this._position),b=vec3.length(b);mat4.multiplyVec3(this._position,a,[0,0,0]);mat4.multiplyVec3(this._target,a,[0,0,-b]);mat4.rotateVec3(this._up,a,[0,1,0])};f.prototype.getLocalVector=function(a,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,a)};f.prototype.getLocalPoint=function(a,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),a,this._model_matrix)};f.prototype.getFront=function(a){a=
a||vec3.create();vec3.subtract(a,this._target,this._position);vec3.normalize(a,a);return a};f.prototype.move=function(a){vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};f.prototype.moveLocal=function(a){a=mat4.rotateVec3(t,this._model_matrix,a);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};f.prototype.rotate=function(a,b){var c=quat.setAxisAngle(v,b,a*DEG2RAD),d=vec3.subtract(t,
this._target,this._position);vec3.transformQuat(d,d,c);vec3.add(this._target,this._position,d);this._must_update_matrix=!0};f.prototype.orbit=function(a,b,c){c=c||this._target;a=quat.setAxisAngle(v,b,a*DEG2RAD);b=vec3.subtract(t,this._position,this._target);vec3.transformQuat(b,b,a);vec3.add(this._position,c,b);this._must_update_matrix=!0};f.prototype.orbitDistanceFactor=function(a,b){b=b||this._target;var c=vec3.subtract(t,this._position,b);vec3.scale(c,c,a);vec3.add(this._position,b,c);this._must_update_matrix=
!0};f.prototype.project=function(a,b){b=b||[0,0,gl.canvas.width,gl.canvas.height];var c=mat4.multiplyVec3(t,this._viewprojection_matrix,a);c[0]/=c[2];c[1]/=c[2];return vec3.fromValues(0.5*(c[0]+1)*b[2]+b[0],0.5*(c[1]+1)*b[3]+b[1],c[2])};f.prototype.unproject=function(a,b){b=b||[0,0,gl.canvas.width,gl.canvas.height];return vec3.unproject(vec3.create(),a,this._view_matrix,this._projection_matrix,b)};f.prototype.getRayPlaneCollision=function(a,b,c,d,g){var e=new GL.Raytracer(this._view_matrix,this._projection_matrix),
f=this._position;a=e.getRayForPixel(a,b);g=g||vec3.create();return geo.testRayPlane(f,a,c,d,g)?g:null};f.prototype.extractPlanes=function(){function a(a){var b=c.subarray(a,a+3),b=vec3.length(b);b||(b=1/b,c[a]*=b,c[a+1]*=b,c[a+2]*=b,c[a+3]*=b)}var b=this._viewprojection_matrix,c=this._planes||new Float32Array(24);c.set([b[3]-b[0],b[7]-b[4],b[11]-b[8],b[15]-b[12]],0);a(0);c.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);a(4);c.set([b[3]+b[1],b[7]+b[5],b[11]+b[9],b[15]+b[13]],8);a(8);c.set([b[3]-
b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);a(12);c.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);a(16);c.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],b[15]+b[14]],20);a(20);this._planes=c};var x=0,h=1,w=2;f.prototype.testBox=function(a){this._planes||this.extractPlanes();var b=this._planes,c=0,d=0,c=s(b.subarray(0,4),a);if(c==h)return h;d+=c;c=s(b.subarray(4,8),a);if(c==h)return h;d+=c;c=s(b.subarray(8,12),a);if(c==h)return h;d+=c;c=s(b.subarray(12,16),a);if(c==h)return h;d+=c;c=s(b.subarray(16,20),
a);if(c==h)return h;d+=c;c=s(b.subarray(20,24),a);return c==h?h:0==d+c?x:w};f.prototype.testSphere=function(a,b){this._planes||this.extractPlanes();var c=this._planes,d;d=r(c.subarray(0,4),a);if(d<-b)return h;d=r(c.subarray(4,8),a);if(d<-b)return h;d=r(c.subarray(8,12),a);if(d<-b)return h;d=r(c.subarray(12,16),a);if(d<-b)return h;d=r(c.subarray(16,20),a);if(d<-b)return h;d=r(c.subarray(20,24),a);if(d<-b)return h};k.parseTextConfig=function(a){function b(a,e){for(var f=c.shift();f;)if(0==f.trim().length)f=
c.shift();else{for(var h=0;"\t"==f[h]&&h<f.length;)h++;if(h<e)break;var l={children:[]};try{var k=f.trim();-1!=k.indexOf(":")&&(k="{"+k+"}");var m=new Function("return "+k);l.data=m()}catch(n){console.error(n)}h>=e&&(a&&a.children.push(l),f=b(l,h+1))}return f}var c=a.split("\n");a={data:"",children:[]};b(a,0);return a};n.prototype.createShaders=function(){this._flat_shader=new GL.Shader("\t\t\t\tprecision highp float;\t\t\t\tattribute vec3 a_vertex;\t\t\t\tuniform mat4 u_mvp;\t\t\t\tvoid main() {\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\t\tgl_PointSize = 5.0;\t\t\t\t}\t\t\t\t",
"\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t\t\t");gl.shaders.flat=this._flat_shader;this._point_shader=new GL.Shader("\t\t\t\tprecision highp float;\t\t\t\tattribute vec3 a_vertex;\t\t\t\tuniform mat4 u_mvp;\t\t\t\tuniform float u_pointSize;\t\t\t\tvoid main() {\t\t\t\t\tgl_PointSize = u_pointSize;\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\t}\t\t\t\t","\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\t\t\t\t     discard;\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t\t\t");
gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec4 a_color;\t\tvarying vec4 v_color;\t\tuniform vec4 u_color;\t\tuniform mat4 u_mvp;\t\tuniform mat4 u_modelt;\t\tvoid main() {\t\t\tv_color = a_color * u_color;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t","\t\tprecision highp float;\t\tvarying vec4 v_color;\t\tvoid main() {\t\t  gl_FragColor = v_color;\t\t}\t");gl.shaders.color=
this._color_shader;this._texture_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec2 a_coord;\t\tvarying vec2 v_coord;\t\tuniform mat4 u_mvp;\t\tuniform mat4 u_modelt;\t\tvoid main() {\t\t\tv_coord = a_coord;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t","\t\tprecision highp float;\t\tvarying vec2 v_coord;\t\tuniform vec4 u_color;\t\tuniform sampler2D u_color_texture;\t\tvoid main() {\t\t\tgl_FragColor = u_color * texture2D(u_color_texture, v_coord);\t\t}\t");
gl.shaders.texture=this._flat_shader;var a={u_lightvector:vec3.fromValues(0.577,0.577,0.577),u_lightcolor:k.WHITE};this._phong_shader=new GL.Shader("\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_normal;\t\t\tvarying vec3 v_normal;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tvoid main() {\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t","\t\t\tprecision highp float;\t\t\tvarying vec3 v_normal;\t\t\tuniform vec3 u_lightcolor;\t\t\tuniform vec3 u_lightvector;\t\t\tuniform vec4 u_color;\t\t\tvoid main() {\t\t\t  vec3 N = normalize(v_normal);\t\t\t  gl_FragColor = u_color * max(0.0, dot(u_lightvector,N)) * vec4(u_lightcolor,1.0);\t\t\t}\t\t");
gl.shaders.phong=this._phong_shader;gl.shaders.phong.uniforms(a);this._textured_phong_shader=new GL.Shader("\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_normal;\t\t\tattribute vec2 a_coord;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_normal;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision highp float;\t\t\tvarying vec3 v_normal;\t\t\tvarying vec2 v_coord;\t\t\tuniform vec3 u_lightcolor;\t\t\tuniform vec3 u_lightvector;\t\t\tuniform vec4 u_color;\t\t\tuniform sampler2D u_color_texture;\t\t\tvoid main() {\t\t\t  vec3 N = normalize(v_normal);\t\t\t  gl_FragColor = u_color * texture2D(u_color_texture, v_coord) * max(0.0, dot(u_lightvector,N)) * vec4(u_lightcolor,1.0);\t\t\t}\t\t");gl.shaders.textured_phong=this._textured_phong_shader;gl.shaders.textured_phong.uniforms(a)}})(window);
