'use strict';(function(z){function g(a){if(this.constructor!==e.SceneNode)throw"You must use new to create RD.SceneNode";this._ctor();a&&this.configure(a)}function h(a){this.type=e.Camera.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=0.1;this._far=1E4;this._aspect=1;this._fov=45;this._frustum_size=50;this.flip_y=!1;this.view_texel_grid=null;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=
mat4.create();this._model_matrix=mat4.create();this._autoupdate_matrices=!0;this._must_update_matrix=!1;this._top=vec3.create();this._right=vec3.create();this._front=vec3.create();this.uniforms={u_view_matrix:this._view_matrix,u_projection_matrix:this._projection_matrix,u_viewprojection_matrix:this._viewprojection_matrix,u_camera_front:this._front,u_camera_position:this._position};a&&(null!=a.type&&(this.type=a.type),a.position&&this._position.set(a.position),a.target&&this._target.set(a.target),
a.up&&this._up.set(a.up),a.near&&(this.near=a.near),a.far&&(this.far=a.far),a.fov&&(this.fov=a.fov),a.aspect&&(this.aspect=a.aspect));this.updateMatrices()}function s(){this._root=new e.SceneNode;this._root.flags.no_transform=!0;this._root._scene=this;this._nodes_by_id={};this._nodes=[];this._to_destroy=[];this.frame=this.time=0}function p(){this._color=vec4.fromValues(1,1,1,1);this.shader_name=null;this.uniforms={u_color:this._color};this.textures={};this.primitive=GL.TRIANGLES;this.blend_mode=e.BLEND_NONE;
this.flags={two_sided:!1,depth_test:!0,depth_write:!0}}function f(a,b){b=b||{};var c=this.gl=this.context=a;if(!c||!c.enable)throw"litegl GL context not found.";a!=z.gl&&c.makeCurrent();this.point_size=5;this.sort_by_priority=!0;this.reverse_normals=this.sort_by_distance=!1;this.assets_folder="";this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._mvp_matrix=mat4.create();this._model_matrix=mat4.create();this._texture_matrix=mat3.create();
this._color=vec4.fromValues(1,1,1,1);this._viewprojection2D_matrix=mat4.create();this._nodes=[];this._uniforms={u_view:this._view_matrix,u_viewprojection:this._viewprojection_matrix,u_model:this._model_matrix,u_mvp:this._mvp_matrix,u_global_alpha_clip:0,u_color:this._color,u_texture_matrix:this._texture_matrix};z.gl=this.gl;this.canvas=c.canvas;this.assets_folder=b.assets_folder||"";this.autoload_assets=void 0!==b.autoload_assets?b.autoload_assets:!0;this.default_texture_settings={wrap:c.REPEAT,minFilter:c.LINEAR_MIPMAP_LINEAR,
magFilter:c.LINEAR};this.default_cubemap_settings={minFilter:c.LINEAR_MIPMAP_LINEAR,magFilter:c.LINEAR,is_cross:1};this.meshes.plane=GL.Mesh.plane({size:1});this.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});this.meshes.cube=GL.Mesh.cube({size:1,wireframe:!0});this.meshes.sphere=GL.Mesh.sphere({size:1,subdivisions:32,wireframe:!0});this.meshes.grid=GL.Mesh.grid({size:10});this.textures.notfound=this.default_texture=new GL.Texture(1,1,{filter:c.NEAREST,pixel_data:new Uint8Array([0,0,0,255])});this.textures.white=
this.default_texture=new GL.Texture(1,1,{filter:c.NEAREST,pixel_data:new Uint8Array([255,255,255,255])});this.num_assets_loading=0;this.assets_loading={};this.assets_not_found={};this.draw_calls=this.frame=0;this.createShaders();b.shaders_file&&this.loadShaders(b.shaders_file,null,b.shaders_macros)}function A(a,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();a&&this.origin.set(a);b&&this.direction.set(b)}function k(a){this._ctor();a&&this.configure(a)}
function q(a){this._ctor();a&&this.configure(a)}function E(a){g.prototype._ctor.call(this,a);this._ctor();a&&this.configure(a)}function r(a,b){return vec3.dot(a,b)+a[3]}function m(a,b,c){var d=a[3],l=Math.abs(c[0]*a[0]),e=Math.abs(c[1]*a[1]);c=Math.abs(c[2]*a[2]);l=l+e+c;a=vec3.dot(a,b)+d;return a<=-l?w:a<=l?H:F}var e=z.RD={version:0.5};e.ZERO=vec3.fromValues(0,0,0);e.ONE=vec3.fromValues(1,1,1);e.RIGHT=vec3.fromValues(1,0,0);e.LEFT=vec3.fromValues(-1,0,0);e.UP=vec3.fromValues(0,1,0);e.DOWN=vec3.fromValues(0,
-1,0);e.FRONT=vec3.fromValues(0,0,-1);e.BACK=vec3.fromValues(0,0,1);e.FRONT2D=vec2.fromValues(0,1);e.WHITE=vec3.fromValues(1,1,1);e.BLACK=vec3.fromValues(0,0,0);e.IDENTITY=mat4.create();e.ONES4=vec4.fromValues(1,1,1,1);e.CENTER=0;e.TOP_LEFT=1;e.TOP_RIGHT=2;e.BOTTOM_LEFT=3;e.BOTTOM_RIGHT=4;e.TOP_CENTER=5;e.BOTTOM_CENTER=6;e.PRIORITY_BACKGROUND=30;e.PRIORITY_OPAQUE=20;e.PRIORITY_ALPHA=10;e.PRIORITY_HUD=0;e.BLEND_NONE=0;e.BLEND_ALPHA=1;e.BLEND_ADD=2;e.BLEND_MULTIPLY=3;e.NO_BILLBOARD=0;e.BILLBOARD_SPHERIC=
1;e.BILLBOARD_PARALLEL_SPHERIC=2;e.BILLBOARD_CYLINDRIC=3;e.BILLBOARD_PARALLEL_CYLINDRIC=4;e.UNKNOWN=0;e.NUMBER=e.SCALAR=1;e.VEC2=2;e.VEC3=3;e.VEC4=4;e.QUAT=5;e.MAT3=6;e.TRANS10=7;e.MAT4=8;e.TYPES={NUMBER:e.NUMBER,SCALAR:e.NUMBER,VEC2:e.VEC2,VEC3:e.VEC3,VEC4:e.VEC4,QUAT:e.QUAT,MAT3:e.MAT3,TRANS10:e.TRANS10,MAT4:e.MAT4};e.TYPES_SIZE=[0,1,2,3,4,4,9,10,16];e.NO_INTERPOLATION=0;e.LINEAR=1;e.CUBIC=2;var B=e.DEG2RAD=0.0174532925;e.RAD2DEG=57.295779578552306;e.Materials={};e.Images={};e.setup=function(a){a=
a||{};if(e.configuration)throw"already called setup";e.configuration=a};var t=0;"undefined"==typeof extendClass&&(z.extendClass=function(a,b){for(var c in b)a.hasOwnProperty(c)||(a[c]=b[c]);if(b.prototype){var d=Object.getOwnPropertyNames(b.prototype);for(c=0;c<d.length;++c){var l=d[c];a.prototype.hasOwnProperty(l)||(b.prototype.__lookupGetter__(l)?a.prototype.__defineGetter__(l,b.prototype.__lookupGetter__(l)):a.prototype[l]=b.prototype[l],b.prototype.__lookupSetter__(l)&&a.prototype.__defineSetter__(l,
b.prototype.__lookupSetter__(l)))}}a.hasOwnProperty("superclass")||Object.defineProperty(a,"superclass",{get:function(){return b},enumerable:!1})});var J=mat4.create(),y=mat3.create(),n=mat4.create(),u=vec2.create(),v=vec3.create(),I=vec3.create();vec4.create();var D=quat.create();e.SceneNode=g;g.prototype._ctor=function(){this._uid=t++;this._id=null;this._transform=new Float32Array(10);this._position=this._transform.subarray(0,3);this._rotation=this._transform.subarray(3,7);this._scale=this._transform.subarray(7,
10);quat.identity(this._rotation);this._scale.set(e.ONE);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;this.bounding_box=null;this.render_priority=e.PRIORITY_OPAQUE;this.blend_mode=e.BLEND_NONE;this.layers=3;this._color=vec4.fromValues(1,1,1,1);this._uniforms={u_color:this._color,u_color_texture:0};this.primitive=GL.TRIANGLES;this._instances=this.draw_range=null;this.onRender||(this.onRender=null);this.onShaderUniforms||(this.onShaderUniforms=null);
this.mesh=this.shader=null;this.textures={};this.flags={visible:!0,collides:!0};this.children=[]};g.ctor=g.prototype._ctor;g.prototype.clone=function(a){var b=new this.constructor,c;for(c in this)if("_"!=c[0])if("children"==c){if(a)for(var d=0;d<this.children.length;++d)b.addChild(this.children[d].clone(a))}else d=this[c],void 0!==d&&(null===d?b[c]=null:d.constructor===Object?b[c]=GL.cloneObject(d):d.constructor===Array?b[c]=d.concat():b[c]!==d&&(b[c]=d));return b};Object.defineProperty(g.prototype,
"id",{get:function(){return this._id},set:function(a){this._scene?console.error("Cannot change id of a node already in a scene."):this._id=a},enumerable:!0});Object.defineProperty(g.prototype,"uniforms",{get:function(){return this._uniforms},set:function(a){GL.cloneObject(a,this._uniforms);this._uniforms.u_color=this._color},enumerable:!0});Object.defineProperty(g.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!0});
Object.defineProperty(g.prototype,"x",{get:function(){return this._position[0]},set:function(a){this._position[0]=a;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(g.prototype,"y",{get:function(){return this._position[1]},set:function(a){this._position[1]=a;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(g.prototype,"z",{get:function(){return this._position[2]},set:function(a){this._position[2]=a;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(g.prototype,
"rotation",{get:function(){return this._rotation},set:function(a){this._rotation.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(g.prototype,"scaling",{get:function(){return this._scale},set:function(a){a.constructor===Number?this._scale[0]=this._scale[1]=this._scale[2]=a:this._scale.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(g.prototype,"transform",{get:function(){return this._transform},set:function(a){this._transform.set(a);this._must_update_matrix=
!0},enumerable:!0});Object.defineProperty(g.prototype,"pivot",{get:function(){return this._pivot},set:function(a){this._must_update_matrix=!0;a?(this._pivot||(this._pivot=vec3.create()),this._pivot.set(a),this.flags.pivot=!0):(this._pivot=null,this.flags.pivot=!1)},enumerable:!0});Object.defineProperty(g.prototype,"color",{get:function(){return this._color},set:function(a){this._color.set(a)},enumerable:!0});Object.defineProperty(g.prototype,"opacity",{get:function(){return this._color[3]},set:function(a){this._color[3]=
a},enumerable:!0});Object.defineProperty(g.prototype,"visible",{get:function(){return this.flags.visible},set:function(a){this.flags.visible=a},enumerable:!0});Object.defineProperty(g.prototype,"texture",{get:function(){return this.textures.color},set:function(a){this.textures.color=a},enumerable:!1});Object.defineProperty(g.prototype,"scene",{get:function(){return this._scene},set:function(a){throw"cannot set scene, you must use addChild in its parent node";},enumerable:!1});Object.defineProperty(g.prototype,
"parentNode",{get:function(){return this._parent},set:function(a){throw"Cannot set parentNode of SceneNode";},enumerable:!1});g.prototype.addChild=function(a,b){function c(a,b){if(a._scene&&a._scene!=b){var e=a._scene._nodes.indexOf(a);-1!=e&&a._scene._nodes.splice(e,1);a.id&&a._scene._nodes_by_id[a.id]==a&&delete a._scene._nodes_by_id[a.id]}if(a._scene=b)b._nodes.push(a),a.id&&b&&(b._nodes_by_id[a.id]=a);if(a.children)for(var e=0,f=a.children.length;e<f;e++){var x=a.children[e];x._scene!=b&&c(x,
b)}}if(a._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";a._parent=this;b&&a.fromMatrix(a._global_matrix);this.children||(this.children=[]);this.children.push(a);this._scene!=a._scene&&c(a,this._scene)};g.prototype.removeChild=function(a,b){function c(a){if(a._scene){a.id&&a._scene._nodes_by_id[a.id]==a&&delete a._scene._nodes_by_id[a.id];var b=a._scene._nodes.indexOf(a);-1!=b&&a._scene._nodes.splice(b,1)}a._scene=null;for(var b=0,d=a.children.length;b<d;b++)c(a.children[b])}
if(a._parent!=this)throw"removeChild: Not its children";if(this.children){var d=this.children.indexOf(a);if(-1==d)throw"removeChild: impossible, should be children";this.children.splice(d,1);a._parent=null;b&&a.fromMatrix(a._global_matrix);c(a)}};g.prototype.removeAllChildren=function(){if(this.children)for(;this.children.length;)this.removeChild(this.children[0])};g.prototype.clear=function(){if(this.children)for(;this.children.length;)this.removeChild(this.children[this.children.length-1])};g.prototype.setChildIndex=
function(a,b){if(this.children){var c=this.children.indexOf(a);-1!=c&&(this.children.splice(c,1),this.children.splice(b,0,a))}};g.prototype.getAllChildren=function(a){a=a||[];if(!this.children)return a;for(var b=0,c=this.children.length;b<c;b++){var d=this.children[b];a.push(d);d.getAllChildren(a)}return a};g.prototype.getVisibleChildren=function(a,b){a=a||[];void 0===b&&(b=255);if(!this.children||!1===this.flags.visible)return a;for(var c=0,d=this.children.length;c<d;c++){var l=this.children[c];
l.layers&b&&a.push(l);l.getVisibleChildren(a,b)}return a};g.prototype.serialize=function(){var a={position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]};if(this.children)for(var b=0,c=this.children.length;b<c;b++)a.children.push(this.children[b].serialize());return a};g.prototype.configure=function(a){var b=null,c;for(c in a){switch(c){case "children":continue;
case "uniforms":for(var d in a.uniforms)this.uniforms[d]=a.uniforms[d];continue;case "texture":this[c]=a[c];continue;case "flags":for(d in a.flags)this.flags[d]=a.flags[d];continue;case "scale":case "scaling":this.scale(a[c]);continue;case "tiling":isNumber(a[c])?this.setTextureTiling(a[c],a[c]):this.setTextureTiling(a[c][0],a[c][1],a[c][2],a[c][3]);continue;case "ref":case "draw_range":case "submesh":this[c]=a[c];continue;case "parent":b=a[c]}var l=this[c];void 0!==l&&(l&&l.constructor===Float32Array?
l.set(a[c]):this[c]=a[c])}this._must_update_matrix=!0;this.updateGlobalMatrix();if(a.children)for(this.removeAllChildren(),c=0;c<a.children.length;++c)d=new e.SceneNode,d.configure(a.children[c]),this.addChild(d);b&&(this.parentNode?console.error("This node already has a parent"):b.addChild(this))};g.prototype.setMesh=function(a){a?"string"==typeof a?this.mesh=a:this._mesh=a:this.mesh=null};g.prototype.setTexture=function(a,b){b?"string"==typeof b&&(this.textures[a]=b):this.textures[a]=null};g.prototype.resetTransform=
function(){this._position.set(e.ZERO);quat.identity(this._rotation);this._scale.set(e.ONE);this._must_update_matrix=!0};g.prototype.translate=function(a){vec3.add(this._position,this._position,a);this._must_update_matrix=!0};g.prototype.rotate=function(a,b,c){quat.setAxisAngle(D,b,a);c?quat.multiply(this._rotation,D,this._rotation):quat.multiply(this._rotation,this._rotation,D);this._must_update_matrix=!0};g.prototype.rotateQuat=function(a,b){b?quat.multiply(this._rotation,a,this._rotation):quat.multiply(this._rotation,
this._rotation,a);this._must_update_matrix=!0};g.prototype.scale=function(a){a.constructor===Number?(v[0]=v[1]=v[2]=a,vec3.mul(this._scale,this._scale,v)):vec3.mul(this._scale,this._scale,a);this._must_update_matrix=!0};g.prototype.setPivot=function(a){this.pivot=a};g.prototype.setTextureTiling=function(a,b,c,d){this.texture_matrix||(this.texture_matrix=mat3.create(),this._uniforms.u_texture_matrix=this.texture_matrix);c=c||0;d=d||0;this.shader||(this.shader="texture_transform");mat3.identity(this.texture_matrix);
mat3.translate(this.texture_matrix,this.texture_matrix,[c,d]);mat3.scale(this.texture_matrix,this.texture_matrix,[a,b])};g.prototype.getLocalMatrix=function(a){this._must_update_matrix&&this.updateLocalMatrix();return a?(a.set(this._global_matrix),a):this._local_matrix};g.prototype.getGlobalMatrix=function(a){this.updateGlobalMatrix();return a?(a.set(this._global_matrix),a):this._global_matrix};g.prototype.getGlobalRotation=function(a){a=a||vec4.create();quat.identity(a);for(var b=this,c=this._scene?
this._scene._root:null;b!=c;)quat.multiply(a,b._rotation,a),b=b._parent;return a};g.prototype.updateLocalMatrix=function(){var a=this._local_matrix;this._must_update_matrix=!1;mat4.identity(a);this.flags.no_transform||(this.flags.pivot&&this._pivot&&(a[12]=this._pivot[0],a[13]=this._pivot[1],a[14]=this._pivot[2]),mat4.translate(a,a,this._position),mat4.fromQuat(n,this._rotation),mat4.multiply(a,a,n),mat4.scale(a,a,this._scale),this.flags.pivot&&this._pivot&&mat4.translate(a,a,[-this._pivot[0],-this._pivot[1],
-this._pivot[2]]))};g.prototype.updateGlobalMatrix=function(a,b){var c=null;this._must_update_matrix&&!this.flags.no_transform&&this.updateLocalMatrix();this._parent&&this._parent._transform&&!0!==this._parent.flags.no_transform?(c=a?this._parent._global_matrix:this._parent.getGlobalMatrix(),this.flags.no_transform?this._global_matrix.set(c):mat4.multiply(this._global_matrix,c,this._local_matrix)):this._global_matrix.set(this._local_matrix);if(b)for(c=0;c<this.children.length;c++)this.children[c].updateGlobalMatrix(!0,
b)};g.prototype.updateMatrices=function(a){this.updateLocalMatrix();this.updateGlobalMatrix(a)};g.prototype.fromMatrix=function(a,b){if(b&&this._parent&&this._parent._transform){mat4.copy(this._global_matrix,a);var c=this._parent.getGlobalMatrix();mat4.invert(c,c);a=mat4.multiply(this._local_matrix,c,a)}c=mat4.clone(a);mat4.multiplyVec3(this._position,c,[0,0,0]);var d=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(d,c,e.RIGHT));this._scale[1]=vec3.length(mat4.rotateVec3(d,c,e.UP));this._scale[2]=
vec3.length(mat4.rotateVec3(d,c,e.BACK));c=mat3.fromMat4(y,c);quat.fromMat3AndQuat(this._rotation,c);a!=this._local_matrix&&mat4.copy(this._local_matrix,a);this._must_update_matrix=!1};g.prototype.getLocalPoint=function(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateLocalMatrix();return vec3.transformMat4(b,a,this._local_matrix)};g.prototype.getLocalVector=function(a,b){b=b||vec3.create();return vec3.transformQuat(b,a,this._rotation)};g.prototype.getGlobalPosition=function(a,b){a=a||
vec3.create();if(b)return vec3.transformMat4(a,e.ZERO,this._global_matrix);if(!this._parent||!this._parent._transform)return a.set(this._position),a;var c=this.getGlobalMatrix();return vec3.transformMat4(a,e.ZERO,c)};g.prototype.getGlobalPoint=function(a,b){b=b||vec3.create();var c=this.getGlobalMatrix();return vec3.transformMat4(b,a,c)};g.prototype.localToGlobal=g.prototype.getGlobalPoint;g.prototype.globalToLocal=function(a,b){b=b||vec3.create();var c=this.getGlobalMatrix();mat4.invert(n,c);return vec3.transformMat4(b,
a,n)};g.prototype.getGlobalVector=function(a,b){b=b||vec3.create();var c=this.getGlobalRotation(D);return vec3.transformQuat(b,a,c)};g.prototype.getDistanceTo=function(a){var b=this.getGlobalMatrix();return vec3.distance(a,b.subarray(12,15))};g.prototype.findNode=function(a){for(var b=0,c=this.children.length;b<c;b++){var d=this.children[b];if(d.id==a||(d=d.findNode(a)))return d}return null};g.prototype.findNodeByName=function(a){for(var b=0,c=this.children.length;b<c;b++){var d=this.children[b];
if(d.name==a||(d=d.findNodeByName(a)))return d}return null};g.prototype.findNodesByFilter=function(a,b,c){void 0===b&&(b=255);c=c||[];for(var d=0,l=this.children.length;d<l;d++){var e=this.children[d];e.layer&b&&(a&&!a(e)||c.push(e),e.findNodesByFilter(a,b,c))}return c};g.prototype.propagate=function(a,b){for(var c=0,d=this.children.length;c<d;c++){var l=this.children[c];l&&(l[a]&&l[a].apply(l,b),l.children&&l.children.length&&l.propagate(a,b))}};g.prototype.loadTextConfig=function(a,b){GL.request(a,
null,function(a){a=e.parseTextConfig(a);b&&b(a)},alert)};g.prototype.destroy=function(a){!this.scene||a?this._parent&&this._parent.removeChild(this):this.scene._to_destroy.push(this)};g.prototype.updateBoundingBox=function(a){var b=this._global_matrix,c=gl.meshes[this.mesh],d=null;c&&(d=c.getBoundingBox(),this.bounding_box||(this.bounding_box=BBox.create()),d=BBox.transformMat4(this.bounding_box,d,b));if(a||!this.children||0==this.children.length)return d;for(a=0;a<this.children.length;++a)if(b=this.children[a].updateBoundingBox())d||
(d=this.bounding_box=BBox.create()),BBox.merge(d,d,b);return d};g.prototype.testRay=function(){var a=vec3.create(),b=vec3.create();vec3.create();vec3.create();vec3.create();mat4.create();mat4.create();return function(c,d,l,e,f){l=void 0===l?Number.MAX_VALUE:l;void 0===e&&(e=255);d=d||vec3.create();void 0!==s._ray_tested_objects&&s._ray_tested_objects++;var x=null,g=null;this.layers&e&&this.mesh&&!this.flags.ignore_collisions&&(g=this.testRayWithMesh(c,a,l,e,f));g&&(g=vec3.distance(c.origin,a),g<l&&
(l=g,d.set(a),x=this));if(!this.children&&!this.children.length)return x;for(var k=0;k<this.children.length;++k){var h=this.children[k].testRay(c,b,l,e,f);h&&(g=vec3.distance(c.origin,b),g<l&&(l=g,d.set(a),x=h))}return x}}();g.prototype.testRayWithMesh=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),l=mat4.create();return function(e,f,g,k,h){g=void 0===g?Number.MAX_VALUE:g;if(!this.mesh)return!1;var m=gl.meshes[this.mesh];if(!m)return!1;var n=null,q=m;null==this.submesh?
n=m.getBoundingBox():(q=m.info.groups[this.submesh],n=q.bounding,n||(m.computeGroupsBoundingBoxes(),n=q.bounding));if(!n)return!1;g||(g=1E7);k=this._global_matrix;mat4.invert(l,k);vec3.transformMat4(b,e.origin,l);vec3.add(d,e.origin,e.direction);vec3.transformMat4(d,d,l);vec3.sub(c,d,b);vec3.normalize(c,c);if(!geo.testRayBBox(b,c,n,null,a))return!1;vec3.transformMat4(f,a,k);n=vec3.distance(e.origin,f);if(n>g)return!1;if(!h)return!0;q._octree||(q._octree=q==m?new GL.Octree(m):new GL.Octree(m,q.start,
q.length));h=q._octree.testRay(b,c,0,g,this.flags.two_sided);if(!h)return!1;f.set(h.hit);vec3.transformMat4(f,f,k);n=vec3.distance(e.origin,f);return n>g?!1:!0}}();g.prototype.setRangeFromSubmesh=function(a){if(void 0!==a&&this.mesh){var b=gl.meshes[this.mesh];if(b&&b.info&&b.info.groups){if(a.constructor===String){for(var c=0;c<b.info.groups.length;++c)if(b.info.groups[c].name==a){a=c;break}if(c===b.info.groups.length)return!1}if(a=b.info.groups[a])this.draw_range[0]=a.start,this.draw_range[1]=a.length}else console.warn("you cannot set the submesh_id while the mesh is not yet loaded")}else this.draw_range=
null};g.prototype.findNodesInSphere=function(a,b,c,d){void 0===c&&(c=255);d=d||[];for(var l=0;l<this.children.length;++l){var e=this.children[l];e.layers&c&&(e.getGlobalPosition(v,!0),vec3.distance(v,a)<=b&&d.push(e));e.children.length&&e.findNodesInSphere(a,b,c,d)}return d};e.Camera=h;h.PERSPECTIVE=1;h.ORTHOGRAPHIC=2;Object.defineProperty(h.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,
"target",{get:function(){return this._target},set:function(a){this._target.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"aspect",{get:function(){return this._aspect},
set:function(a){this._aspect=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"frustum_size",{get:function(){return this._frustum_size},set:function(a){this._frustum_size=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"near",{get:function(){return this._near},set:function(a){this._near=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"far",{get:function(){return this._far},set:function(a){this._far=a;
this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"view_matrix",{get:function(){return this._view_matrix},set:function(a){this._view_matrix.set(a);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},enumerable:!1});Object.defineProperty(h.prototype,"projection_matrix",{get:function(){return this._projection_matrix},set:function(a){this._projection_matrix.set(a);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)},
enumerable:!1});Object.defineProperty(h.prototype,"viewprojection_matrix",{get:function(){return this._viewprojection_matrix},set:function(a){this._viewprojection_matrix.set(a)},enumerable:!1});h.prototype.perspective=function(a,b,c,d){this.type=h.PERSPECTIVE;this._fov=a;this._aspect=b;this._near=c;this._far=d;this._must_update_matrix=!0};h.prototype.orthographic=function(a,b,c,d){this.type=h.ORTHOGRAPHIC;this._frustum_size=a;1<arguments.lenth&&(this._near=b,this._far=c,this._aspect=d||1);this._must_update_matrix=
!0};h.prototype.lookAt=function(a,b,c){vec3.copy(this._position,a);vec3.copy(this._target,b);vec3.copy(this._up,c);this._must_update_matrix=!0};h.prototype.updateMatrices=function(a){if(this._autoupdate_matrices||a)if(this.type==h.ORTHOGRAPHIC?this.frustum_size.constructor===Number?mat4.ortho(this._projection_matrix,-this.frustum_size*this._aspect,this.frustum_size*this._aspect,-this._frustum_size,this._frustum_size,this._near,this._far):this.frustum_size.length&&mat4.ortho(this._projection_matrix,
this.frustum_size[0],this.frustum_size[1],this.frustum_size[2],this.frustum_size[3],3<this.frustum_size.length?this.frustum_size[4]:this._near,4<this.frustum_size.length?this.frustum_size[5]:this._far):mat4.perspective(this._projection_matrix,this._fov*B,this._aspect,this._near,this._far),this.flip_y&&mat4.scale(this._projection_matrix,this._projection_matrix,[1,-1,1]),mat4.lookAt(this._view_matrix,this._position,this._target,this._up),this.view_texel_grid&&this.type==h.ORTHOGRAPHIC){a=2*(this.frustum_size.constructor===
Number?this.frustum_size*this._aspect:this.frustum_size[0])/this.view_texel_grid[0];var b=2*(this.frustum_size.constructor===Number?this.frustum_size:this.frustum_size[1])/this.view_texel_grid[1];this._view_matrix[12]=Math.floor(this._view_matrix[12]/a)*a;this._view_matrix[13]=Math.floor(this._view_matrix[13]/b)*b}this.is_reflection&&mat4.scale(this._view_matrix,this._view_matrix,[1,-1,1]);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,
this._view_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,e.RIGHT);mat4.rotateVec3(this._top,this._model_matrix,e.UP);mat4.rotateVec3(this._front,this._model_matrix,e.FRONT);this.distance=vec3.distance(this._position,this._target)};h.prototype.getModel=function(a){a=a||mat4.create();mat4.invert(this._model_matrix,this._view_matrix);mat4.copy(a,this._model_matrix);return a};h.prototype.updateVectors=function(a){var b=vec3.subtract(v,this._target,this._position),
b=vec3.length(b);mat4.multiplyVec3(this._position,a,e.ZERO);mat4.multiplyVec3(this._target,a,[0,0,-b]);mat4.rotateVec3(this._up,a,e.UP)};h.prototype.getLocalVector=function(a,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,a)};h.prototype.getLocalPoint=function(a,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),a,this._model_matrix)};h.prototype.getFront=function(a){a=a||vec3.create();vec3.subtract(a,
this._target,this._position);vec3.normalize(a,a);return a};h.prototype.move=function(a,b){void 0!==b&&(vec3.scale(v,a,b),a=v);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};h.prototype.moveLocal=function(a,b){var c=mat4.rotateVec3(v,this._model_matrix,a);void 0!==b&&vec3.scale(c,c,b);vec3.add(this._target,this._target,c);vec3.add(this._position,this._position,c);this._must_update_matrix=!0};h.prototype.rotate=function(a,b){var c=quat.setAxisAngle(D,
b,a),d=vec3.subtract(v,this._target,this._position);vec3.transformQuat(d,d,c);vec3.add(this._target,this._position,d);this._must_update_matrix=!0};h.prototype.rotateLocal=function(a,b){var c=mat4.rotateVec3(I,this._model_matrix,b),c=quat.setAxisAngle(D,c,a),d=vec3.subtract(v,this._target,this._position);vec3.transformQuat(d,d,c);vec3.add(this._target,this._position,d);this._must_update_matrix=!0};h.prototype.orbit=function(a,b,c,d){if(!b)throw"RD: orbit axis missing";c=c||this._target;d&&(b=mat4.rotateVec3(I,
this._model_matrix,b));a=quat.setAxisAngle(D,b,a);b=vec3.subtract(v,this._position,this._target);vec3.transformQuat(b,b,a);vec3.add(this._position,c,b);this._must_update_matrix=!0};h.prototype.orbitDistanceFactor=function(a,b){b=b||this._target;var c=vec3.subtract(v,this._position,b);vec3.scale(c,c,a);vec3.add(this._position,b,c);this._must_update_matrix=!0};h.prototype.project=function(a,b,c){c=c||vec3.create();b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();mat4.projectVec3(c,
this._viewprojection_matrix,a);c[0]=c[0]*b[2]+b[0];c[1]=c[1]*b[3]+b[1];return c};h.prototype.unproject=function(a,b,c){b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();return vec3.unproject(c||vec3.create(),a,this._viewprojection_matrix,b)};h.prototype.getRay=function(a,b,c,d){if(void 0===a||void 0===b)throw"RD.Camera.getRay requires x and y parameters";c=c||gl.viewport_data;d||(d=new e.Ray);this._must_update_matrix&&this.updateMatrices();var l=d.origin;vec3.set(l,a,b,0);this.type==
e.Camera.ORTHOGRAPHIC?vec3.unproject(l,l,this._viewprojection_matrix,c):vec3.copy(l,this.position);var C=d.direction;vec3.set(C,a,b,1);vec3.unproject(C,C,this._viewprojection_matrix,c);vec3.sub(C,C,l);vec3.normalize(C,C);return d};h.prototype.getRayPlaneCollision=function(a,b,c,d,l,e){l=l||vec3.create();a=this.getRay(a,b,e);return geo.testRayPlane(a.origin,a.direction,c,d,l)?l:null};h.controller_keys={forward:"UP",back:"DOWN",left:"LEFT",right:"RIGHT"};h.prototype.applyController=function(a,b,c){c=
c||10;a&&(gl.keys[h.controller_keys.forward]?this.moveLocal(vec3.scale(v,e.FRONT,a*c)):gl.keys[h.controller_keys.back]&&this.moveLocal(vec3.scale(v,e.BACK,a*c)),gl.keys[h.controller_keys.left]?this.moveLocal(vec3.scale(v,e.LEFT,a*c)):gl.keys[h.controller_keys.right]&&this.moveLocal(vec3.scale(v,e.RIGHT,a*c)));b&&(b.deltax&&this.rotate(-0.005*b.deltax,e.UP),b.deltay&&this.rotateLocal(-0.005*b.deltay,e.RIGHT))};h.prototype.lerp=function(a,b){vec3.lerp(this._position,this._position,a._position,b);vec3.lerp(this._target,
this._target,a._target,b);vec3.lerp(this._up,this._up,a._up,b);this._fov=this._fov*(1-b)+a._fov*b;this._near=this._near*(1-b)+a._near*b;this._far=this._far*(1-b)+a._far*b;this._frustum_size.constructor===Number&&(this._frustum_size=this._frustum_size*(1-b)+a._frustum_sizer*b);this._must_update_matrix=!0};h.prototype.orientMatrixToCamera=function(a){a.set(this._right,0);a.set(this._top,4);a.set(this._front,8)};h.prototype.extractPlanes=function(){function a(a){var b=c.subarray(a,a+3),b=vec3.length(b);
0!==!b&&(b=1/b,c[a]*=b,c[a+1]*=b,c[a+2]*=b,c[a+3]*=b)}var b=this._viewprojection_matrix,c=this._planes_data||new Float32Array(24);c.set([b[3]-b[0],b[7]-b[4],b[11]-b[8],b[15]-b[12]],0);a(0);c.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);a(4);c.set([b[3]+b[1],b[7]+b[5],b[11]+b[9],b[15]+b[13]],8);a(8);c.set([b[3]-b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);a(12);c.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);a(16);c.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],b[15]+b[14]],20);a(20);this._planes_data=
c;this._frustrum_planes||(this._frustrum_planes=[c.subarray(0,4),c.subarray(4,8),c.subarray(8,12),c.subarray(12,16),c.subarray(16,20),c.subarray(20,24)])};var F=e.CLIP_INSIDE=0,w=e.CLIP_OUTSIDE=1,H=e.CLIP_OVERLAP=2;h.prototype.testMesh=function(){if(z.BBox){var a=BBox.create(),b=a.subarray(0,3),c=a.subarray(3,6);return function(d,l){var e=d.bounding;if(!e)return F;BBox.transformMat4(a,e,l);return this.testBox(b,c)}}}();h.prototype.testBox=function(a,b){this._frustrum_planes||this.extractPlanes();
var c=this._frustrum_planes,d=0,l=0,d=m(c[0],a,b);if(d==w)return w;l+=d;d=m(c[1],a,b);if(d==w)return w;l+=d;d=m(c[2],a,b);if(d==w)return w;l+=d;d=m(c[3],a,b);if(d==w)return w;l+=d;d=m(c[4],a,b);if(d==w)return w;l+=d;d=m(c[5],a,b);return d==w?w:0==l+d?F:H};h.prototype.testSphere=function(a,b){this._frustrum_planes||this.extractPlanes();var c=this._frustrum_planes,d,l=!1;d=r(c[0],a);if(d<-b)return w;d>=-b&&d<=b&&(l=!0);d=r(c[1],a);if(d<-b)return w;d>=-b&&d<=b&&(l=!0);d=r(c[2],a);if(d<-b)return w;d>=
-b&&d<=b&&(l=!0);d=r(c[3],a);if(d<-b)return w;d>=-b&&d<=b&&(l=!0);d=r(c[4],a);if(d<-b)return w;d>=-b&&d<=b&&(l=!0);d=r(c[5],a);if(d<-b)return w;d>=-b&&d<=b&&(l=!0);return l?H:F};e.Scene=s;s.prototype.clear=function(){this._root=new e.SceneNode;this._root._scene=this;this._nodes.length=0;this._nodes_by_id={};this.time=0};s.prototype.getNodeById=function(a){return this._nodes_by_id[a]};s.prototype.findNodesInBBox=function(a,b,c){void 0===b&&(b=255);c=c||[];for(var d=0;d<this.nodes.length;++d){var l=
this.nodes[d];l.bounding_box&&l.layers&b&&geo.testBBoxBBox(l.bounding_box,a)&&c.push(l)}return c};s.prototype.update=function(a){this.time+=a;this._root.propagate("update",[a]);this.destroyPendingNodes()};s.prototype.destroyPendingNodes=function(a){if(this._to_destroy.length)for(a=null;a=this._to_destroy.pop();)a._parent&&a._parent.removeChild(a)};Object.defineProperty(s.prototype,"root",{get:function(){return this._root},set:function(a){throw"Cannot set root of scene";},enumerable:!1});s.prototype.testRay=
function(a,b,c,d,l){s._ray_tested_objects=0;b||(b=v);return this.root.testRay(a,b,c,void 0===d?255:d,l)};s.prototype.fromJSON=function(a){this.root.clear();this.root.configure(a)};s.prototype.toJSON=function(a){function b(d,e){if(a){if(!a(d,e))return!1}else{if(!d.flags.no_transform){e.position=typedArrayToArray(d.position);if(0!=d.rotation[0]||0!=d.rotation[1]||0!=d.rotation[2]||1!=d.rotation[3])e.rotation=typedArrayToArray(d.rotation);if(1!=d.scaling[0]||1!=d.scaling[1]||1!=d.scaling[2])e.scaling=
typedArrayToArray(d.scaling)}d.id&&(e.id=d.id);d.ref=e.ref=c++;d.mesh&&(e.mesh=d.mesh);null!=d.submesh&&(e.submesh=d.submesh);d.draw_range&&(e.draw_range=d.draw_range.concat());d.material&&(e.material=d.material);d.shader&&(e.shader=d.shader);if(1!=d.color[0]||1!=d.color[1]||1!=d.color[2]||1!=d.color[3])e.color=typedArrayToArray(d.color);0<Object.values(d.textures).filter(function(a){return a})&&(e.shader=d.shader);d.extra&&(e.extra=d.extra);e.layers=d.layers;e.flags=d.flags}if(!d.children.length)return!0;
for(var f=[],g=0;g<d.children.length;++g){var k={};b(d.children[g],k)&&f.push(k)}f.length&&(e.children=f);return!0}a&&a.constructor!==Function&&(a=null);var c=0,d={};b(this.root,d);return d};Object.defineProperty(p.prototype,"color",{set:function(a){this._color.set(a)},get:function(){return this._color},enumerable:!0});Object.defineProperty(p.prototype,"opacity",{get:function(){return this._color[3]},set:function(a){this._color[3]=a},enumerable:!0});p.prototype.render=function(a,b,c,d,e){(b=gl.shaders[this.shader_name])||
(b=this.textures.color?a._texture_shader:a._flat_shader);var f=0,g=null,x;for(x in this.textures){var k=this.textures[x];if(k){var h="u_"+x+"_texture";if(!b||b.samplers[h])g=gl.textures[k],g||(a.autoload_assets&&-1!=k.indexOf(".")&&a.loadTexture(k,a.default_texture_settings),g=gl.textures.white),this.uniforms[h]=g.bind(f++)}}a.enableItemFlags(this);b.uniforms(a._uniforms);b.uniforms(this.uniforms);x=null;null!=e&&c.info&&c.info.groups&&c.info.groups[e]&&(x=c.info.groups[e]);x?b.drawRange(c,this.primitive,
x.start,x.length,d):b.draw(c,this.primitive,d);a.disableItemFlags(this)};e.Material=p;e.Renderer=f;Object.defineProperty(f.prototype,"color",{set:function(a){this._color.set(a)},get:function(){return this._color},enumerable:!0});f.prototype.setDataFolder=function(a){a?(this.assets_folder=a,"/"!=this.assets_folder.substr(-1)&&(this.assets_folder+="/")):this.assets_folder=""};f.prototype.clear=function(a){a?this.gl.clearColor(a[0],a[1],a[2],3<=a.length?a[3]:1):this.gl.clearColor(0,0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|
gl.DEPTH_BUFFER_BIT)};f._sort_by_dist_func=function(a,b){return b._distance-a._distance};f._sort_by_priority_func=function(a,b){return b.render_priority-a.render_priority};f._sort_by_priority_and_dist_func=function(a,b){var c=b.render_priority-a.render_priority;return 0!=c?c:b._distance-a._distance};f.prototype.render=function(a,b,c,d){void 0===d&&(d=255);if(!a)throw"Renderer.render: scene not provided";if(this._current_scene)throw this._current_scene=null,"Cannot render an scene while rendering an scene";
b=b||a.camera;if(!b)throw"Renderer.render: camera not provided";z.gl=this.gl;this._nodes.length=0;c||a._root.getVisibleChildren(this._nodes,d);c=c||this._nodes;if(c.length){this.enableCamera(b);this.enable2DView();this._state=[];this._meshes_missing=0;this._current_scene=a;this._uniforms.u_time=a.time;this.sort_by_distance&&c.forEach(function(a){a._distance=a.getDistanceTo(b._position)});var l=this;c=c.filter(function(a){return!a.mustRender||!1!=a.mustRender(l,b)});this.sort_by_distance&&this.sort_by_priority?
c.sort(e.Renderer._sort_by_priority_and_dist_func):this.sort_by_priority?c.sort(e.Renderer._sort_by_priority_func):this.sort_by_distance&&c.sort(e.Renderer._sort_by_dist_func);a._root.preRender&&a._root.preRender(this,b);for(var f=0;f<c.length;++f){var g=c[f];g.updateGlobalMatrix(!0);if(this.onPreRenderNode)this.onPreRenderNode(g,b);g.preRender&&g.preRender(this,b)}for(f=0;f<c.length;++f)g=c[f],g.flags.was_rendered=!1,!1!==g.flags.visible&&g.layers&d&&(!this.mustRenderNode||!1!==this.mustRenderNode(g,
b))&&(g.flags.was_rendered=!0,this.setModelMatrix(g._global_matrix),g.render?g.render(this,b):this.renderNode(g,b),this.draw_calls+=1);a._root.postRender&&a._root.postRender(this,b);for(f=0;f<c.length;++f)if(g=c[f],g.postRender&&g.postRender(this,b),this.onPostRenderNode)this.onPostRenderNode(g,b);if(this.onPostRender)this.onPostRender(b);a.frame++;this.frame++;this._current_scene=null}else a.frame++,this.frame++};f.prototype.enableCamera=function(a){this._camera=a;a.updateMatrices();a.extractPlanes();
this._view_matrix.set(a._view_matrix);this._projection_matrix.set(a._projection_matrix);this._viewprojection_matrix.set(a._viewprojection_matrix);this._uniforms.u_camera_position=a.position};f.prototype.enable2DView=function(){mat4.ortho(this._viewprojection2D_matrix,0,gl.viewport_data[2],0,gl.viewport_data[3],-1,1)};f.prototype.saveState=function(){this.state.push({camera:this._camera,nodes:this._nodes})};f.prototype.restoreState=function(){var a=this.state.pop(),b=this.camera=a.camera;this._view_matrix.set(b._view_matrix);
this._projection_matrix.set(b._projection_matrix);this._viewprojection_matrix.set(b._viewprojection_matrix);this._uniforms.u_camera_position=b.position;this._nodes=a.nodes};f.prototype.setModelMatrix=function(a){this._model_matrix.set(a);mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,a)};f.prototype.setGlobalUniforms=function(a){for(var b in a)this._uniforms[b]&&this._uniforms[b].set?this._uniforms[b].set(a[b]):this._uniforms[b]=a[b]};var G={u_model:null};f.prototype.renderNode=function(a,
b){var c=null;a._mesh?c=a._mesh:a.mesh&&(c=gl.meshes[a.mesh],c||(this._meshes_missing++,this.autoload_assets&&-1!=a.mesh.indexOf(".")&&this.loadMesh(a.mesh)));if(a.primitives){if(c)for(var d=0;d<a.primitives.length;++d){var l=e.Materials[a.primitives[d].material];l&&this.renderMeshWithMaterial(a._global_matrix,c,l,"triangles",d)}}else if(a.material)(l=e.Materials[a.material])&&this.renderMeshWithMaterial(a._global_matrix,c,l,a.indices,a.submesh);else if(c){l=!1;a._instances&&(1<gl.webgl_version||
gl.extensions.ANGLE_instanced_arrays)&&(l=!0);var f=null,g=a.shader;this.on_getShader&&(f=this.on_getShader(a,b));!f&&a.shader&&(f=gl.shaders[g]);this.shader_overwrite&&(f=gl.shaders[this.shader_overwrite]);f||(f=a.textures.color?this._texture_shader:this._flat_shader);l&&!f.attributes.u_model&&(l=!1);var g=0,k=null;for(d in a.textures){var h=a.textures[d];if(h){var m="u_"+d+"_texture";if(!f||f.samplers[m])k=gl.textures[h],k||(this.autoload_assets&&-1!=h.indexOf(".")&&this.loadTexture(h,this.default_texture_settings),
k=gl.textures.white),a.flags.pixelated?(k.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST)):!1===a.flags.pixelated&&(k.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR)),a._uniforms[m]=k.bind(g++)}}this.ignore_flags||this.enableItemFlags(a);if(a.onRender)a.onRender(this,b,f);f.uniforms(this._uniforms);this.skip_node_uniforms||
f.uniforms(a._uniforms);if(a.onShaderUniforms)a.onShaderUniforms(this,f);if(this.onNodeShaderUniforms)this.onNodeShaderUniforms(this,f,a);d=null;null!=a.submesh&&c.info&&c.info.groups&&c.info.groups[a.submesh]&&(d=c.info.groups[a.submesh]);l?(G.u_model=a._instances,d?f.drawInstanced(c,void 0===a.primitive?gl.TRIANGLES:a.primitive,a.indices,G,d.start,d.length):a.draw_range?f.drawInstanced(c,void 0===a.primitive?gl.TRIANGLES:a.primitive,a.indices,G,a.draw_range[0],a.draw_range[1]):f.drawInstanced(c,
void 0===a.primitive?gl.TRIANGLES:a.primitive,a.indices,G)):d?f.drawRange(c,void 0===a.primitive?gl.TRIANGLES:a.primitive,d.start,d.length,a.indices):a.draw_range?f.drawRange(c,void 0===a.primitive?gl.TRIANGLES:a.primitive,a.draw_range[0],a.draw_range[1],a.indices):f.draw(c,void 0===a.primitive?gl.TRIANGLES:a.primitive,a.indices);this.ignore_flags||this.disableItemFlags(a)}else if(a.onRender)a.onRender(this,b)};f.prototype.renderMesh=function(a,b,c,d,l,f,g,k){b&&(d&&this._uniforms.u_color.set(d),
a||(a=e.IDENTITY),this._uniforms.u_model.set(a),l||(l=c?gl.shaders.texture:gl.shaders.flat),c&&(this._uniforms.u_texture=c.bind(0)),l.uniforms(this._uniforms),l.draw(b,void 0===f?gl.TRIANGLES:f,g))};f.prototype.renderMeshWithMaterial=function(a,b,c,d,e){c.render(this,a,b,d,e)};f.prototype.renderBounding=function(a,b){if(a){var c=this._uniforms.u_model,d=a._bounding,e=d.subarray(3,6);mat4.translate(c,b,d.subarray(0,3));mat4.scale(c,c,[2*e[0],2*e[1],2*e[2]]);this.renderMesh(c,gl.meshes.cube,null,[1,
1,0,1],null,gl.LINES,"wireframe")}};f.prototype.enableItemFlags=function(a){var b=a.flags.flip_normals;this.reverse_normals&&(b=!b);gl.frontFace(b?gl.CW:gl.CCW);gl[!1===a.flags.depth_test?"disable":"enable"](gl.DEPTH_TEST);!1===a.flags.depth_write&&gl.depthMask(!1);gl[!0===a.flags.two_sided?"disable":"enable"](gl.CULL_FACE);if(a.blend_mode!==e.BLEND_NONE)switch(gl.enable(gl.BLEND),a.blend_mode){case e.BLEND_ALPHA:gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);break;case e.BLEND_ADD:gl.blendFunc(gl.SRC_ALPHA,
gl.ONE);break;case e.BLEND_MULTIPLY:gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA)}else gl.disable(gl.BLEND)};f.prototype.disableItemFlags=function(a){a.flags.flip_normals&&gl.frontFace(gl.CCW);!1===a.flags.depth_test&&gl.enable(gl.DEPTH_TEST);a.blend_mode!==e.BLEND_NONE&&gl.disable(gl.BLEND);a.flags.two_sided&&gl.disable(gl.CULL_FACE);!1===a.flags.depth_write&&gl.depthMask(!0)};f.prototype.setPointSize=function(a){this.point_size=a;gl.shaders.point.uniforms({u_pointSize:this.point_size})};e.Renderer.prototype.renderPoints=
function(a,b,c,d,l,f,g){if(!a||a.constructor!==Float32Array)throw"RD.renderPoints only accepts Float32Array";l||(l=this.shaders._points,l||(l=this.shaders._points=new GL.Shader(e.points_vs_shader,e.points_fs_shader),l.uniforms({u_texture:0,u_atlas:1,u_pointSize:1})));f=f||1;var k=1024;d=d||a.length/3;var h=null,m=null,n=this._points_mesh;d>a.length/3&&(d=a.length/3);!n||a.length>3*k?(d>k&&(k=GL.Texture.nextPOT(d)),h=new Float32Array(3*k),m=new Float32Array(4*k),n=this._points_mesh=GL.Mesh.load({vertices:h,
extra4:m})):(h=this._points_mesh.getBuffer("vertices").data,m=this._points_mesh.getBuffer("extra4").data);h.set(h.length>a.length?a:a.subarray(0,h.length));b?m.set(m.length>b.length?b:b.subarray(0,m.length)):m.fill&&m.fill(0);n.upload(GL.DYNAMIC_STREAM);l.setUniform("u_color",this._color);l.setUniform("u_pointSize",f);l.setUniform("u_camera_perspective",c._projection_matrix[5]);l.setUniform("u_viewport",gl.viewport_data);l.setUniform("u_viewprojection",c._viewprojection_matrix);l.drawRange(n,void 0!==
g?g:GL.POINTS,0,d);return n};e.points_vs_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec4 v_extra4;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tv_pos = a_vertex;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tgl_PointSize = computePointSize( u_pointSize, gl_Position.w );\n}\n";
e.points_fs_shader="\nprecision highp float;\nuniform vec4 u_color;\n\nvoid main() {\n\tgl_FragColor = u_color;\n}\n";f.prototype.loadMesh=function(a,b){if(!a)return console.error("loadMesh: Cannot load null name");if(!this.assets_loading[a]&&!this.assets_not_found[a]){var c=this.meshes[a];if(c)return b&&b(c),c;var d=this,c=a;-1==c.indexOf("://")&&(c=this.assets_folder+a);c=GL.Mesh.fromURL(c,function(c){c?d.meshes[a]=c:(d.assets_not_found[a]=!0,delete d.meshes[a]);d.num_assets_loading--;delete d.assets_loading[a];
b&&b(c,a)});this.assets_loading[a]=c;this.num_assets_loading++;return this.meshes[a]=c}};f.prototype.loadTexture=function(a,b,c){function d(b){g.debug&&console.log(" + texture loaded: "+a);b?g.textures[e]=b:g.assets_not_found[a]=!0;c&&c(b,e);g.num_assets_loading--;delete g.assets_loading[a];if(g.on_texture_load)g.on_texture_load(b,e)}if(!a)return console.error("loadTexture: Cannot load null name");if(!this.assets_loading[a]&&!this.assets_not_found[a]){var e=a;b&&(b.name&&(e=b.name),b.preview&&(e=
b.preview));var f=this.textures[e];if(f&&!f.is_preview)return c&&c(f),f;var g=this,f=a;-1==f.indexOf("://")&&(f=this.assets_folder+a);var k=null,k=-1!=a.indexOf("CUBEMAP")?GL.Texture.cubemapFromURL(f,this.default_cubemap_settings,d):GL.Texture.fromURL(f,b,d);b&&b.preview&&(k.is_preview=!0);this.assets_loading[a]=k;this.num_assets_loading++;return this.textures[e]=k}};f.prototype.loadTextureAtlas=function(a,b,c){"string"==typeof a&&(a=JSON.parse(a));var d=this;-1==b.indexOf("://")&&(b=this.assets_folder+
b);GL.Texture.fromURL(b,null,function(b){var e=a.files;d.textures[":atlas"]=b;for(var f in e)if(!d.textures[f]||d.textures[f].is_preview){var g=e[f],k=new GL.Texture(a.size,a.size,{wrap:gl.REPEAT,filter:gl.LINEAR});k.drawTo(function(){b.gl.drawTexture(b,0,0,a.size,a.size,g.x,g.y,g.width||a.size,g.height||a.size)});k.is_preview=!0;d.textures[f]=k}c&&c(e)})};f.prototype.loadShaders=function(a,b,c){var d=this;-1==a.indexOf("://")&&(a=this.assets_folder+a);this.loading_shaders=!0;GL.loadFileAtlas(a,function(a){d.compileShadersFromAtlas(a,
c);d.loading_shaders=!1;b&&b(a)})};f.prototype.compileShadersFromAtlas=function(a,b){var c=a.shaders;if(c){for(var d in a)a[d]=GL.Shader.expandImports(a[d],a);c=c.split("\n");for(d=0;d<c.length;++d){var e=c[d].trim().split(" "),f=e[0].trim();if("//"!=f.substr(0,2)){var g=a[e[1]],k=a[e[2]],h=null,m={};if(3<e.length)for(var n=3;n<e.length;++n)if("#"==e[n][0])m[e[n].substr(1)]=!0;else{h=e.slice(n).join(" ");break}if(!m.WEBGL1||1==gl.webgl_version)if(!m.WEBGL2||2==gl.webgl_version){e[1]&&"@"==e[1][0]&&
(m=e[1].substr(1)+"_VERTEX_SHADER",GL.Shader[m]&&(g=GL.Shader[m]));e[2]&&"@"==e[2][0]&&(m=e[2].substr(1)+"_FRAGMENT_SHADER",GL.Shader[m]&&(k=GL.Shader[m]));if(h)try{h=JSON.parse(h)}catch(q){console.error("Error in shader macros: ",f,h,q)}if(h&&b){var m={},A;for(A in h)m[A]=h[A];for(A in b)m[A]=b[A];h=m}else b&&(h=b);try{g&&k?this.shaders[f]?this.shaders[f].updateShader(g,k,h):this.shaders[f]=new GL.Shader(g,k,h):console.warn("Shader subfile not found: ",e[1],e[2])}catch(p){GL.Shader.dumpErrorToConsole(p,
g,k)}}}}}else console.warn("No 'shaders' found in shaders file atlas, check documentation")};f.prototype.setShadersFromFile=function(a){a=GL.processFileAtlas(a);this.compileShadersFromAtlas(a)};f.prototype.drawSphere3D=function(a,b,c){gl.meshes.sphere||(gl.meshes.sphere=GL.Mesh.sphere({slices:32}));var d=gl.shaders.flat;d.setUniform("u_color",c);d.setUniform("u_viewprojection",this._viewprojection_matrix);mat4.identity(n);mat4.translate(n,n,a);mat4.scale(n,n,[b,b,b]);d.setUniform("u_model",n);d.draw(gl.meshes.sphere)};
f.prototype.drawCircle2D=function(a,b,c,d,e){gl.meshes.circle||(gl.meshes.circle=GL.Mesh.circle({radius:1,slices:32}));gl.meshes.ring||(gl.meshes.ring=GL.Mesh.ring({radius:1,thickness:0.02,slices:64}));var f=gl.shaders.flat;f.setUniform("u_color",d);f.setUniform("u_viewprojection",this._viewprojection2D_matrix);mat4.identity(n);mat4.translate(n,n,[a,b,0]);mat4.scale(n,n,[2*c,2*c,2*c]);f.setUniform("u_model",n);f.draw(gl.meshes[e?"circle":"ring"])};f.prototype.drawLine2D=function(a,b,c,d,f,g,k){var h=
gl.meshes.plane;k=k||gl.shaders.flat;k.setUniform("u_color",g);k.setUniform("u_viewprojection",this._viewprojection2D_matrix);var m=c-a,q=d-b;g=Math.atan2(m,q);m=Math.sqrt(m*m+q*q);f/=2;mat4.identity(n);mat4.translate(n,n,[0.5*(a+c),0.5*(b+d),0]);mat4.rotate(n,n,g,e.FRONT);a=f;mat4.scale(n,n,[a,m,a]);k.setUniform("u_model",n);k.draw(h)};e.sortByDistance=function(a,b){a.forEach(function(a){a._distance=a.getDistanceTo(b)});a.sort(function(a,b){return b._distance-a._distance})};e.noBlending=function(a){return a.blend_mode===
e.BLEND_NONE};e.generateTextureAtlas=function(a,b,c,d,e){b=b||1024;c=c||1024;d=d||64;var f=0,g;for(g in a)f++;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);var f=new GL.Texture(b,c),k={width:b,height:c,size:d,files:{}},h=0,m=0,n={};f.drawTo(function(){for(var f in a)if(":"!=f[0]&&"white"!=f&&"black"!=f&&"notfound"!=f){var g=a[f];if(!g.is_preview&&g.texture_type==gl.TEXTURE_2D){if(e){var q=g.toBase64().hashCode();if(n[q]){k.files[f]=k.files[n[q]];continue}n[q]=f}k.files[f]=
{x:h,y:m};g.renderQuad(h,m,d,d);h+=d;if(h==b&&(h=0,m+=d,m==c)){console.warn("Atlas too small, some textures wont be stored.");break}}}});f.info=k;console.log(k);return f};f.prototype.computeResourcesLoaded=function(a){var b=0,c;for(c in a){var d=a[c],e=this.textures[d];e&&!1===e.ready||(d=this.meshes[d])&&!1===d.ready||(e||d)&&b++}return b};Object.defineProperty(f.prototype,"meshes",{get:function(){return this.gl.meshes},set:function(a){},enumerable:!0});Object.defineProperty(f.prototype,"textures",
{get:function(){return this.gl.textures},set:function(a){},enumerable:!0});Object.defineProperty(f.prototype,"shaders",{get:function(){return this.gl.shaders},set:function(a){},enumerable:!0});f.prototype.addMesh=function(a,b){b.gl!=this.gl&&(b=b.cloneShared(this.gl));this.gl.meshes[a]=b};e.Renderer=f;e.Ray=A;A.prototype.testPlane=function(a,b){return geo.testRayPlane(this.origin,this.direction,a,b,this.collision_point)};A.prototype.testSphere=function(a,b,c){return geo.testRaySphere(this.origin,
this.direction,a,b,this.collision_point,c)};A.prototype.closestPointOnRay=function(a,b,c){c=c||vec3.create();var d=vec3.create();vec3.add(d,this.origin,this.direction);var e=vec3.create();vec3.add(e,a,b);geo.closestPointBetweenLines(this.origin,d,a,e,null,c);return c};e.Factory=function(a,b,c){a=e.Factory.templates[a];var d=new e.SceneNode;a&&d.configure(a);b&&(b.constructor===e.Scene?b.root:b).addChild(d);c&&d.configure(c);return d};e.Factory.templates={grid:{mesh:"grid",primitive:1,color:[0.5,0.5,
0.5,0.5],blend_mode:e.BLEND_ALPHA},mesh:{shader:"phong"},sphere:{mesh:"sphere",shader:"phong"},floor:{mesh:"planeXZ",scaling:10,shader:"phong"}};k.prototype._ctor=function(){g.prototype._ctor.call(this);this.vertices=[];this.normals=[];this.coords=[];this.indices=[];this._vertices_data=new Float32Array(3072);this._indices_data=this._coords_data=this._normals_data=null;this._total_indices=this._total=0;this._mesh=GL.Mesh.load({vertices:this._vertices_data})};k.prototype.updateVertices=function(a){a&&
(this.vertices=a);this._total=this.vertices.length;this._vertices_data.length<this.vertices.length&&(this._vertices_data=new Float32Array(2*this.vertices.length),this._mesh.getBuffer("vertices").data=this._vertices_data);this._vertices_data.set(this.vertices);this._mesh.getBuffer("vertices").upload(GL.STREAM_DRAW)};k.prototype.updateNormals=function(a){a&&(this.normals=a);if(!this._normals_data||this._normals_data.length<this.normals.length)this._normals_data=new Float32Array(2*this.normals.length),
this._mesh.getBuffer("normals")||this._mesh.createVertexBuffer("normals",null,3,this._normals_data,GL.STREAM_DRAW);this._normals_data.set(this.normals);this._mesh.getBuffer("normals").upload(GL.STREAM_DRAW)};k.prototype.updateCoords=function(a){a&&(this.coords=a);if(!this._coords_data||this._coords_data.length<this.normals.length)this._coords_data=new Float32Array(2*this.coords.length),this._mesh.getBuffer("coords")||this._mesh.createVertexBuffer("coords",null,2,this._coords_data,GL.STREAM_DRAW);
this._coords_data.set(this.coords);this._mesh.getBuffer("coords").upload(GL.STREAM_DRAW)};k.prototype.updateIndices=function(a){a&&(this.indices=a);if(!this._indices_data||this._indices_data.length<this.indices.length)this._indices_data=new Float32Array(2*this.indices.length),this._mesh.getIndexBuffer("triangles")||this._mesh.createIndicesBuffer("triangles",this._indices_data,GL.STREAM_DRAW);this._indices_data.set(this.indices);this._mesh.getIndexBuffer("triangles").upload(GL.STREAM_DRAW);this._total_indices=
a.length};k.prototype.render=function(a,b){if(this._total){var c=a.shaders[this.shader||"flat"];if(c){a.setModelMatrix(this._global_matrix);var d=this._mesh,e=this._total_indices?this._total_indices:this._total/3;a.enableItemFlags(this);c.uniforms(a._uniforms).uniforms(this._uniforms).drawRange(d,void 0===this.primitive?GL.TRIANGLES:this.primitive,0,e,this._total_indices?"triangles":null);a.disableItemFlags(this)}}};extendClass(k,g);e.DynamicMeshNode=k;q.prototype._ctor=function(){g.prototype._ctor.call(this);
this.mesh="plane";this.size=vec2.fromValues(0,0);this.sprite_pivot=e.TOP_LEFT;this.blend_mode=e.BLEND_ALPHA;this.flags.two_sided=!0;this.flags.flipX=!1;this.flags.flipY=!1;this.flags.pixelated=!1;this.shader="texture_transform";this._angle=0;this.frame=null;this.frames={};this.texture_matrix=mat3.create();this._uniforms.u_texture_matrix=this.texture_matrix};Object.defineProperty(q.prototype,"angle",{get:function(){return this._angle},set:function(a){this._angle=a;quat.setAxisAngle(this._rotation,
e.FRONT,this._angle*B);this._must_update_matrix=!0},enumerable:!0});q.prototype.setSize=function(a,b){this.size[0]=a;this.size[1]=b};q.createFrames=function(a,b,c){c=c||{};var d;a.constructor!=Number?(num_columns=a[0],d=a[1]):d=num_columns=a;var e=a=0,f=1/num_columns,g=1/d;d*=num_columns;if(!b){b=[];for(var k=0;k<d;++k)b.push(String(k))}for(k=0;k<b.length&&!(c[b[k]]={pos:[a,e],size:[f,g],normalized:!0},a+=f,1<=a&&(a=0,e+=g),1<=e);++k);return c};q.prototype.createFrames=function(a,b){q.createFrames(a,
b,this.frames)};q.prototype.addFrame=function(a,b,c,d,e,f){this.frames[a]={pos:vec2.fromValues(b,c),size:vec2.fromValues(d,e),normalized:!!f}};q.prototype.updateTextureMatrix=function(a){mat3.identity(this.texture_matrix);if(!this.texture)return!1;var b=a.textures[this.texture];if(!b&&a.autoload_assets){var c=this;-1!=this.texture.indexOf(".")&&a.loadTexture(this.texture,a.default_texture_settings,function(a){a&&0==c.size[0]&&0==c.size[0]&&c.setSize(a.width,a.height)});b=gl.textures.white}if(!b)return!1;
a=this.texture_matrix;var d=this.current_frame=this.frames[this.frame];if(null!==this.frame&&!d)return!1;if(!d)return this.flags.flipX&&(u[0]=this.flags.flipX?1:0,u[1]=0,mat3.translate(a,a,u),u[0]=this.flags.flipX?-1:1,u[1]=1,mat3.scale(a,a,u)),!0;if(d.normalized)u[0]=this.flags.flipX?d.pos[0]+d.size[0]:d.pos[0],u[1]=1-d.pos[1]-d.size[1],mat3.translate(a,a,u),u[0]=d.size[0]*(this.flags.flipX?-1:1),u[1]=d.size[1];else{var e=b.height;u[0]=(this.flags.flipX?d.pos[0]+d.size[0]:d.pos[0])/b.width;u[1]=
(e-d.pos[1]-d.size[1])/e;mat3.translate(a,a,u);u[0]=d.size[0]*(this.flags.flipX?-1:1)/b.width;u[1]=d.size[1]/b.height}mat3.scale(a,a,u);return!0};q.prototype.render=function(a,b){if(this.texture&&this.updateTextureMatrix(a)){var c=a.textures[this.texture];if(c){this.flags.pixelated&&(c.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));
this.billboard_mode&&e.orientNodeToCamera(this.billboard_mode,this,b,a);0==this.size[0]&&!1!==c.ready&&(this.size[0]=c.width);0==this.size[1]&&!1!==c.ready&&(this.size[1]=c.height);var c=this.size,d=0,f=0;n.set(this._global_matrix);var g=!1;this.current_frame&&this.current_frame.size&&(c=this.current_frame.size,g=this.current_frame.normalized);if(this.sprite_pivot){switch(this.sprite_pivot){case e.TOP_LEFT:d=0.5;f=-0.5;break;case e.TOP_CENTER:f=-0.5;break;case e.TOP_RIGHT:d=-0.5;break;case e.BOTTOM_LEFT:f=
d=0.5;break;case e.BOTTOM_CENTER:f=0.5;break;case e.BOTTOM_RIGHT:d=-0.5,f=0.5}mat4.translate(n,n,[d*c[0],f*c[1],0])}mat4.scale(n,n,[c[0]*(g?this.size[0]:1),c[1]*(g?this.size[1]:1),1]);a.setModelMatrix(n);a.renderNode(this,a,b)}}};extendClass(q,g);e.Sprite=q;E.prototype._ctor=function(){this.mesh="cube";this.shader="skybox";this.scaling=[10,10,10];this.flags.depth_test=!1;this.flags.two_sided=!0};E.prototype.render=function(a,b){this.position=b.position;this.updateGlobalMatrix(!0);a.setModelMatrix(this._global_matrix);
a.renderNode(this,b)};extendClass(E,g);e.Skybox=E;e.parseTextConfig=function(a){function b(a,e){for(var f=c.shift();f;)if(0==f.trim().length)f=c.shift();else{for(var g=0;"\t"==f[g]&&g<f.length;)g++;if(g<e)break;var k={children:[]};try{var h=f.trim();-1!=h.indexOf(":")&&(h="{"+h+"}");var m=new Function("return "+h);k.data=m()}catch(n){console.error(n)}g>=e&&(a&&a.children.push(k),f=b(k,g+1))}return f}var c=a.split("\n");a={data:"",children:[]};b(a,0);return a};f.prototype.createShaders=function(){var a=
this._vertex_shader="\t\t\t\tprecision highp float;\n\t\t\t\tattribute vec3 a_vertex;\n\t\t\t\tattribute vec3 a_normal;\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec3 v_pos;\n\t\t\t\tvarying vec3 v_normal;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\t#ifdef INSTANCING\n\t\t\t\t\tattribute mat4 u_model;\n\t\t\t\t#else\n\t\t\t\t\tuniform mat4 u_model;\n\t\t\t\t#endif\n\t\t\t\tuniform mat4 u_viewprojection;\n\t\t\t\tvoid main() {\n\t\t\t\t\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t\tgl_Position = u_viewprojection * vec4( v_pos , 1.0 );\n\t\t\t\t\tgl_PointSize = 2.0;\n\t\t\t\t}\t\t\t\t",
b="\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t";gl.shaders.flat=this._flat_shader=new GL.Shader(a,b);gl.shaders.flat_instancing=this._flat_instancing_shader=new GL.Shader(a,b,{INSTANCING:""});this._point_shader=new GL.Shader("\t\t\t\tprecision highp float;\t\t\t\tattribute vec3 a_vertex;\t\t\t\tuniform mat4 u_mvp;\t\t\t\tuniform float u_pointSize;\t\t\t\tvoid main() {\t\t\t\t\tgl_PointSize = u_pointSize;\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\t}\t\t\t\t",
"\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\t\t\t\t     discard;\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t\t\t");gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec4 a_color;\t\tvarying vec4 v_color;\t\tuniform vec4 u_color;\t\tuniform mat4 u_mvp;\t\tvoid main() {\t\t\tv_color = a_color * u_color;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t",
"\t\tprecision highp float;\t\tvarying vec4 v_color;\t\tvoid main() {\t\t  gl_FragColor = v_color;\t\t}\t");gl.shaders.color=this._color_shader;b="\t\tprecision highp float;\t\tvarying vec2 v_coord;\t\tuniform vec4 u_color;\t\tuniform sampler2D u_color_texture;\t\tuniform float u_global_alpha_clip;\t\tvoid main() {\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\tif(color.w < u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\t\t}\t";gl.shaders.texture=this._texture_shader=
new GL.Shader(a,b);gl.shaders.texture_instancing=this._texture_instancing_shader=new GL.Shader(a,b,{INSTANCING:""});this._texture_transform_shader=new GL.Shader("\t\tprecision highp float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t\tuniform mat4 u_mvp;\n\t\tuniform mat3 u_texture_matrix;\n\t\tvoid main() {\n\t\t\tv_coord = (u_texture_matrix * vec3(a_coord,1.0)).xy;\n\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\tgl_PointSize = 5.0;\n\t\t}\n\t\t",
"\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 u_color;\n\t\tuniform float u_global_alpha_clip;\n\t\tuniform sampler2D u_color_texture;\n\t\tvoid main() {\n\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\n\t\t\tif(color.w < u_global_alpha_clip)\n\t\t\t\tdiscard;\n\t\t\tgl_FragColor = color;\n\t\t}\t");gl.shaders.texture_transform=this._texture_transform_shader;this._phong_uniforms={u_ambient:vec3.create(),u_light_vector:vec3.fromValues(0.5442,0.6385,0.544),
u_light_color:e.WHITE};b=this._fragment_shader="\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec3 u_ambient;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_vector;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef TEXTURED\n\t\t\t\tuniform sampler2D u_color_texture;\n\t\t\t#endif\n\t\t\t#ifdef UNIFORMS\n\t\t\t\tUNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef TEXTURED\n\t\t\t\t\tcolor *= texture2D( u_color_texture, v_coord );\n\t\t\t\t#endif\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(u_light_vector,N));\n\t\t\t\t#ifdef EXTRA\n\t\t\t\t\tEXTRA\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color * (vec4(u_ambient,1.0) + NdotL * vec4(u_light_color,1.0));\n\t\t\t}\t";
gl.shaders.phong=this._phong_shader=new GL.Shader(a,b);this._phong_shader._uniforms=this._phong_uniforms;this._phong_shader.uniforms(this._phong_uniforms);gl.shaders.phong_instancing=this._phong_instancing_shader=new GL.Shader(a,b,{INSTANCING:""});this._phong_instancing_shader._uniforms=this._phong_uniforms;this._phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.textured_phong=this._textured_phong_shader=new GL.Shader(a,b,{TEXTURED:""});this._textured_phong_shader.uniforms(this._phong_uniforms);
gl.shaders.textured_phong_instancing=this._textured_phong_instancing_shader=new GL.Shader(a,b,{INSTANCING:"",TEXTURED:""});this._textured_phong_instancing_shader.uniforms(this._phong_uniforms);gl.shaders.normal=this._normal_shader=new GL.Shader(a,"\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4( normalize(v_normal),1.0);\n\t\t\t}\t");gl.shaders.uvs=this._uvs_shader=new GL.Shader(a,"\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(v_coord,0.0,1.0);\n\t\t\t}\t")};
e.orientNodeToCamera=function(a,b,c,d){if(a){if(a==e.BILLBOARD_CYLINDRIC||a==e.BILLBOARD_PARALLEL_CYLINDRIC){var f=null;a==e.BILLBOARD_CYLINDRIC?(f=b.getGlobalPosition(I),vec3.sub(v,c._position,f),u[0]=v[0],u[1]=v[2]):(u[0]=c._front[0],u[1]=c._front[2]);a=vec2.computeSignedAngle(u,e.FRONT2D);isNaN(a)||(mat4.rotateY(n,J,-a),b._global_matrix.set(n),mat4.setTranslation(b._global_matrix,b._position),mat4.scale(b._global_matrix,b._global_matrix,b._scale))}else a==e.BILLBOARD_PARALLEL_SPHERIC?(b._global_matrix.set(c._model_matrix),
mat4.setTranslation(b._global_matrix,b._position)):(mat4.lookAt(b._global_matrix,b._position,c.position,e.UP),mat4.invert(b._global_matrix,b._global_matrix)),mat4.scale(b._global_matrix,b._global_matrix,b._scale);d.setModelMatrix(b._global_matrix)}};e.readPixels=function(a,b){var c=new Image;c.src=a;c.onload=function(){var a=document.createElement("canvas");a.width=this.width;a.height=this.height;var c=a.getContext("2d");c.drawImage(this,0,0);a=c.getImageData(0,0,a.width,a.height);b(a,this)}};"undefined"==
typeof GL&&(mat4.rotateVec3=function(a,b,c){var d=c[0],e=c[1];c=c[2];a[0]=b[0]*d+b[4]*e+b[8]*c;a[1]=b[1]*d+b[5]*e+b[9]*c;a[2]=b[2]*d+b[6]*e+b[10]*c;return a},mat4.projectVec3=function(a,b,c){var d=c[0],e=c[1];c=c[2];var f=b[1]*d+b[5]*e+b[9]*c+b[13],g=b[2]*d+b[6]*e+b[10]*c+b[14],k=b[3]*d+b[7]*e+b[11]*c+b[15];a[0]=((b[0]*d+b[4]*e+b[8]*c+b[12])/k+1)/2;a[1]=(f/k+1)/2;a[2]=(g/k+1)/2;return a})})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
(function(z){function g(){this._ctor();this.points=[];this.max_points=1E3;this.draw_range=[0,3*this.max_points];this.shader="pointcloud";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.points_size=100;this._uniforms={u_pointSize:this.points_size,u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_points);this._extra=new Float32Array(3*this.max_points);
this._meshes={};this._last_point_id=this._accumulated_time=0}function h(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};this.blend_mode=RD.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=RD.PRIORITY_ALPHA;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=0.5;this.particles_acceleration=vec3.create();this.velocity_variation=
this.particles_end_scale=this.particles_start_scale=1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);this._meshes={};this._last_particle_id=this._accumulated_time=0}function s(){this._ctor()}function p(f){this._ctor();f&&this.configure(f)}extendClass(g,
RD.SceneNode);RD.PointCloud=g;g.prototype.render=function(f,h){if(0!=this.points.length){this.updateVertices();var k=this._meshes[f.gl.context_id];k||(k=new GL.Mesh(void 0,void 0,f.gl),this._vertices_buffer=k.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=k.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=k;this._vertices_buffer.uploadRange(0,12*this.points.length);this._extra_buffer.uploadRange(0,12*this.points.length);k=gl.shaders[this.shader];
k||(k=gl.shaders.pointcloud)||(gl.shaders.pointcloud=new GL.Shader(g._vertex_shader,g._pixel_shader));this.draw_range[1]=this.points.length;k=gl.getViewport();this._uniforms.u_pointSize=this.points_size/(gl.canvas.width/k[2]);this._uniforms.u_color=this.color;0<this.num_textures?(this._uniforms.u_texture_info[0]=1/this.num_textures,this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures):this._uniforms.u_texture_info[0]=0;this.ignore_transform&&(mat4.identity(f._model_matrix),f._mvp_matrix.set(f._viewprojection_matrix));
f.renderNode(this,f,h)}};g.prototype.updateVertices=function(f){if(f=this.points.length)for(var g=this._vertices,k=this._extra,h=0,p=this.num_textures*this.num_textures,r=0;r<f;r++){var m=this.points[r];g.set(m.pos?m.pos:m,h);k[h]=1;k[h+1]=1;1<p&&(k[h+2]=m.tex);h+=3}};g._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = abs(floor(v_coord.x) * u_texture_info.x);\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
g._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec2 uv = vec2(v_coord.x + gl_PointCoord.x * u_texture_info.x, v_coord.y + (1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  vec4 color = texture2D( u_color_texture, uv );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(h,RD.SceneNode);RD.ParticlesEmissor=h;h.prototype.update=function(f){var g=this.particles.length,k=this.particles_damping,h=this.particles_acceleration,p=vec3.length(h);if(g){for(var r=[],m=0;m<g;m++){var e=this.particles[m];vec3.scaleAndAdd(e.pos,e.pos,e.vel,f);p&&vec3.scaleAndAdd(e.vel,e.vel,h,f);k&&vec3.scaleAndAdd(e.vel,e.vel,e.vel,-f*k);e.ttl-=f;0<e.ttl&&r.push(e)}this.particles=r}g=this.getGlobalPosition();k=this.emissor_direction;h=this.particles_life;p=this.num_textures*this.num_textures;
r=this.velocity_variation;if(0<this.particles_per_second)for(f=this.particles_per_second*(f+this._accumulated_time),this._accumulated_time=(f-Math.floor(f))/this.particles_per_second,f=Math.floor(f),m=0;m<f&&!(this.particles.length>=this.max_particles);m++)k=vec3.clone(k),k[0]+=0.5*Math.random()*r,k[2]+=0.5*Math.random()*r,this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*p)/p,pos:vec3.clone(g),vel:k,ttl:h})};h.prototype.render=function(f,g){if(0!=this.particles.length){this.updateVertices();
var k=this._meshes[f.gl.context_id];k||(k=new GL.Mesh(void 0,void 0,f.gl),this._vertices_buffer=k.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=k.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=k;this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);k=gl.shaders[this.shader];k||(k=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(h._vertex_shader,h._pixel_shader));
this.draw_range[1]=this.particles.length;k=gl.getViewport();this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/k[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(f._model_matrix);f._mvp_matrix.set(f._viewprojection_matrix);f.renderNode(this,f,
g)}};h.prototype.updateVertices=function(f){if(f=this.particles.length)for(var g=this._vertices,k=this._extra,h=0,p=this.particles_life,r=this.num_textures*this.num_textures,m=0;m<f;m++){var e=this.particles[m];g.set(e.pos,h);k[h]=1;k[h+1]=e.ttl/p;1<r&&(k[h+2]=e.tex);h+=3}};h._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tuniform vec2 u_scaleStartEnd;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = floor(v_coord.x) * u_texture_info.x;\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = mix(u_scaleStartEnd.y, u_scaleStartEnd.x, a_extra3.y) * 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
h._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec4 color = texture2D( u_color_texture, v_coord + vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(s,RD.SceneNode);RD.Billboard=s;s.SPHERIC=1;s.PARALLEL_SPHERIC=2;s.CYLINDRIC=3;s.PARALLEL_CYLINDRIC=4;s.prototype._ctor=function(){this.billboard_mode=s.SPHERIC;this.auto_orient=!0;RD.SceneNode.prototype._ctor.call(this)};s.prototype.render=function(f,g){!1!==this.flags.visible&&(this.auto_orient&&RD.orientNodeToCamera(this.billboard_mode,this,g,f),f.renderNode(this,f,g))};p.prototype._ctor=function(){RD.SceneNode.prototype._ctor.call(this);this.size=1;this._atlas_size=vec2.fromValues(1,
1);this.max_sprites=1024;this.positions=new Float32Array(3*this.max_sprites);this.sprite_info=new Float32Array(4*this.max_sprites);this.index=0;this.shader=null;this.use_points=!1;this.mode=p.CYLINDRICAL;this.must_update_buffers=!0};RD.SpritesBatch=p;p.XY=0;p.XZ=1;p.CYLINDRICAL=2;p.SPHERICAL=3;p.FLAT=4;Object.defineProperty(p.prototype,"atlas_size",{get:function(){return this._atlas_size},set:function(f){this._atlas_size.set(f)}});p.prototype.clear=function(){this.index=0};p.prototype.add=function(f,
g,k,h,p){if(this.max_sprites<=this.index)console.warn("too many sprites in batch, increase size");else{var r=this.index;this.index+=1;this.positions.set(f,3*r);2==f.length&&(this.positions[3*r+2]=0);f=4*r;this.sprite_info[f]=g||0;this.sprite_info[f+1]=k?1:0;this.sprite_info[f+2]=null==h?1:h;this.sprite_info[f+3]=p||0;this.must_update_buffers=!0}};p.prototype.addData=function(f,g){if(this.max_sprites<=this.index)console.warn("too many sprites in batch, increase size");else{var k=this.index;this.index+=
1;this.positions.set(f,3*k);this.sprite_info.set(g,4*k);this.must_update_buffers=!0}};p.prototype.render=function(f,g){if(this.texture){var k=f.textures[this.texture];k&&this.flags.pixelated&&(k.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.flags.pixelated?gl.NEAREST:gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.flags.pixelated?gl.NEAREST_MIPMAP_NEAREST:gl.LINEAR_MIPMAP_LINEAR));this.renderSprites(k,g,this.size,this.atlas_size,this.color,this.mode)}};p.prototype.renderSprites=
function(f,g,k,h,s,r){if(this.index){var m=gl.shaders[this.shader];m||(m=gl.shaders[this.use_points?"point_sprites":"quad_sprites"]);m||(m=this.use_points?gl.shaders.point_sprites=new GL.Shader(p.point_sprites_vertex_shader,p.point_sprites_fragment_shader):gl.shaders.quad_sprites=new GL.Shader(p.quad_sprites_vertex_shader,p.quad_sprites_fragment_shader));r=r||0;if(this.use_points)m.uniforms(GFX.scene_renderer._uniforms),m.setUniform("u_pointSize",k),m.setUniform("u_atlas",h),m.setUniform("u_texture",
f.bind(0)),RD.renderPoints(this.positions,this.sprite_info,g,this.index,m);else{if(!this.vertex_buffer_data){this.vertex_buffer_data=new Float32Array(12*this.max_sprites);this.extra4_buffer_data=new Float32Array(16*this.max_sprites);for(var e=new Int8Array(8*this.max_sprites),B=new Int8Array([-1,1,1,1,-1,-1,1,-1]),t=0;t<e.length;t+=8)e.set(B,t);for(var B=new Int16Array([0,2,1,1,2,3]),z=new Uint16Array(6*this.max_sprites),t=0;t<z.length;++t)z[t]=B[t%6]+4*Math.floor(t/6);this.vertex_buffer=new GL.Buffer(gl.ARRAY_BUFFER,
this.vertex_buffer_data,3,gl.DYNAMIC_DRAW);this.extra4_buffer=new GL.Buffer(gl.ARRAY_BUFFER,this.extra4_buffer_data,4,gl.DYNAMIC_DRAW);this.extra2_buffer=new GL.Buffer(gl.ARRAY_BUFFER,e,2,gl.STATIC_DRAW);this.indices_buffer=new GL.Buffer(gl.ELEMENT_ARRAY_BUFFER,z,1,gl.STATIC_DRAW)}if(this.must_update_buffers){e=this.vertex_buffer_data;B=this.extra4_buffer_data;z=Math.min(this.index,this.positions.length/3);for(t=0;t<z;++t){var y=3*t,n=this.positions.subarray(y,y+3);e.set(n,4*y);e.set(n,4*y+3);e.set(n,
4*y+6);e.set(n,4*y+9);y=4*t;n=this.sprite_info.subarray(y,y+4);B.set(n,4*y);B.set(n,4*y+4);B.set(n,4*y+8);B.set(n,4*y+12)}this.vertex_buffer.uploadRange(0,48*this.index);this.extra4_buffer.uploadRange(0,64*this.index);this.must_update_buffers=!1}h=f.width/h[0]/(f.height/h[1]);t=RD.UP;e=RD.RIGHT;switch(r){case RD.SpritesBatch.SPHERICAL:t=g.getLocalVector(RD.UP);case RD.SpritesBatch.CYLINDRICAL:e=g.getLocalVector(RD.RIGHT);break;case RD.SpritesBatch.FLAT:t=g.getLocalVector(RD.FRONT);e=g.getLocalVector(RD.RIGHT);
break;case RD.SpritesBatch.XZ:t=RD.FRONT}m.bind();m.setUniform("u_model",RD.IDENTITY);m.setUniform("u_viewprojection",g._viewprojection_matrix);m.setUniform("u_color",s||RD.ONES4);m.setUniform("u_size",[k,k/h]);m.setUniform("u_top",t);m.setUniform("u_right",e);m.setUniform("u_atlas",this._atlas_size);m.setUniform("u_texture",f.bind(0));m.setUniform("u_itexsize",[1/f.width,1/f.height]);m.setUniform("u_viewport",gl.viewport_data);f=m.attributes.a_vertex;g=m.attributes.a_extra4;m=m.attributes.a_extra2;
this.vertex_buffer.bind(f);this.extra4_buffer.bind(g);this.extra2_buffer.bind(m);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indices_buffer.buffer);gl.drawElements(gl.TRIANGLES,6*this.index,gl.UNSIGNED_SHORT,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);this.vertex_buffer.unbind(f);this.extra4_buffer.unbind(g);this.extra2_buffer.unbind(m)}}};extendClass(p,RD.SceneNode);p.quad_sprites_vertex_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4; //frame,flipx,scale,extranum\nattribute vec2 a_extra2;//expanse direction\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\nuniform mat4 u_model;\nuniform mat4 u_viewprojection;\nuniform vec4 u_viewport;\nuniform vec2 u_size;\nuniform vec3 u_top;\nuniform vec3 u_right;\nuniform vec4 u_color;\nuniform vec2 u_atlas;\nuniform vec2 u_itexsize;\n\nvoid main() {\n\tvec3 vertex = a_vertex + a_extra4.z * u_size.y * u_top * a_extra2.y + a_extra4.z * u_size.x * u_right * a_extra2.x;\n\tvec2 uv = a_extra2;\n\tif( a_extra4.y != 0.0) //flip X\n\t\tuv.x *= -1.0;\n\tuv.x *= 1.0 - u_itexsize.x;\n\tuv.y *= -1.0;\n\tuv = uv * 0.5 + vec2(0.5);\n\t\n\tvec2 i_atlas = vec2(1.0) / u_atlas; \n\tfloat frame = a_extra4.x;\n\tfloat frame_x = mod( frame, u_atlas.x );\n\tfloat frame_y = floor( frame * i_atlas.x );\n\tuv.x = (uv.x + frame_x) * i_atlas.x;\n\tuv.y += frame_y;\n\tuv.y = 1.0 - uv.y * i_atlas.y;\n\tv_uv = uv;\n\tv_pos = (u_model * vec4(vertex,1.0)).xyz;\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\t//gl_Position.x = floor(gl_Position.x * u_viewport.z * 1.0) / (u_viewport.z * 1.0);\n\t//gl_Position.y = floor(gl_Position.y * u_viewport.w * 1.0) / (u_viewport.w * 1.0);\n}\n\n";
p.quad_sprites_fragment_shader="\nprecision highp float;\nprecision mediump int;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nuniform vec4 u_color;\nuniform sampler2D u_texture;\n\nvoid main() {\n\tvec4 color = texture2D( u_texture, v_uv );\n\tif(color.a < 0.1)\n\t\tdiscard;\n\tcolor *= u_color;\n\tgl_FragColor = color;\n}\n";p.point_sprites_vertex_shader="\nprecision highp float;\nattribute vec3 a_vertex;\nattribute vec4 a_extra4;\nvarying vec3 v_pos;\nvarying vec3 v_wPos;\nvarying vec4 v_extra4;\nuniform mat4 u_model;\nuniform mat4 u_mvp;\nuniform vec4 u_viewport;\nuniform float u_camera_perspective;\nuniform float u_pointSize;\n\nfloat computePointSize( float radius, float w )\n{\n\tif(radius < 0.0)\n\t\treturn -radius;\n\treturn u_viewport.w * u_camera_perspective * radius / w;\n}\n\nvoid main() {\n\tvec3 vertex = a_vertex;\t\n\tv_pos = vertex;\n\tv_wPos = (u_model * vec4(vertex,1.0)).xyz;\n\tv_extra4 = a_extra4;\n\tgl_Position = u_mvp * vec4(vertex,1.0);\n\tgl_Position.x = floor(gl_Position.x * u_viewport.z) / u_viewport.z;\n\tgl_Position.y = floor(gl_Position.y * u_viewport.w) / u_viewport.w;\n\tgl_PointSize = computePointSize( u_pointSize * u_extra4.z, gl_Position.w );\n}\n";
p.point_sprites_fragment_shader="\nprecision highp float;\nvarying vec3 v_pos;\nvarying vec3 v_wPos;\nvarying vec4 v_extra4; //id,flip,scale,extra\nuniform float u_atlas;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n\tfloat i_atlas = 1.0 / u_atlas;\n\tfloat frame = v_extra4.x;\n\tfloat x = frame * i_atlas;\n\tfloat y = floor(x);\n\tx = (x - y);\n\ty = y / u_atlas;\n\tif( v_extra4.y > 0.0 ) //must flip in x\n\t\tx -= gl_PointCoord.x * i_atlas - i_atlas;\n\telse\n\t\tx += gl_PointCoord.x * i_atlas;\n\t\n\tvec2 uv = vec2( x, 1.0 - (y + gl_PointCoord.y / u_atlas) );\n\tvec4 color = texture2D( u_texture, uv );\n\tif(color.a < 0.1)\n\t\tdiscard;\n\tgl_FragColor = color;\n}\n"})("undefined"!=
typeof window?window:"undefined"!=typeof self?self:global);
