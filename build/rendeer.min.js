'use strict';(function(B){function f(a){if(this.constructor!==e.SceneNode)throw"You must use new to create RD.SceneNode";this._ctor();a&&this.configure(a)}function s(a){this._ctor();a&&this.configure(a)}function u(){this._root=new e.SceneNode;this._root.flags.no_transform=!0;this._root._scene=this;this._nodes_by_id={};this._to_destroy=[];this.frame=this.time=0}function k(a,b){b=b||{};var c=this.gl=this.context=a;if(!c||!c.enable)throw"litegl GL context not found.";a!=B.gl&&c.makeCurrent();this.point_size=
5;this.sort_by_priority=!0;this.sort_by_distance=!1;this.assets_folder="";this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._mvp_matrix=mat4.create();this._model_matrix=mat4.create();this._nodes=[];this._uniforms={u_view:this._view_matrix,u_viewprojection:this._viewprojection_matrix,u_model:this._model_matrix,u_mvp:this._mvp_matrix,u_global_alpha_clip:0};B.gl=this.gl;this.canvas=c.canvas;this.assets_folder=b.assets_folder||"";this.autoload_assets=
void 0!==b.autoload_assets?b.autoload_assets:!0;this.default_texture_settings={wrap:c.REPEAT,minFilter:c.LINEAR_MIPMAP_LINEAR,magFilter:c.LINEAR};this.meshes.plane=GL.Mesh.plane({size:1});this.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});this.meshes.cube=GL.Mesh.cube({size:1,wireframe:!0});this.meshes.sphere=GL.Mesh.sphere({size:1,subdivisions:32,wireframe:!0});this.meshes.grid=GL.Mesh.grid({size:10});this.textures.notfound=this.default_texture=new GL.Texture(1,1,{filter:c.NEAREST,pixel_data:new Uint8Array([0,
0,0,255])});this.textures.white=this.default_texture=new GL.Texture(1,1,{filter:c.NEAREST,pixel_data:new Uint8Array([255,255,255,255])});this.num_assets_loading=0;this.assets_loading={};this.assets_not_found={};this.draw_calls=this.frame=0;this.createShaders();b.shaders_file&&this.loadShaders(b.shaders_file,null,b.shaders_macros)}function h(a){this.type=e.Camera.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this.near=0.1;
this.far=1E4;this.aspect=1;this.fov=45;this.frustum_size=50;this.flip_y=!1;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();this._autoupdate_matrices=!0;this._must_update_matrix=!1;this._top=vec3.create();this._right=vec3.create();this._front=vec3.create();a&&(a.position&&this._position.set(a.position),a.target&&this._target.set(a.target),a.up&&this._up.set(a.up),a.near&&(this.near=a.near),a.far&&(this.far=
a.far),a.fov&&(this.fov=a.fov),a.aspect&&(this.aspect=a.aspect));this.updateMatrices()}function y(a,b){return vec3.dot(a,b)+a[3]}function z(a,b,c){var d=a[3],g=Math.abs(c[0]*a[0]),A=Math.abs(c[1]*a[1]);c=Math.abs(c[2]*a[2]);g=g+A+c;a=vec3.dot(a,b)+d;return a<=-g?n:a<=g?D:E}function r(){this._ctor()}function w(){this._ctor();this.points=[];this.max_points=1E3;this.draw_range=[0,3*this.max_points];this.shader="pointcloud";this.textures={color:"white"};this.blend_mode=e.BLEND_ALPHA;this.flags.depth_write=
!1;this.render_priority=e.PRIORITY_ALPHA;this.num_textures=1;this.points_size=100;this._uniforms={u_pointSize:this.points_size,u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_points);this._extra=new Float32Array(3*this.max_points);this._meshes={};this._last_point_id=this._accumulated_time=0}function v(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};
this.blend_mode=e.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=e.PRIORITY_ALPHA;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=0.5;this.particles_acceleration=vec3.create();this.velocity_variation=this.particles_end_scale=this.particles_start_scale=1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=
gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);this._meshes={};this._last_particle_id=this._accumulated_time=0}var e=B.RD={version:0.5};e.ZERO=vec3.fromValues(0,0,0);e.ONE=vec3.fromValues(1,1,1);e.RIGHT=vec3.fromValues(1,0,0);e.LEFT=vec3.fromValues(-1,0,0);e.UP=vec3.fromValues(0,1,0);e.DOWN=vec3.fromValues(0,-1,0);e.FRONT=vec3.fromValues(0,0,-1);e.BACK=vec3.fromValues(0,0,1);e.FRONT2D=vec2.fromValues(0,1);e.WHITE=vec3.fromValues(1,
1,1);e.BLACK=vec3.fromValues(0,0,0);e.IDENTITY=mat4.create();e.PRIORITY_BACKGROUND=30;e.PRIORITY_OPAQUE=20;e.PRIORITY_ALPHA=10;e.PRIORITY_HUD=0;e.BLEND_NONE=0;e.BLEND_ALPHA=1;e.BLEND_ADD=2;e.BLEND_MULTIPLY=3;e.setup=function(a){a=a||{};if(e.configuration)throw"already called setup";e.configuration=a};var G=0,H=mat4.create();mat3.create();var C=mat4.create(),l=vec2.create(),q=vec3.create(),F=vec3.create();vec4.create();var x=quat.create();e.SceneNode=f;f.prototype._ctor=function(){this._uid=G++;this._id=
null;this._position=vec3.create();this._rotation=quat.create();this._scale=vec3.fromValues(1,1,1);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;this._bounding_box=null;this.render_priority=e.PRIORITY_OPAQUE;this.blend_mode=e.BLEND_NONE;this.layers=3;this._color=vec4.fromValues(1,1,1,1);this._uniforms={u_color:this._color,u_color_texture:0};this.primitive=GL.TRIANGLES;this.mesh=this.shader=this.onShaderUniforms=this.onRender=this.draw_range=null;this.textures=
{};this.flags={visible:!0,collides:!0};this.children=[]};f.prototype.clone=function(){var a=new this.constructor,b;for(b in this)if("_"!=b[0]&&!this.__lookupGetter__(b)&&"children"!=b){var c=this[b];void 0!==c&&(null===c?a[b]=null:c.constructor===Object?a[b]=GL.cloneObject(c):c.constructor===Array?a[b]=c.concat():a[b]!==c&&(a[b]=c))}return a};Object.defineProperty(f.prototype,"id",{get:function(){return this._id},set:function(a){this._scene?console.error("Cannot change id of a node already in a scene."):
this._id=a},enumerable:!0});Object.defineProperty(f.prototype,"uniforms",{get:function(){return this._uniforms},set:function(a){GL.cloneObject(a,this._uniforms);this._uniforms.u_color=this._color},enumerable:!0});Object.defineProperty(f.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(f.prototype,"x",{get:function(){return this._position[0]},set:function(a){this._position[0]=a;this._must_update_matrix=
!0},enumerable:!0});Object.defineProperty(f.prototype,"y",{get:function(){return this._position[1]},set:function(a){this._position[1]=a;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(f.prototype,"z",{get:function(){return this._position[2]},set:function(a){this._position[2]=a;this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(f.prototype,"rotation",{get:function(){return this._rotation},set:function(a){this._rotation.set(a);this._must_update_matrix=!0},enumerable:!0});
Object.defineProperty(f.prototype,"scaling",{get:function(){return this._scale},set:function(a){a.constructor===Number?this._scale[0]=this._scale[1]=this._scale[2]=a:this._scale.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(f.prototype,"pivot",{get:function(){return this._pivot},set:function(a){this._must_update_matrix=!0;a?(this._pivot||(this._pivot=vec3.create()),this._pivot.set(a),this.flags.pivot=!0):(this._pivot=null,this.flags.pivot=!1)},enumerable:!0});Object.defineProperty(f.prototype,
"color",{get:function(){return this._color},set:function(a){this._color.set(a)},enumerable:!0});Object.defineProperty(f.prototype,"opacity",{get:function(){return this._color[3]},set:function(a){this._color[3]=a},enumerable:!0});Object.defineProperty(f.prototype,"visible",{get:function(){return this.flags.visible},set:function(a){this.flags.visible=a},enumerable:!0});Object.defineProperty(f.prototype,"texture",{get:function(){return this.textures.color},set:function(a){this.textures.color=a},enumerable:!1});
Object.defineProperty(f.prototype,"scene",{get:function(){return this._scene},set:function(a){throw"cannot set scene, you must use addChild in its parent node";},enumerable:!1});Object.defineProperty(f.prototype,"parentNode",{get:function(){return this._parent},set:function(a){throw"Cannot set parentNode of SceneNode";},enumerable:!1});f.prototype.addChild=function(a,b){function c(a,b){a._scene=b;a.id&&b&&(b._nodes_by_id[a.id]=a);for(var A=0,e=a.children.length;A<e;A++)c(a.children[A],b)}if(a._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";
a._parent=this;b&&a.fromMatrix(a._global_matrix);this.children.push(a);c(a,this._scene)};f.prototype.removeChild=function(a,b){function c(a){a.id&&a._scene&&a._scene._nodes_by_id[a.id]&&delete a._scene._nodes_by_id[a.id];a._scene=null;for(var b=0,d=a.children.length;b<d;b++)c(a.children[b])}if(a._parent!=this)throw"removeChild: Not its children";var d=this.children.indexOf(a);if(-1==d)throw"removeChild: impossible, should be children";this.children.splice(d,1);a._parent=null;b&&a.fromMatrix(a._global_matrix);
c(a)};f.prototype.removeAllChildren=function(){for(;this.children.length;)this.removeChild(this.children[0])};f.prototype.clear=function(){for(;this.children.length;)this.removeChild(this.children[this.children.length-1])};f.prototype.setChildIndex=function(a,b){var c=this.children.indexOf(a);-1!=c&&(this.children.splice(c,1),this.children.splice(b,0,a))};f.prototype.getAllChildren=function(a){a=a||[];for(var b=0,c=this.children.length;b<c;b++){var d=this.children[b];a.push(d);d.getAllChildren(a)}return a};
f.prototype.getVisibleChildren=function(a,b){a=a||[];void 0===b&&(b=255);if(!1===this.flags.visible)return a;for(var c=0,d=this.children.length;c<d;c++){var g=this.children[c];g.layers&b&&a.push(g);g.getVisibleChildren(a,b)}return a};f.prototype.serialize=function(){for(var a={position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]},b=0,c=this.children.length;b<
c;b++)a.children.push(this.children[b].serialize());return a};f.prototype.configure=function(a){var b=null,c;for(c in a){switch(c){case "children":continue;case "uniforms":for(var d in a.uniforms)this.uniforms[d]=a.uniforms[d];continue;case "texture":this[c]=a[c];continue;case "scale":case "scaling":this.scale(a[c]);continue;case "parent":b=a[c];continue}var g=this[c];void 0!==g&&(g&&g.constructor===Float32Array?g.set(a[c]):this[c]=a[c])}this._must_update_matrix=!0;this.updateGlobalMatrix();if(a.children)for(c=
0;c<a.children.length;++c)console.warn("configure children: feature not implemented");b&&(this.parentNode?console.error("This node already has a parent"):b.addChild(this))};f.prototype.setMesh=function(a){a?"string"==typeof a?this.mesh=a:this._mesh=a:this.mesh=null};f.prototype.setTexture=function(a,b){b?"string"==typeof b&&(this.textures[a]=b):this.textures[a]=null};f.prototype.resetTransform=function(){this._position.set(e.ZERO);quat.identity(this._rotation);this._scale.set(e.ONE);this._must_update_matrix=
!0};f.prototype.translate=function(a){vec3.add(this._position,this._position,a);this._must_update_matrix=!0};f.prototype.rotate=function(a,b,c){quat.setAxisAngle(x,b,a);c?quat.multiply(this._rotation,x,this._rotation):quat.multiply(this._rotation,this._rotation,x);this._must_update_matrix=!0};f.prototype.scale=function(a){a.constructor===Number?(q[0]=q[1]=q[2]=a,vec3.mul(this._scale,this._scale,q)):vec3.mul(this._scale,this._scale,a);this._must_update_matrix=!0};f.prototype.setPivot=function(a){this.pivot=
a};f.prototype.orbit=function(a,b,c){if(!b)throw"RD: orbit axis missing";quat.setAxisAngle(x,b,a);this._must_update_matrix=!0};f.prototype.getLocalMatrix=function(){this._must_update_matrix&&this.updateLocalMatrix();return this._local_matrix};f.prototype.getGlobalMatrix=function(){this.updateGlobalMatrix();return this._global_matrix};f.prototype.getGlobalRotation=function(a){a=a||vec3.create();quat.identity(a);for(var b=this,c=this._scene?this._scene._root:null;b!=c;)quat.multiply(a,b._rotation,a),
b=b._parent;return a};f.prototype.updateLocalMatrix=function(){var a=this._local_matrix;this._must_update_matrix=!1;mat4.identity(a);this.flags.no_transform||(this.flags.pivot&&this._pivot&&(a[12]=this._pivot[0],a[13]=this._pivot[1],a[14]=this._pivot[2]),mat4.translate(a,a,this._position),mat4.fromQuat(C,this._rotation),mat4.multiply(a,a,C),mat4.scale(a,a,this._scale),this.flags.pivot&&this._pivot&&mat4.translate(a,a,[-this._pivot[0],-this._pivot[1],-this._pivot[2]]))};f.prototype.updateGlobalMatrix=
function(a,b){var c=null;this._must_update_matrix&&!this.flags.no_transform&&this.updateLocalMatrix();this._parent&&this._scene&&this._parent!=this._scene._root?(c=a?this._parent._global_matrix:this._parent.getGlobalMatrix(),this.flags.no_transform?this._global_matrix.set(c):mat4.multiply(this._global_matrix,c,this._local_matrix)):this._global_matrix.set(this._local_matrix);if(b)for(c=0;c<this.children.length;c++)this.children[c].updateGlobalMatrix(!0,b)};f.prototype.updateMatrices=function(a){this.updateLocalMatrix();
this.updateGlobalMatrix(a)};f.prototype.fromMatrix=function(a,b){if(b&&this._parent){mat4.copy(this._global_matrix,a);var c=this._parent.getGlobalMatrix();mat4.invert(c,c);a=mat4.multiply(this._local_matrix,c,a)}c=mat4.clone(a);mat4.multiplyVec3(this._position,c,[0,0,0]);var d=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(d,c,e.RIGHT));this._scale[1]=vec3.length(mat4.rotateVec3(d,c,e.UP));this._scale[2]=vec3.length(mat4.rotateVec3(d,c,e.BACK));mat4.scale(mat4.create(),c,[1/this._scale[0],
1/this._scale[1],1/this._scale[2]]);vec3.normalize(c.subarray(0,3),c.subarray(0,3));vec3.normalize(c.subarray(4,7),c.subarray(4,7));vec3.normalize(c.subarray(8,11),c.subarray(8,11));c=mat3.fromMat4(mat3.create(),c);mat3.transpose(c,c);quat.fromMat3(this._rotation,c);quat.normalize(this._rotation,this._rotation);a!=this._local_matrix&&mat4.copy(this._local_matrix,a);this._must_update_matrix=!1};f.prototype.getLocalPoint=function(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateLocalMatrix();
return vec3.transformMat4(b,a,this._local_matrix)};f.prototype.getLocalVector=function(a,b){b=b||vec3.create();return vec3.transformQuat(b,a,this._rotation)};f.prototype.getGlobalPosition=function(a,b){a=a||vec3.create();if(b)return vec3.transformMat4(a,e.ZERO,this._global_matrix);if(this._parent==this._scene._root)return a.set(this._position),a;var c=this.getGlobalMatrix();return vec3.transformMat4(a,e.ZERO,c)};f.prototype.getGlobalPoint=function(a,b){b=b||vec3.create();var c=this.getGlobalMatrix();
return vec3.transformMat4(b,a,c)};f.prototype.localToGlobal=f.prototype.getGlobalPoint;f.prototype.getGlobalVector=function(a,b){b=b||vec3.create();var c=this.getGlobalRotation(x);return vec3.transformQuat(b,a,c)};f.prototype.getDistanceTo=function(a){var b=this.getGlobalMatrix();return vec3.distance(a,b.subarray(12,15))};f.prototype.findNode=function(a){for(var b=0,c=this.children.length;b<c;b++){var d=this.children[b];if(d.id==a||(d=d.findNode(a)))return d}return null};f.prototype.propagate=function(a,
b){for(var c=0,d=this.children.length;c<d;c++){var g=this.children[c];g&&(g[a]&&g[a].apply(g,b),g.children&&g.children.length&&g.propagate(a,b))}};f.prototype.loadTextConfig=function(a,b){GL.request(a,null,function(a){a=e.parseTextConfig(a);b&&b(a)},alert)};f.prototype.destroy=function(a){!this.scene||a?this._parent&&this._parent.removeChild(this):this.scene._to_destroy.push(this)};f.prototype.updateBoundingBox=function(a){var b=this._global_matrix,c=gl.meshes[this.mesh],d=null;c&&(d=c.getBoundingBox(),
this.bounding_box||(this.bounding_box=BBox.create()),d=BBox.transformMat4(this.bounding_box,d,b));if(a||!this.children||0==this.children.length)return d;for(a=0;a<this.children.length;++a)if(b=this.children[a].updateBoundingBox())d||(d=this.bounding_box=BBox.create()),BBox.merge(d,d,b);return d};f.prototype.testRay=function(){var a=vec3.create(),b=vec3.create();vec3.create();vec3.create();vec3.create();mat4.create();mat4.create();return function(c,d,g,e,p){g=void 0===g?Number.MAX_VALUE:g;void 0!==
u._ray_tested_objects&&u._ray_tested_objects++;var f=null,m=null;this.layers&e&&this.mesh&&!this.flags.ignore_collisions&&(m=this.testRayWithMesh(c,a,g,e,p));m&&(m=vec3.distance(c.origin,a),m<g&&(g=m,d.set(a),f=this));if(!this.children&&!this.children.length)return f;for(var h=0;h<this.children.length;++h){var k=this.children[h].testRay(c,b,g,e,p);k&&(m=vec3.distance(c.origin,b),m<g&&(g=m,d.set(a),f=k))}return f}}();f.prototype.testRayWithMesh=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),
d=vec3.create(),g=mat4.create();return function(e,f,t,m,h){t=void 0===t?Number.MAX_VALUE:t;if(!this.mesh)return!1;var k=gl.meshes[this.mesh];if(!k)return!1;var l=k.getBoundingBox();if(!l)return!1;m=this._global_matrix;mat4.invert(g,m);vec3.transformMat4(b,e.origin,g);vec3.add(d,e.origin,e.direction);vec3.transformMat4(d,d,g);vec3.sub(c,d,b);vec3.normalize(c,c);if(!geo.testRayBBox(b,c,l,null,a))return!1;vec3.transformMat4(f,a,m);l=vec3.distance(e.origin,f);if(l>t)return!1;if(!h)return!0;k.octree||
(k.octree=new GL.Octree(k));h=k.octree.testRay(b,c,0,t,this.flags.two_sided);if(!h)return!1;f.set(h.hit);vec3.transformMat4(f,f,m);l=vec3.distance(e.origin,f);return l>t?!1:!0}}();f.prototype.setRangeFromSubmesh=function(a){if(void 0!==a&&this.mesh){var b=gl.meshes[this.mesh];if(b&&b.info&&b.info.groups){if(a.constructor===String){for(var c=0;c<b.info.groups.length;++c)if(b.info.groups[c].name==a){a=c;break}if(c===b.info.groups.length)return!1}if(a=b.info.groups[a])this.draw_range[0]=a.start,this.draw_range[1]=
a.length}else console.warn("you cannot set the submesh_id while the mesh is not yet loaded")}else this.draw_range=null};s.prototype._ctor=function(){f.prototype._ctor.call(this);this.mesh="plane";this.size=vec2.fromValues(1,1);this.blend_mode=e.BLEND_ALPHA;this.flags.two_sided=!0;this.flags.depth_test=!1;this.flags.flipX=!1;this.flags.flipY=!1;this.shader="texture_transform";this._angle=0;this.frame=null;this.frames={};this.texture_matrix=mat3.create();this._uniforms.u_texture_matrix=this.texture_matrix};
Object.defineProperty(s.prototype,"angle",{get:function(){return this._angle},set:function(a){this._angle=a;quat.setAxisAngle(this._rotation,e.FRONT,this._angle*DEG2RAD);this._must_update_matrix=!0},enumerable:!0});s.prototype.setSize=function(a,b){this.size[0]=a;this.size[1]=b};s.createFrames=function(a,b,c){c=c||{};var d=0,g=0;a=1/a;for(var e in b)if(c[b[e]]={pos:[d,g],size:[a,a],normalized:!0},d+=a,1<=d&&(d=0,g+=a),1<=g)break;return c};s.prototype.createFrames=function(a,b){s.createFrames(a,b,
this.frames)};s.prototype.addFrame=function(a,b,c,d,g,e){this.frames[a]={pos:vec2.fromValues(b,c),size:vec2.fromValues(d,g),normalized:!!e}};s.prototype.updateTextureMatrix=function(a){mat3.identity(this.texture_matrix);if(!this.texture)return!1;var b=a.textures[this.texture];if(!b&&a.autoload_assets){var c=this;-1!=this.texture.indexOf(".")&&a.loadTexture(this.texture,a.default_texture_settings,function(a){a&&c.setSize(a.width,a.height)});b=gl.textures.white}if(!b)return!1;a=this.texture_matrix;
var d=this.frames[this.frame];if(null!==this.frame&&!d)return!1;if(!d)return this.flags.flipX&&(l[0]=this.flags.flipX?1:0,l[1]=0,mat3.translate(a,a,l),l[0]=this.flags.flipX?-1:1,l[1]=1,mat3.scale(a,a,l)),!0;if(d.normalized)l[0]=this.flags.flipX?d.pos[0]+d.size[0]:d.pos[0],l[1]=1-d.pos[1]-d.size[1],mat3.translate(a,a,l),l[0]=d.size[0]*(this.flags.flipX?-1:1),l[1]=d.size[1];else{var g=b.height;l[0]=(this.flags.flipX?d.pos[0]+d.size[0]:d.pos[0])/b.width;l[1]=(g-d.pos[1]-d.size[1])/g;mat3.translate(a,
a,l);l[0]=d.size[0]*(this.flags.flipX?-1:1)/b.width;l[1]=d.size[1]/b.height}mat3.scale(a,a,l);return!0};s.prototype.render=function(a,b){this.texture&&this.updateTextureMatrix(a)&&(this.billboard_mode?e.Billboard.orientNode(this,b,a):(mat4.scale(this._global_matrix,this._global_matrix,[this.size[0],this.size[1],1]),a.setModelMatrix(this._global_matrix)),a.renderNode(this,a,b))};extendClass(s,f);e.Sprite=s;e.Scene=u;u.prototype.clear=function(){this._root=new e.SceneNode;this._root._scene=this;this.time=
0};u.prototype.getNodeById=function(a){return this._nodes_by_id[a]};u.prototype.update=function(a){this.time+=a;this._root.propagate("update",[a]);this.destroyPendingNodes()};u.prototype.destroyPendingNodes=function(a){if(this._to_destroy.length)for(a=null;a=this._to_destroy.pop();)a._parent&&a._parent.removeChild(a)};Object.defineProperty(u.prototype,"root",{get:function(){return this._root},set:function(a){throw"Cannot set root of scene";},enumerable:!1});u.prototype.testRay=function(a,b,c,d,g){u._ray_tested_objects=
0;b||(b=q);return this.root.testRay(a,b,c,void 0===d?255:d,g)};e.Renderer=k;k.prototype.setDataFolder=function(a){a?(this.assets_folder=a,"/"!=this.assets_folder.substr(-1)&&(this.assets_folder+="/")):this.assets_folder=""};k.prototype.clear=function(a){a?this.gl.clearColor(a[0],a[1],a[2],3<=a.length?a[3]:1):this.gl.clearColor(0,0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)};k._sort_by_dist_func=function(a,b){return b._distance-a._distance};k._sort_by_priority_func=function(a,b){return b.render_priority-
a.render_priority};k._sort_by_priority_and_dist_func=function(a,b){var c=b.render_priority-a.render_priority;return 0!=c?c:b._distance-a._distance};k.prototype.render=function(a,b,c,d){void 0===d&&(d=255);if(!a)throw"Renderer.render: scene not provided";if(this._current_scene)throw this._current_scene=null,"Cannot render an scene while rendering an scene";this._current_scene=a;b=b||a.camera;if(!b)throw"Renderer.render: camera not provided";B.gl=this.gl;this._state=[];this._meshes_missing=0;this.enableCamera(b);
this._nodes.length=0;c||a._root.getVisibleChildren(this._nodes,d);c=c||this._nodes;if(c.length){this._uniforms.u_time=a.time;this.sort_by_distance&&c.forEach(function(a){a._distance=a.getDistanceTo(b._position)});var g=this;c=c.filter(function(a){return!a.mustRender||!1!=a.mustRender(g,b)});this.sort_by_distance&&this.sort_by_priority?c.sort(e.Renderer._sort_by_priority_and_dist_func):this.sort_by_priority?c.sort(e.Renderer._sort_by_priority_func):this.sort_by_distance&&c.sort(e.Renderer._sort_by_dist_func);
a._root.preRender&&a._root.preRender(this,b);for(var f=0;f<c.length;++f){var p=c[f];p.updateGlobalMatrix(!0);p.preRender&&p.preRender(this,b)}for(f=0;f<c.length;++f)p=c[f],!1!==p.flags.visible&&p.layers&d&&(!this.mustRenderNode||!1!==this.mustRenderNode(p,b))&&(this.setModelMatrix(p._global_matrix),p.render?p.render(this,b):this.renderNode(p,b),this.draw_calls+=1);a._root.postRender&&a._root.postRender(this,b);for(f=0;f<c.length;++f)p=c[f],p.postRender&&p.postRender(this,b)}a.frame++;this.frame++;
this._current_scene=null};k.prototype.enableCamera=function(a){this._camera=a;a.updateMatrices();a.extractPlanes();this._view_matrix.set(a._view_matrix);this._projection_matrix.set(a._projection_matrix);this._viewprojection_matrix.set(a._viewprojection_matrix);this._uniforms.u_camera_position=a.position};k.prototype.saveState=function(){this.state.push({camera:this._camera,nodes:this._nodes})};k.prototype.restoreState=function(){var a=this.state.pop(),b=this.camera=a.camera;this._view_matrix.set(b._view_matrix);
this._projection_matrix.set(b._projection_matrix);this._viewprojection_matrix.set(b._viewprojection_matrix);this._uniforms.u_camera_position=b.position;this._nodes=a.nodes};k.prototype.setModelMatrix=function(a){this._model_matrix.set(a);mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,a)};k.prototype.setGlobalUniforms=function(a){for(var b in a)this._uniforms[b]&&this._uniforms[b].set?this._uniforms[b].set(a[b]):this._uniforms[b]=a[b]};k.prototype.renderNode=function(a,b){var c=null;a._mesh?
c=a._mesh:a.mesh&&(c=gl.meshes[a.mesh],c||(this._meshes_missing++,this.autoload_assets&&-1!=a.mesh.indexOf(".")&&this.loadMesh(a.mesh)));if(c){var d=null,g=a.shader;this.on_getShader&&(d=this.on_getShader(a,b));!d&&a.shader&&(d=gl.shaders[g]);this.shader_overwrite&&(d=gl.shaders[this.shader_overwrite]);d||(d=a.textures.color?this._texture_shader:this._flat_shader);var g=0,f=null,p;for(p in a.textures){var t=a.textures[p];if(t){var h="u_"+p+"_texture";if(!d||d.samplers[h])f=gl.textures[t],f||(this.autoload_assets&&
-1!=t.indexOf(".")&&this.loadTexture(t,this.default_texture_settings),f=gl.textures.white),a._uniforms[h]=f.bind(g++)}}if(!this.ignore_flags)if(gl.frontFace(a.flags.flip_normals?gl.CW:gl.CCW),gl[!1===a.flags.depth_test?"disable":"enable"](gl.DEPTH_TEST),!1===a.flags.depth_write&&gl.depthMask(!1),gl[!0===a.flags.two_sided?"disable":"enable"](gl.CULL_FACE),a.blend_mode!==e.BLEND_NONE)switch(gl.enable(gl.BLEND),a.blend_mode){case e.BLEND_ALPHA:gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);break;
case e.BLEND_ADD:gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;case e.BLEND_MULTIPLY:gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA)}else gl.disable(gl.BLEND);if(a.onRender)a.onRender(this,b,d);d.uniforms(this._uniforms);d.uniforms(a._uniforms);if(a.onShaderUniforms)a.onShaderUniforms(this,d);a.draw_range?d.drawRange(c,void 0===a.primitive?gl.TRIANGLES:a.primitive,a.draw_range[0],a.draw_range[1],a.indices):d.draw(c,void 0===a.primitive?gl.TRIANGLES:a.primitive,a.indices);this.ignore_flags||(a.flags.flip_normals&&
gl.frontFace(gl.CCW),!1===a.flags.depth_test&&gl.enable(gl.DEPTH_TEST),a.blend_mode!==e.BLEND_NONE&&gl.disable(gl.BLEND),a.flags.two_sided&&gl.disable(gl.CULL_FACE),!1===a.flags.depth_write&&gl.depthMask(!0))}else if(a.onRender)a.onRender(this,b,d)};k.prototype.setPointSize=function(a){this.point_size=a;gl.shaders.point.uniforms({u_pointSize:this.point_size})};k.prototype.loadMesh=function(a,b){if(!a)return console.error("loadMesh: Cannot load null name");if(!this.assets_loading[a]&&!this.assets_not_found[a]){var c=
this.meshes[a];if(c)return b&&b(c),c;var d=this,c=a;-1==c.indexOf("://")&&(c=this.assets_folder+a);c=GL.Mesh.fromURL(c,function(c){c?d.meshes[a]=c:(d.assets_not_found[a]=!0,delete d.meshes[a]);d.num_assets_loading--;delete d.assets_loading[a];b&&b(c,a)});this.assets_loading[a]=c;this.num_assets_loading++;return this.meshes[a]=c}};k.prototype.loadTexture=function(a,b,c){if(!a)return console.error("loadTexture: Cannot load null name");if(!this.assets_loading[a]&&!this.assets_not_found[a]){var d=a;b&&
(b.name&&(d=b.name),b.preview&&(d=b.preview));var g=this.textures[d];if(g&&!g.is_preview)return c&&c(g),g;var e=this,g=a;-1==g.indexOf("://")&&(g=this.assets_folder+a);g=GL.Texture.fromURL(g,b,function(b){b?e.textures[d]=b:e.assets_not_found[a]=!0;c&&c(b,d);e.num_assets_loading--;delete e.assets_loading[a];if(e.on_texture_load)e.on_texture_load(b,d)});b&&b.preview&&(g.is_preview=!0);this.assets_loading[a]=g;this.num_assets_loading++;return this.textures[d]=g}};k.prototype.loadTextureAtlas=function(a,
b,c){"string"==typeof a&&(a=JSON.parse(a));var d=this;-1==b.indexOf("://")&&(b=this.assets_folder+b);GL.Texture.fromURL(b,null,function(b){var e=a.files;d.textures[":atlas"]=b;for(var f in e)if(!d.textures[f]||d.textures[f].is_preview){var h=e[f],m=new GL.Texture(a.size,a.size,{wrap:gl.REPEAT,filter:gl.LINEAR});m.drawTo(function(){b.gl.drawTexture(b,0,0,a.size,a.size,h.x,h.y,h.width||a.size,h.height||a.size)});m.is_preview=!0;d.textures[f]=m}c&&c(e)})};k.prototype.loadShaders=function(a,b,c){var d=
this;-1==a.indexOf("://")&&(a=this.assets_folder+a);this.loading_shaders=!0;GL.loadFileAtlas(a,function(a){d.compileShadersFromAtlas(a,c);d.loading_shaders=!1;b&&b(a)})};k.prototype.compileShadersFromAtlas=function(a,b){var c=a.shaders;if(c){for(var d in a)a[d]=GL.Shader.expandImports(a[d],a);c=c.split("\n");for(d in c){var g=c[d].trim().split(" "),e=g[0].trim();if("//"!=e.substr(0,2)){var f=a[g[1]],h=a[g[2]],m=null,k={};if(3<g.length)for(var l=3;l<g.length;++l)if("#"==g[l][0])k[g[l].substr(1)]=!0;
else{m=g.slice(l).join(" ");break}if(!k.WEBGL1||1==gl.webgl_version)if(!k.WEBGL2||2==gl.webgl_version){g[1]&&"@"==g[1][0]&&(k=g[1].substr(1)+"_VERTEX_SHADER",GL.Shader[k]&&(f=GL.Shader[k]));g[2]&&"@"==g[2][0]&&(k=g[2].substr(1)+"_FRAGMENT_SHADER",GL.Shader[k]&&(h=GL.Shader[k]));if(m)try{m=JSON.parse(m)}catch(n){console.error("Error in shader macros: ",e,m,n)}if(m&&b){k={};for(d in m)k[d]=m[d];for(d in b)k[d]=b[d];m=k}else b&&(m=b);try{f&&h?this.shaders[e]?this.shaders[e].updateShader(f,h,m):this.shaders[e]=
new GL.Shader(f,h,m):console.warn("Shader subfile not found: ",g[1],g[2])}catch(q){GL.Shader.dumpErrorToConsole(q,f,h)}}}}}else console.warn("No 'shaders' found in shaders file atlas, check documentation")};k.prototype.setShadersFromFile=function(a){a=GL.processFileAtlas(a);this.compileShadersFromAtlas(a)};e.sortByDistance=function(a,b){a.forEach(function(a){a._distance=a.getDistanceTo(b)});a.sort(function(a,b){return b._distance-a._distance})};e.noBlending=function(a){return a.blend_mode===e.BLEND_NONE};
e.generateTextureAtlas=function(a,b,c,d,g){b=b||1024;c=c||1024;d=d||64;var e=0,f;for(f in a)e++;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);var e=new GL.Texture(b,c),h={width:b,height:c,size:d,files:{}},k=0,l=0,n={};e.drawTo(function(){for(var e in a)if(":"!=e[0]&&"white"!=e&&"black"!=e&&"notfound"!=e){var f=a[e];if(!f.is_preview&&f.texture_type==gl.TEXTURE_2D){if(g){var p=f.toBase64().hashCode();if(n[p]){h.files[e]=h.files[n[p]];continue}n[p]=e}h.files[e]={x:k,y:l};f.renderQuad(k,
l,d,d);k+=d;if(k==b&&(k=0,l+=d,l==c)){console.warn("Atlas too small, some textures wont be stored.");break}}}});e.info=h;console.log(h);return e};k.prototype.computeResourcesLoaded=function(a){var b=0,c;for(c in a){var d=a[c],g=this.textures[d];g&&!1===g.ready||(d=this.meshes[d])&&!1===d.ready||(g||d)&&b++}return b};Object.defineProperty(k.prototype,"meshes",{get:function(){return this.gl.meshes},set:function(a){},enumerable:!0});Object.defineProperty(k.prototype,"textures",{get:function(){return this.gl.textures},
set:function(a){},enumerable:!0});Object.defineProperty(k.prototype,"shaders",{get:function(){return this.gl.shaders},set:function(a){},enumerable:!0});k.prototype.addMesh=function(a,b){b.gl!=this.gl&&(b=b.cloneShared(this.gl));this.gl.meshes[a]=b};e.Renderer=k;e.Ray=function(a,b){this.origin=vec3.create();this.direction=vec3.create();a&&this.origin.set(a);b&&this.direction.set(b)};e.Camera=h;h.PERSPECTIVE=1;h.ORTHOGRAPHIC=2;Object.defineProperty(h.prototype,"position",{get:function(){return this._position},
set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"target",{get:function(){return this._target},set:function(a){this._target.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(h.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._must_update_matrix=!0},enumerable:!1});h.prototype.perspective=function(a,b,c,d){this.type=h.PERSPECTIVE;this.fov=a;this.aspect=b;this.near=c;this.far=
d;this._must_update_matrix=!0};h.prototype.orthographic=function(a,b,c,d){this.aspect=d||1;this.type=h.ORTHOGRAPHIC;this.frustum_size=a;this.near=b;this.far=c;this._must_update_matrix=!0};h.prototype.lookAt=function(a,b,c){vec3.copy(this._position,a);vec3.copy(this._target,b);vec3.copy(this._up,c);this._must_update_matrix=!0};h.prototype.updateMatrices=function(a){if(this._autoupdate_matrices||a)this.type==h.ORTHOGRAPHIC?mat4.ortho(this._projection_matrix,-this.frustum_size*this.aspect,this.frustum_size*
this.aspect,-this.frustum_size,this.frustum_size,this.near,this.far):mat4.perspective(this._projection_matrix,this.fov*DEG2RAD,this.aspect,this.near,this.far),this.flip_y&&mat4.scale(this._projection_matrix,this._projection_matrix,[1,-1,1]),mat4.lookAt(this._view_matrix,this._position,this._target,this._up);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,
e.RIGHT);mat4.rotateVec3(this._top,this._model_matrix,e.UP);mat4.rotateVec3(this._front,this._model_matrix,e.FRONT);this.distance=vec3.distance(this._position,this._target)};h.prototype.getModel=function(a){a=a||mat4.create();mat4.invert(this._model_matrix,this._view_matrix);mat4.copy(a,this._model_matrix);return a};h.prototype.updateVectors=function(a){var b=vec3.subtract(q,this._target,this._position),b=vec3.length(b);mat4.multiplyVec3(this._position,a,e.ZERO);mat4.multiplyVec3(this._target,a,[0,
0,-b]);mat4.rotateVec3(this._up,a,e.UP)};h.prototype.getLocalVector=function(a,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,a)};h.prototype.getLocalPoint=function(a,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),a,this._model_matrix)};h.prototype.getFront=function(a){a=a||vec3.create();vec3.subtract(a,this._target,this._position);vec3.normalize(a,a);return a};h.prototype.move=function(a){vec3.add(this._target,
this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};h.prototype.moveLocal=function(a){a=mat4.rotateVec3(q,this._model_matrix,a);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};h.prototype.rotate=function(a,b){var c=quat.setAxisAngle(x,b,a),d=vec3.subtract(q,this._target,this._position);vec3.transformQuat(d,d,c);vec3.add(this._target,this._position,d);this._must_update_matrix=!0};h.prototype.rotateLocal=
function(a,b){var c=mat4.rotateVec3(F,this._model_matrix,b),c=quat.setAxisAngle(x,c,a),d=vec3.subtract(q,this._target,this._position);vec3.transformQuat(d,d,c);vec3.add(this._target,this._position,d);this._must_update_matrix=!0};h.prototype.orbit=function(a,b,c,d){if(!b)throw"RD: orbit axis missing";c=c||this._target;d&&(b=mat4.rotateVec3(F,this._model_matrix,b));a=quat.setAxisAngle(x,b,a);b=vec3.subtract(q,this._position,this._target);vec3.transformQuat(b,b,a);vec3.add(this._position,c,b);this._must_update_matrix=
!0};h.prototype.orbitDistanceFactor=function(a,b){b=b||this._target;var c=vec3.subtract(q,this._position,b);vec3.scale(c,c,a);vec3.add(this._position,b,c);this._must_update_matrix=!0};h.prototype.project=function(a,b,c){c=c||vec3.create();b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();mat4.projectVec3(c,this._viewprojection_matrix,a);c[0]=c[0]*b[2]+b[0];c[1]=c[1]*b[3]+b[1];return c};h.prototype.unproject=function(a,b,c){b=b||gl.viewport_data;this._must_update_matrix&&this.updateMatrices();
return vec3.unproject(c||vec3.create(),a,this._viewprojection_matrix,b)};h.prototype.getRay=function(a,b,c,d){if(void 0===a||void 0===b)throw"RD.Camera.getRay requires x and y parameters";c=c||gl.viewport_data;d||(d=new e.Ray);this._must_update_matrix&&this.updateMatrices();var g=d.origin;vec3.set(g,a,b,0);this.type==e.Camera.ORTHOGRAPHIC?vec3.unproject(g,g,this._viewprojection_matrix,c):vec3.copy(g,this.position);var f=d.direction;vec3.set(f,a,b,1);vec3.unproject(f,f,this._viewprojection_matrix,
c);vec3.sub(f,f,g);vec3.normalize(f,f);return d};h.prototype.getRayPlaneCollision=function(a,b,c,d,g,e){g=g||vec3.create();a=this.getRay(a,b,e);return geo.testRayPlane(a.origin,a.direction,c,d,g)?g:null};h.controller_keys={forward:"UP",back:"DOWN",left:"LEFT",right:"RIGHT"};h.prototype.applyController=function(a,b,c){c=c||10;a&&(gl.keys[h.controller_keys.forward]?this.moveLocal(vec3.scale(q,e.FRONT,a*c)):gl.keys[h.controller_keys.back]&&this.moveLocal(vec3.scale(q,e.BACK,a*c)),gl.keys[h.controller_keys.left]?
this.moveLocal(vec3.scale(q,e.LEFT,a*c)):gl.keys[h.controller_keys.right]&&this.moveLocal(vec3.scale(q,e.RIGHT,a*c)));b&&(b.deltax&&this.rotate(-0.005*b.deltax,e.UP),b.deltay&&this.rotateLocal(-0.005*b.deltay,e.RIGHT))};h.prototype.lerp=function(a,b){vec3.lerp(this._position,a._position,b);vec3.lerp(this._target,a._target,b);vec3.lerp(this._up,a._up,b);this._fov=this._fov*(1-b)+a._fov*b;this._must_update_matrix=!0};h.prototype.extractPlanes=function(){function a(a){var b=c.subarray(a,a+3),b=vec3.length(b);
0!==!b&&(b=1/b,c[a]*=b,c[a+1]*=b,c[a+2]*=b,c[a+3]*=b)}var b=this._viewprojection_matrix,c=this._planes_data||new Float32Array(24);c.set([b[3]-b[0],b[7]-b[4],b[11]-b[8],b[15]-b[12]],0);a(0);c.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);a(4);c.set([b[3]+b[1],b[7]+b[5],b[11]+b[9],b[15]+b[13]],8);a(8);c.set([b[3]-b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);a(12);c.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);a(16);c.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],b[15]+b[14]],20);a(20);this._planes_data=
c;this._frustrum_planes||(this._frustrum_planes=[c.subarray(0,4),c.subarray(4,8),c.subarray(8,12),c.subarray(12,16),c.subarray(16,20),c.subarray(20,24)])};var E=e.CLIP_INSIDE=0,n=e.CLIP_OUTSIDE=1,D=e.CLIP_OVERLAP=2;h.prototype.testBox=function(a,b){this._frustrum_planes||this.extractPlanes();var c=this._frustrum_planes,d=0,e=0,d=z(c[0],a,b);if(d==n)return n;e+=d;d=z(c[1],a,b);if(d==n)return n;e+=d;d=z(c[2],a,b);if(d==n)return n;e+=d;d=z(c[3],a,b);if(d==n)return n;e+=d;d=z(c[4],a,b);if(d==n)return n;
e+=d;d=z(c[5],a,b);return d==n?n:0==e+d?E:D};h.prototype.testSphere=function(a,b){this._frustrum_planes||this.extractPlanes();var c=this._frustrum_planes,d,e=!1;d=y(c[0],a);if(d<-b)return n;d>=-b&&d<=b&&(e=!0);d=y(c[1],a);if(d<-b)return n;d>=-b&&d<=b&&(e=!0);d=y(c[2],a);if(d<-b)return n;d>=-b&&d<=b&&(e=!0);d=y(c[3],a);if(d<-b)return n;d>=-b&&d<=b&&(e=!0);d=y(c[4],a);if(d<-b)return n;d>=-b&&d<=b&&(e=!0);d=y(c[5],a);if(d<-b)return n;d>=-b&&d<=b&&(e=!0);return e?D:E};e.Factory=function(a,b,c){a=e.Factory.templates[a];
var d=new e.SceneNode;a&&d.configure(a);b&&(b.constructor===e.Scene?b.root:b).addChild(d);c&&d.configure(c);return d};e.Factory.templates={grid:{mesh:"grid",primitive:GL.LINES,color:[0.5,0.5,0.5,0.5],blend_mode:e.BLEND_ALPHA},mesh:{shader:"phong"},sphere:{mesh:"sphere",shader:"phong"},floor:{mesh:"planeXZ",scaling:10,shader:"phong"}};e.parseTextConfig=function(a){function b(a,e){for(var f=c.shift();f;)if(0==f.trim().length)f=c.shift();else{for(var h=0;"\t"==f[h]&&h<f.length;)h++;if(h<e)break;var k=
{children:[]};try{var l=f.trim();-1!=l.indexOf(":")&&(l="{"+l+"}");var n=new Function("return "+l);k.data=n()}catch(q){console.error(q)}h>=e&&(a&&a.children.push(k),f=b(k,h+1))}return f}var c=a.split("\n");a={data:"",children:[]};b(a,0);return a};k.prototype.createShaders=function(){this._flat_shader=new GL.Shader("\t\t\t\tprecision highp float;\t\t\t\tattribute vec3 a_vertex;\t\t\t\tuniform mat4 u_mvp;\t\t\t\tvoid main() {\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\t\tgl_PointSize = 2.0;\t\t\t\t}\t\t\t\t",
"\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t\t\t");gl.shaders.flat=this._flat_shader;this._point_shader=new GL.Shader("\t\t\t\tprecision highp float;\t\t\t\tattribute vec3 a_vertex;\t\t\t\tuniform mat4 u_mvp;\t\t\t\tuniform float u_pointSize;\t\t\t\tvoid main() {\t\t\t\t\tgl_PointSize = u_pointSize;\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\t}\t\t\t\t","\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\t\t\t\t     discard;\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t\t\t");
gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec4 a_color;\t\tvarying vec4 v_color;\t\tuniform vec4 u_color;\t\tuniform mat4 u_mvp;\t\tuniform mat4 u_modelt;\t\tvoid main() {\t\t\tv_color = a_color * u_color;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t","\t\tprecision highp float;\t\tvarying vec4 v_color;\t\tvoid main() {\t\t  gl_FragColor = v_color;\t\t}\t");gl.shaders.color=
this._color_shader;this._texture_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec2 a_coord;\t\tvarying vec2 v_coord;\t\tuniform mat4 u_mvp;\t\tuniform mat4 u_modelt;\t\tvoid main() {\t\t\tv_coord = a_coord;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t","\t\tprecision highp float;\t\tvarying vec2 v_coord;\t\tuniform vec4 u_color;\t\tuniform sampler2D u_color_texture;\t\tvoid main() {\t\t\tgl_FragColor = u_color * texture2D(u_color_texture, v_coord);\t\t}\t");
gl.shaders.texture=this._texture_shader;this._texture_transform_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec2 a_coord;\t\tvarying vec2 v_coord;\t\tuniform mat4 u_mvp;\t\tuniform mat3 u_texture_matrix;\t\tvoid main() {\t\t\tv_coord = (u_texture_matrix * vec3(a_coord,1.0)).xy;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t","\t\tprecision highp float;\t\tvarying vec2 v_coord;\t\tuniform vec4 u_color;\t\tuniform float u_global_alpha_clip;\t\tuniform sampler2D u_color_texture;\t\tvoid main() {\t\t\tvec4 color = u_color * texture2D(u_color_texture, v_coord);\t\t\tif(color.w < u_global_alpha_clip)\t\t\t\tdiscard;\t\t\tgl_FragColor = color;\t\t}\t");
gl.shaders.texture_transform=this._texture_transform_shader;var a={u_ambient:vec3.create(),u_light_vector:vec3.fromValues(0.577,0.577,0.577),u_light_color:e.WHITE};this._phong_shader=new GL.Shader("\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_normal;\t\t\tvarying vec3 v_normal;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tvoid main() {\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",
"\t\t\tprecision highp float;\t\t\tvarying vec3 v_normal;\t\t\tuniform vec3 u_ambient;\t\t\tuniform vec3 u_light_color;\t\t\tuniform vec3 u_light_vector;\t\t\tuniform vec4 u_color;\t\t\tvoid main() {\t\t\t  vec3 N = normalize(v_normal);\t\t\t  gl_FragColor = u_color * (vec4(u_ambient,1.0) + max(0.0, dot(u_light_vector,N)) * vec4(u_light_color,1.0));\t\t\t}\t\t");gl.shaders.phong=this._phong_shader;this._phong_shader._uniforms=a;gl.shaders.phong.uniforms(a);this._textured_phong_shader=new GL.Shader("\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_normal;\t\t\tattribute vec2 a_coord;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_normal;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision highp float;\t\t\tvarying vec3 v_normal;\t\t\tvarying vec2 v_coord;\t\t\tuniform vec3 u_lightcolor;\t\t\tuniform vec3 u_lightvector;\t\t\tuniform vec4 u_color;\t\t\tuniform sampler2D u_color_texture;\t\t\tvoid main() {\t\t\t  vec3 N = normalize(v_normal);\t\t\t  gl_FragColor = u_color * texture2D(u_color_texture, v_coord) * max(0.0, dot(u_lightvector,N)) * vec4(u_lightcolor,1.0);\t\t\t}\t\t");gl.shaders.textured_phong=this._textured_phong_shader;gl.shaders.textured_phong.uniforms(a)};
extendClass(r,f);e.Billboard=r;r.SPHERIC=1;r.PARALLEL_SPHERIC=2;r.CYLINDRIC=3;r.PARALLEL_CYLINDRIC=4;r.prototype._ctor=function(){this.billboard_mode=r.SPHERIC;this.auto_orient=!0;f.prototype._ctor.call(this)};r.orientNode=function(a,b,c){if(a.billboard_mode==r.CYLINDRIC||a.billboard_mode==r.PARALLEL_CYLINDRIC){var d=null;a.billboard_mode==r.CYLINDRIC?(d=a.getGlobalPosition(F),vec3.sub(q,b._position,d),l[0]=q[0],l[1]=q[2]):(l[0]=b._front[0],l[1]=b._front[2]);b=vec2.computeSignedAngle(l,e.FRONT2D);
isNaN(b)||(mat4.rotateY(C,H,-b),a._global_matrix.set(C),mat4.setTranslation(a._global_matrix,a._position),mat4.scale(a._global_matrix,a._global_matrix,a._scale))}else a.billboard_mode==r.PARALLEL_SPHERIC?(a._global_matrix.set(b._model_matrix),mat4.setTranslation(a._global_matrix,a._position)):(mat4.lookAt(a._global_matrix,a._position,b.position,e.UP),mat4.invert(a._global_matrix,a._global_matrix)),mat4.scale(a._global_matrix,a._global_matrix,a._scale);c.setModelMatrix(a._global_matrix)};r.prototype.render=
function(a,b){!1!==this.flags.visible&&(this.auto_orient&&r.orientNode(this,b,a),a.renderNode(this,a,b))};extendClass(w,f);e.PointCloud=w;w.prototype.render=function(a,b){if(0!=this.points.length){this.updateVertices();var c=this._meshes[a.gl.context_id];c||(c=new GL.Mesh(void 0,void 0,a.gl),this._vertices_buffer=c.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=c.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=c;this._vertices_buffer.uploadRange(0,
12*this.points.length);this._extra_buffer.uploadRange(0,12*this.points.length);c=gl.shaders[this.shader];c||(c=gl.shaders.pointcloud)||(gl.shaders.pointcloud=new GL.Shader(w._vertex_shader,w._pixel_shader));this.draw_range[1]=this.points.length;c=gl.getViewport();this._uniforms.u_pointSize=this.points_size/(gl.canvas.width/c[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this.ignore_transform&&
(mat4.identity(a._model_matrix),a._mvp_matrix.set(a._viewprojection_matrix));a.renderNode(this,a,b)}};w.prototype.updateVertices=function(a){if(a=this.points.length)for(var b=this._vertices,c=this._extra,d=0,e=this.num_textures*this.num_textures,f=0;f<a;f++){var h=this.points[f];b.set(h.pos,d);c[d]=1;c[d+1]=1;1<e&&(c[d+2]=h.tex);d+=3}};w._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = abs(floor(v_coord.x) * u_texture_info.x);\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
w._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec2 uv = vec2(v_coord.x + gl_PointCoord.x * u_texture_info.x, v_coord.y + (1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  vec4 color = texture2D( u_color_texture, uv );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(v,f);e.ParticlesEmissor=v;v.prototype.update=function(a){var b=this.particles.length,c=this.particles_damping,d=this.particles_acceleration,e=vec3.length(d);if(b){for(var f=[],h=0;h<b;h++){var k=this.particles[h];vec3.scaleAndAdd(k.pos,k.pos,k.vel,a);e&&vec3.scaleAndAdd(k.vel,k.vel,d,a);c&&vec3.scaleAndAdd(k.vel,k.vel,k.vel,-a*c);k.ttl-=a;0<k.ttl&&f.push(k)}this.particles=f}b=this.getGlobalPosition();c=this.emissor_direction;d=this.particles_life;e=this.num_textures*this.num_textures;
f=this.velocity_variation;if(0<this.particles_per_second)for(a=this.particles_per_second*(a+this._accumulated_time),this._accumulated_time=(a-Math.floor(a))/this.particles_per_second,a=Math.floor(a),h=0;h<a&&!(this.particles.length>=this.max_particles);h++)c=vec3.clone(c),c[0]+=0.5*Math.random()*f,c[2]+=0.5*Math.random()*f,this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*e)/e,pos:vec3.clone(b),vel:c,ttl:d})};v.prototype.render=function(a,b){if(0!=this.particles.length){this.updateVertices();
var c=this._meshes[a.gl.context_id];c||(c=new GL.Mesh(void 0,void 0,a.gl),this._vertices_buffer=c.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=c.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=c;this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);c=gl.shaders[this.shader];c||(c=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(v._vertex_shader,v._pixel_shader));
this.draw_range[1]=this.particles.length;c=gl.getViewport();this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/c[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(a._model_matrix);a._mvp_matrix.set(a._viewprojection_matrix);a.renderNode(this,a,
b)}};v.prototype.updateVertices=function(a){if(a=this.particles.length)for(var b=this._vertices,c=this._extra,d=0,e=this.particles_life,f=this.num_textures*this.num_textures,h=0;h<a;h++){var k=this.particles[h];b.set(k.pos,d);c[d]=1;c[d+1]=k.ttl/e;1<f&&(c[d+2]=k.tex);d+=3}};v._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tuniform vec2 u_scaleStartEnd;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = floor(v_coord.x) * u_texture_info.x;\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = mix(u_scaleStartEnd.y, u_scaleStartEnd.x, a_extra3.y) * 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
v._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec4 color = texture2D( u_color_texture, v_coord + vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t"})("undefined"!=
typeof window?window:"undefined"!=typeof self?self:global);
